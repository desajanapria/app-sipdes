<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<title> SIPDes(Sistem Informasi Perencanaan Desa) </title>
<style>
    /* CSS Styling dari SIPDes_Revisi.html (Dasar) */
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        margin: 0; 
        background-color: #f0ffef; 
    }
    .sidebar { height: 100vh; width: 250px; position: fixed; top: 0; left: 0; background-color: #004d40; padding-top: 20px; color: white; box-shadow: 2px 0 5px rgba(0,0,0,0.2); overflow-y: auto;}
    .sidebar a { padding: 15px 25px; text-decoration: none; font-size: 16px; color: #b2dfdb; display: block; transition: 0.3s; border-left: 5px solid transparent; }
    .sidebar a:hover, .sidebar a.active { color: white; background-color: #00796b; border-left: 5:px solid #00acc1; }
    .sidebar h2 { padding: 10px 25px; text-align: center; color: #e0f2f1; border-bottom: 1px solid #00695c; margin-bottom: 20px; }
    .desa-logo-sidebar {
        width: 80px;
        height: auto;
        max-height: 80px;
        display: block;
        margin: 10px auto 20px auto;
        border-radius: 50%;
        border: 1px solid #00695c;
        padding: 5px;
        background-color: white; /* Default background */
        object-fit: contain;
    }
    .main-content { margin-left: 250px; padding: 30px; }
    .module-content { display: none; }
    .module-content.active { display: block; }
    .module-header { color: #004d40; border-bottom: 2px solid #004d40; padding-bottom: 10px; margin-bottom: 20px; }

    /* Gaya Baru untuk Filter Tahun */
    .filter-bar {
        background-color: #e0f2f1;
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .filter-bar label {
        font-weight: bold;
        color: #004d40;
        white-space: nowrap;
    }
    .filter-bar button {
        background-color: #00796b;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .filter-bar button:hover {
        background-color: #004d40;
    }
    .filter-bar input[type="number"] {
        width: 80px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-align: center;
        
        /* Re-enable text selection for input fields */
        -webkit-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
    }

    .form-container, .stats-grid {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .form-container label {
        display: block;
        margin-top: 10px;
        font-weight: 600;
        color: #004d40;
    }
    .form-container input[type="text"],
    .form-container input[type="number"],
    .form-container select,
    .form-container input[type="password"] {
        width: calc(100% - 22px);
        padding: 10px;
        margin: 8:px 0;
        display: inline-block;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        
        /* Re-enable text selection for input fields */
        -webkit-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
    }
    /* FIX: Menambahkan style untuk input[type="checkbox"] */
    .form-container input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
        display: inline-block;
        
        /* Re-enable text selection (though not critical for checkbox) */
        -webkit-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
    }
    .form-container textarea {
        width: calc(100% - 22px);
        padding: 10px;
        margin: 8:px 0;
        display: inline-block;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        resize: vertical;
        
        /* Re-enable text selection for textareas */
        -webkit-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
    }
    .form-container button {
        background-color: #00796b;
        color: white;
        padding: 10px 15px;
        margin: 8px 5:px 8px 0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
        
        /* Disable selection for buttons/links */
        -webkit-user-select: none; 
        -ms-user-select: none;     
        user-select: none;         
    }
    .form-container button:hover {
        background-color: #004d40;
    }
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 0.9em;
    }
    .data-table th, .data-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
        vertical-align: top;
    }
    .data-table th {
        background-color: #e0f2f1;
        color: #004d40;
    }
    .data-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    .data-table tr:hover {
        background-color: #e0f2f1;
    }
    .action-btn {
        padding: 5px 10px;
        margin: 2px;
        cursor: pointer;
        border: none;
        border-radius: 3px;
        color: white;
        font-size: 12px;
        display: inline-block;
        
        /* Disable selection for buttons/links */
        -webkit-user-select: none; 
        -ms-user-select: none;     
        user-select: none;         
    }
    .edit-btn { background-color: #2196F3; }
    .delete-btn { background-color: #f44336; }
    .cancel-btn { background-color: #6c757d; }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        grid-auto-rows: minmax(90px, auto);
        align-items: stretch;
    }
    @media (min-width: 1100px) {
        .stats-grid { grid-template-columns: repeat(5, 1fr); }
    }
    @media (max-width: 1099px) and (min-width: 700px) {
        .stats-grid { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 699px) {
        .stats-grid { grid-template-columns: repeat(2, 1fr); }
        .stat-card p { font-size: 1.5em; }
    }
    .stat-card {
        background-color: #e0f7fa;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        cursor: pointer; /* Menandakan bisa diklik */
        transition: transform 0.2s;
        
        /* Disable selection for card content */
        -webkit-user-select: none; 
        -ms-user-select: none;     
        user-select: none;         
    }
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .stat-card h3 { color: #004d40; margin-top: 0; font-size: 1em; }
    .stat-card p { font-size: 2em; font-weight: bold; color: #00796b; margin-bottom: 0; }
    
    /* Login & Security Styles */
    .login-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #f0ffef;
        display: none; 
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .login-box {
        background-color: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        width: 350px;
        text-align: center;
        border-top: 5px solid #004d40;
        
        /* Disable selection for login box text */
        -webkit-user-select: none; 
        -ms-user-select: none;     
        user-select: none;         
    }
    .login-box h2 {
        margin-bottom: 25px;
        color: #004d40;
    }
    .login-box input[type="text"],
    .login-box input[type="password"] {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        
        /* Re-enable text selection for input fields */
        -webkit-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
    }
    .login-box button {
        width: 100%;
        padding: 12px;
        background-color: #00796b;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
    }
    .login-box button:hover {
        background-color: #004d40;
    }
    #login_message {
        color: red;
        margin-top: 10px;
        
        /* Disable selection for error message */
        -webkit-user-select: none; 
        -ms-user-select: none;     
        user-select: none;         
    }
    .login-footer {
        margin-top: 20px;
        font-size: 0.75em;
        color: #666;
        border-top: 1px solid #eee;
        padding-top: 10px;
        
        /* Disable selection for footer text */
        -webkit-user-select: none; 
        -ms-user-select: none;     
        user-select: none;         
    }
    .app-hidden {
        display: none !important;
    }
    /* Footer modern & responsif */
.app-footer {
    position: fixed;
    bottom: 0;
    left: 250px;
    width: calc(100% - 250px);
    background-color: #004d40;
    color: #c8e6c9;
    text-align: center;
    font-size: 0.7em;
    border-top: 0.5px solid #00695c; /* border tipis */
    padding: 2px 5px; /* tinggi footer sangat kecil agar tidak menutupi konten */
    box-sizing: border-box;
    box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.05);
    z-index: 3;
    
    /* Disable selection for footer text */
    -webkit-user-select: none; 
    -ms-user-select: none;     
    user-select: none;         
}

/* Tambahan agar isi halaman tidak tertutup footer */
.main-content {
    margin-left: 250px;
    padding: 30px;
    padding-bottom: 60px; /* ruang bawah agar tidak tertimpa footer */
}

/* Responsif untuk tablet & HP */
@media (max-width: 900px) {
    .app-footer {
        left: 0;
        width: 100%;
        font-size: 0.65em;
        padding: 3px 4px;
    }
}

/* Modal Styles (DITAMBAH: Untuk mengatasi tampilan form modal yang berantakan) */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black background */
    display: none; /* Controlled by JS */
    justify-content: center;
    align-items: center;
    z-index: 1001; /* Above login-overlay */
}

.modal-content {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 5:px 15px rgba(0, 0, 0, 0.3);
    width: 70%;
    max-width: 500px; /* Max width for modal form */
    max-height: 90vh;
    overflow-y: auto;
    text-align: center;
    
    /* Disable selection for modal content text */
    -webkit-user-select: none; 
    -ms-user-select: none;     
    user-select: none;         
}

.modal-content h3 {
    color: #004d40;
    border-bottom: 2px solid #e0f2f1;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.modal-content label {
    display: block;
    text-align: left;
    margin-top: 10px;
    font-weight: 600;
    color: #004d40;
    font-size: 14px;
}

.modal-content input[type="text"],
.modal-content input[type="number"],
.modal-content select,
.modal-content input[type="password"] {
    width: calc(100% - 22px);
    padding: 10px;
    margin: 5px 0 10px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
    
    /* Re-enable text selection for input fields */
    -webkit-user-select: text !important;
    -ms-user-select: text !important;
    user-select: text !important;
}

/* START: FIX - Modal Number Alignment for Level 5/6 RAB (Saran Perbaikan) */
.modal-content #detailVolume,
.modal-content #detailHargaSatuan,
.modal-content #selectObyekObyekAkun,
.modal-content #selectObyekJenisAkun {
    text-align: left !important; /* Ensure left alignment for numeric/currency inputs */
}
/* END: FIX */

.modal-content textarea { /* Tambah style untuk textarea di modal */
    width: calc(100% - 22px);
    padding: 10px;
    margin: 5px 0 10px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
    resize: vertical;
    
    /* Re-enable text selection for textareas */
    -webkit-user-select: text !important;
    -ms-user-select: text !important;
    user-select: text !important;
}

.modal-actions {
    margin-top: 20px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.modal-actions button {
    background-color: #00796b;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
    
    /* Disable selection for buttons/links */
    -webkit-user-select: none; 
    -ms-user-select: none;     
    user-select: none;         
}

.modal-actions button:hover {
    background-color: #004d40;
}
/* End Modal Styles */


    /* Print Styles */
    @media print {
        .sidebar, .form-container, .action-btn, .export-btn, h2.module-header, #LaporanEksporData p,
        .filter-bar, .app-footer, .no-print, .modal-overlay, .rab-toolbar, .pagination-controls { /* Ditambahkan .pagination-controls */
            display: none !important;
        }

        body {
            background-color: white;
            font-family: 'Times New Roman', Times, serif;
            font-size: 10pt; /* Dirapikan */
            margin: 0;
            color: #000;
            padding: 0;
            margin: 0; /* Reset body margins for @page to work */
            
            /* Re-enable selection in print mode */
            -webkit-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }

        .main-content {
            margin-left: 0 !important;
            padding: 0 !important;
        }

        .module-content.active {
            display: block !important;
        }

        .data-table, .data-table th, .data-table td {
            border: 1px solid black !important;
        }
        
        /* Dirapikan agar hemat kertas */
        .data-table th, .data-table td {
            padding: 4px 6px !important; 
            font-size: 9pt !important; 
            vertical-align: top;
        }

        .data-table th {
            background-color: #ccc !important;
            color: black !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        @page {
            margin: 1.5cm 1cm 1.5cm 1cm; /* Dirapikan */
            counter-increment: page;
            @bottom-right {
                content: "Halaman " counter(page) " dari " counter(pages);
                font-size: 8pt;
                font-family: 'Times New Roman';
                color: #000;
            }
        }
        
        /* SIPDes KOP (KOP utama di print window) */
        .letterhead { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 20px; 
            margin-bottom: 10px;
        }
        .logo { 
            width: 75px; 
            height: 75px; 
            object-fit: cover; 
            border: 1px solid #000;
            border-radius: 0;
            padding: 2px;
        }
        .letterhead-text { 
            flex: 1;
            text-align: center; 
            line-height: 1.3; 
            font-weight: bold;
        }
        .letterhead-text h3 { margin: 0; font-size: 16pt; }
        .letterhead-text h4 { margin: 0; font-size: 14pt; }
        .letterhead-text p { margin: 0; font-size: 11pt; font-weight: normal;}
        .letterhead-hr { 
            border: 0; 
            border-top: 3px solid #000; 
            border-bottom: 1px solid #000; 
            margin: 5px 0 20px; 
        }
        .signature-container {
            display: flex;
            justify-content: space-between; 
            width: 100%;
            margin-top: 40px;
            padding: 0 10px; 
            box-sizing: border-box; 
            page-break-inside: avoid; 
        }
        .signature-block {
            width: 30%; /* Disesuaikan untuk 3 kolom, atau 45% untuk 2 kolom */
            text-align: center;
            font-size: 10pt;
        }
        .signature-block p {
            margin: 0;
        }
        .signature-name {
            display: block;
            min-width: 180px; 
            font-weight: bold;
            margin-top: 60px;
            border-bottom: 1px solid #000;
            text-decoration: none; 
            padding-bottom: 1px;
        }
        .print-footer-info {
            /* Hapus: position: fixed; bottom: 0.5cm; left: 1.5cm; */
            width: 100%;
            text-align: left; /* Teks di kiri */
            padding-left: 1cm; /* Padding sesuai margin kiri @page */
            font-size: 8pt;
            font-family: 'Times New Roman';
            margin-top: 20px; /* Tambahkan sedikit jarak dari konten sebelumnya */
        }
    }
    
    /* SIPDes-RAB Custom Styles (Minimalis, untuk integrasi) */
    .rab-toolbar { margin-bottom: 15px; text-align: left; }
    .rab-actions button {
        background: #009688; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; margin: 2px;
        font-size: 12px;
        
        /* Disable selection for buttons/links */
        -webkit-user-select: none; 
        -ms-user-select: none;     
        user-select: none;         
    }
    .rab-actions button.delete { background: #d32f2f; }
    #rab-detail-header {
        background: #e0f2f1;
        padding: 15px; border-radius: 8px; 
        border: 1px solid #b2dfdb;
        text-align: left;
        
        /* Disable selection for header text */
        -webkit-user-select: none; 
        -ms-user-select: none;     
        user-select: none;         
    }
    /* Perbaikan: Menyesuaikan style kolom tabel detail belanja dengan yang baru */
    #tabelDetailBelanja th, #tabelDetailBelanja td {
        border: 1px solid #ddd; 
        padding: 8px; 
        font-size: 11px;
        vertical-align: top;
    }
    #tabelDetailBelanja th {
        background-color: #00796b; color: white;
    }
    /* Perbaikan: Menghapus style kolom ke-5 dan ke-6 (karena kode dan uraian digabung) */
    #tabelDetailBelanja td:nth-child(5), 
    #tabelDetailBelanja td:nth-child(6) { 
        text-align: right; 
    }
    #detail-total-row {
        background-color: #c8e6c9; font-weight: bold;
    }
    #detail-total-jumlah { text-align: right !important; }

    /* Login/Splash SIPDes asli */
    #splash-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: #004d40; display: flex; justify-content: center;
        align-items: center; flex-direction: column; z-index: 99999;
        transition: opacity 0.5s ease-out;
    }
    #splash-content { text-align: center; color: #e0f2f1; }
    #splash-logo { 
        width: 120px; height: 120px; border-radius: 50%; 
        background: #fff; /* Pastikan background putih untuk logo default */
        padding: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.5); 
        margin-bottom: 20px; object-fit: contain; 
    }
    #splash-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #009688; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 10px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #splash-message { font-size: 16px; font-weight: 500; }

    /* NEW: Progress Bar for Monitoring */
    .progress-bar-container {
        width: 100%;
        background-color: #ddd;
        border-radius: 5px;
        overflow: hidden;
        margin: 5px 0;
        height: 18px;
    }
    .progress-bar {
        height: 100%;
        text-align: right;
        padding-right: 5px;
        color: white;
        font-size: 10px;
        line-height: 18px;
        background-color: #00796b; /* Default Green/Teal */
        transition: width 0.4s ease;
        box-sizing: border-box; /* Pastikan padding tidak menambah lebar */
    }
    .status-badge { /* Small utility class for status visualization */
        padding: 3px 6px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: bold;
        color: white;
        white-space: nowrap;
        
        /* Disable selection for badges */
        -webkit-user-select: none; 
        -ms-user-select: none;     
        user-select: none;         
    }
    .status-badge.status-selesai { background-color: #5cb85c; }
    .status-badge.status-pelaksanaan { background-color: #f0ad4e; }
    .status-badge.status-perencanaan { background-color: #6c757d; }
    .status-badge.status-batal { background-color: #d9534f; }
    
    /* ENHANCEMENT: Monitoring Table Styling */
    .monitoring-card {
        border: 1px solid #b2dfdb;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        page-break-inside: avoid;
    }
    .monitoring-header {
        background-color: #004d40;
        color: white;
        padding: 10px 15px;
        border-radius: 8px 8px 0 0;
        font-size: 1.1em;
        font-weight: bold;
        display: block;
    }
    .monitoring-detail {
        padding: 15px;
        background-color: white;
    }
    .monitoring-kegiatan {
        display: grid;
        grid-template-columns: 1fr 150px 150px 100px; /* Kegiatan, Rencana, Realisasi, Status */
        gap: 15px;
        align-items: center;
        border-bottom: 1px dashed #eee;
        padding: 10px 0;
    }
    .monitoring-kegiatan:last-child {
        border-bottom: none;
    }
    .monitoring-kegiatan strong {
        color: #00796b;
        font-size: 0.95em;
    }
    .monitoring-kegiatan .prog-container {
        grid-column: 1 / -1; /* Rentang penuh untuk progress bar */
    }
    .monitoring-kegiatan .progress-bar-container {
        height: 12px;
        margin: 5px 0;
    }
    .monitoring-kegiatan .progress-bar {
        line-height: 12px;
        font-size: 8px;
    }
    
    /* Perbaikan untuk detail kegiatan di monitoring (print flow) */
    .monitoring-kegiatan > div:first-child p {
        margin: 3px 0 0 !important;
    }
    /* Tampilan print untuk monitoring */
  @media print {
        /* ... (Gaya umum cetak seperti sidebar, form, dll. dihilangkan) ... */
        
        /* ... (Gaya tabel umum) ... */

        /* ENHANCEMENT: Monitoring Print Structure */
        .monitoring-card { 
            border: 1px solid black; 
            margin-bottom: 10px; /* Tambah jarak antar kartu */
        }
        .monitoring-header { 
            background-color: #ccc !important; 
            color: black !important; 
            -webkit-print-color-adjust: exact !important; 
            print-color-adjust: exact !important; 
            padding: 8px 10px !important;
            font-size: 10pt !important;
            border-bottom: 1px solid black !important;
        }
        
        .monitoring-detail {
            padding: 10px !important; /* Kurangi padding */
        }
        
        .monitoring-kegiatan { 
            display: block !important; 
            border-bottom: 1px dotted #ccc !important; 
            padding: 5px 0 !important; 
            page-break-inside: avoid; /* Pastikan kegiatan tidak terpotong */
        }
        .monitoring-kegiatan:last-child {
            border-bottom: none !important;
        }
        
        /* Gaya baru untuk mengatur Rencana/Realisasi/Status secara horizontal */
        .monitoring-kegiatan > div:nth-child(2), 
        .monitoring-kegiatan > div:nth-child(3), 
        .monitoring-kegiatan > div:nth-child(4) {
            display: inline-block !important; 
            width: 30% !important; /* Bagi lebar */
            box-sizing: border-box;
            padding: 2px 5px !important;
            margin-right: 10px !important;
            border: 1px solid #eee;
            vertical-align: top;
            text-align: left !important; /* Rata kiri untuk konsistensi */
        }
        
        /* Tambahkan label menggunakan pseudo-element */
        .monitoring-kegiatan > div:nth-child(2)::before { content: "Rencana: "; font-weight: bold; color: #004d40; display: block; }
        .monitoring-kegiatan > div:nth-child(3)::before { content: "Realisasi: "; font-weight: bold; color: #004d40; display: block; }
        .monitoring-kegiatan > div:nth-child(4)::before { content: "Status: "; font-weight: bold; color: #004d40; display: block; }
        
        /* Progress Container */
        .monitoring-kegiatan .prog-container { 
            margin-top: 5px; 
            display: block !important; /* Pastikan progress bar di baris baru */
        }
        /* Sembunyikan text Penyerapan % yang biasanya di samping bar */
        .monitoring-kegiatan .prog-container small:last-child {
            display: none !important;
        }
        .monitoring-kegiatan .progress-bar-container { 
            width: 95%; 
            max-width: 400px;
            height: 10px !important;
        }
        .monitoring-kegiatan .progress-bar {
             line-height: 10px !important;
             font-size: 7px !important;
        }
        
        /* Sesuaikan total baris di bawah card */
        .monitoring-card > div:last-child {
            font-size: 9pt !important;
            padding: 8px 10px !important;
        }
        
    }
    /* NEW: Pagination Styles */
    .pagination-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding: 10px;
        background-color: #e0f2f1;
        border-radius: 5px;
        
        /* Disable selection for pagination controls */
        -webkit-user-select: none; 
        -ms-user-select: none;     
        user-select: none;         
    }
    .pagination-controls button {
        background-color: #00796b;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .pagination-controls button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        color: #666;
    }
    .pagination-controls select {
        padding: 5px;
        border-radius: 4px;
        border: 1px solid #ccc;
        
        /* Re-enable text selection for select inputs */
        -webkit-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
    }
</style>
</head>
<body>
    
<!-- START: PENCEGAHAN 1 - Nonaktifkan Klik Kanan (di tag <body> di atas) -->

<div id="splash-overlay">
    <div id="splash-content">
        <!-- src="" akan diisi oleh JS, jika kosong akan menggunakan logo default -->
        <img alt="Logo SIPDes" class="desa-logo-sidebar" id="splash-logo" src="">
        <h2>SIPDes Sistem Informasi Perencanaan Desa</h2>
        <div id="splash-spinner"></div>
        <p id="splash-message">Memuat aplikasi...</p>
    </div>
</div>

<div class="login-overlay" id="login_overlay">
    <div class="login-box">
        <!-- Logo akan ditampilkan di sini jika diperlukan, atau bisa langsung menggunakan splash-logo -->
        <img alt="Logo SIPDes" class="desa-logo-sidebar" id="login_logo" src="" style="width: 80px; height: 80px; margin-bottom: 20px; border:none; padding: 0;">
        <h2>SIPDes (Sistem Informasi Perencanaan Desa)</h2>
        <p>Login untuk melanjutkan</p>
        <input id="username_input" placeholder="Username" required="" type="text"/>
        <input id="password_input" placeholder="Password" required="" type="password"/>
        <button onclick="loginUser()">LOGIN</button>
        <p id="login_message"></p>
        <div class="login-footer">
            <small>Hak Cipta Â© 2025 SIPDes (Sistem Informasi Perencanaan Desa) Evhan Syahreza (Perangkat Desa Janapria)</small>
        </div>
    </div>
</div>

<div class="app-hidden" id="app_container">
<div class="sidebar">
    <img alt="Logo Desa" class="desa-logo-sidebar" id="desa_logo" src="" style="display:none;"/>
    <h2>Sistem Informasi Perencanaan Desa</h2>
    <div id="desa_info" style="text-align:center; font-size:13px; color:#b2dfdb; line-height:1.4; margin-top:10px;">
        <strong id="nama_desa"></strong><br/>
        <span id="nama_kecamatan"></span><br/>
        <span id="nama_kabupaten"></span><br/>
        <span id="nama_provinsi"></span>
    </div>
    
    <!-- START: PERBAIKAN URUTAN MODUL DI SIDEBAR -->
    <a class="active" href="#" onclick="showModule(this, 'Dashboard')">ğŸ  Dashboard</a>
    <a href="#" onclick="showModule(this, 'ProfilDesa')">ğŸ›ï¸ Profil Desa</a>
    <a href="#" onclick="showModule(this, 'RPJMDes')">â³ RPJMDes (8 Tahun)</a>
    <a href="#" onclick="showModule(this, 'RencanaPembangunan')">ğŸ—“ï¸ Rencana Pembangunan (RKP)</a>
    <a href="#" onclick="showModule(this, 'RancanganAPBDES')">ğŸ“‹ Ringkasan APBDes</a>
    
    <hr style="border: 0; border-top: 1px solid #00695c; margin: 15px 15px 5px; opacity: 0.5;"> 
    
    <a href="#" onclick="showModule(this, 'RABKegiatanModule')">ğŸ’° RAB (Rencana Anggaran Biaya)</a>
    <a href="#" onclick="showModule(this, 'KegiatanPembangunan')">ğŸš§ Realisasi Kegiatan</a>
    <a href="#" onclick="showModule(this, 'MonitoringEvaluasi')">ğŸ“Š Monitoring & Evaluasi</a>
    
    <hr style="border: 0; border-top: 1px solid #00695c; margin: 5:px 15px 5px; opacity: 0.5;"> 

    <a href="#" onclick="showModule(this, 'InventarisKekayaan')">ğŸ  Inventaris Kekayaan Desa</a>
    <a href="#" onclick="showModule(this, 'InventarisHasil')">ğŸ—ï¸ Inventaris Hasil Pembangunan</a>
    
    <hr style="border: 0; border-top: 1px solid #00695c; margin: 5:px 15px 5px; opacity: 0.5;"> 

    <a href="#" onclick="showModule(this, 'LaporanEksporData')">ğŸ’¾ Laporan &amp; Ekspor Data</a>
    <a class="app-hidden" href="#ManajemenUser" id="menu_manajemen_user" onclick="showModule(this, 'ManajemenUser')">ğŸ‘¥ Manajemen Pengguna</a>
    <a href="#" onclick="showModule(this, 'PengaturanRAB')">âš™ï¸ Pengaturan RAB</a>
    <a href="#" onclick="showClearAllDataModal()">ğŸ—‘ï¸ Hapus Semua Data</a>
    <a href="#" onclick="logoutUser()">[ ğŸ”’ Logout ]</a>
    <!-- END: PERBAIKAN URUTAN MODUL DI SIDEBAR -->
</div>
<div class="main-content">
<div class="filter-bar">
    <label>Tahun Anggaran Aktif:</label>
    <button onclick="setFilterYear(currentFilterYear - 1)">Â« Tahun Sebelumnya</button>
    <input id="filter_year_input" max="2099" min="2010" onchange="setFilterYear(parseInt(this.value))" type="number"/>
    <button onclick="setFilterYear(currentFilterYear + 1)">Tahun Berikutnya Â»</button>
    <button onclick="setFilterYear(new Date().getFullYear())" style="background-color: #f0ad4e;">Tahun Sekarang</button>
    <button onclick="setFilterYear(new Date().getFullYear() + 1)" style="background-color: #5cb85c;">Tahun Depan (RKP)</button>
</div>

<div class="module-content active" id="Dashboard">
    <h1 class="module-header">Dashboard ğŸ“Š (Tahun <span id="dashboard_current_year"></span>)</h1>
    <p>Selamat datang di Sistem Informasi Perencanaan Desa. Berikut adalah ringkasan data untuk tahun **<span id="dashboard_filter_year_label"></span>**:</p>
    <div class="stats-grid">
      <!-- START: PERBAIKAN - Penambahan Card RPJMDes -->
      <div class="stat-card" onclick="jumpToModuleAndFilter('RPJMDes')">
        <h3>Jumlah Rencana (RPJMDes)</h3>
        <p id="rpjmdes_count">0</p>
      </div>
      <!-- END: PERBAIKAN -->
      <div class="stat-card" onclick="jumpToModuleAndFilter('RencanaPembangunan')">
        <h3>Jumlah RKP (Rencana Kegiatan)</h3>
        <p id="rkp_count">0</p>
      </div>
      <div class="stat-card" onclick="jumpToModuleAndFilter('RancanganAPBDES')">
        <h3>Total Anggaran RKP</h3>
        <p id="rkp_total_anggaran">Rp 0,00</p>
      </div>
      <div class="stat-card" onclick="jumpToModuleAndFilter('InventarisKekayaan')">
        <h3>Jumlah Aset Kekayaan</h3>
        <p id="kekayaan_count">0</p>
      </div>
      <div class="stat-card" onclick="jumpToModuleAndFilter('KegiatanPembangunan')">
        <h3>Total Realisasi Anggaran</h3>
        <p id="realisasi_total_anggaran">Rp 0,00</p>
      </div>
    
      <div class="stat-card" onclick="jumpToModuleAndFilter('InventarisHasil')">
        <h3>Jumlah Hasil Pembangunan</h3>
        <p id="hasil_count">0</p>
      </div>
      <div class="stat-card" onclick="jumpToModuleAndFilter('InventarisHasil')">
        <h3>Total Biaya Hasil</h3>
        <p id="hasil_total_biaya">Rp 0,00</p>
      </div>
      <div class="stat-card" onclick="jumpToModuleAndFilter('MonitoringEvaluasi', 'Selesai')">
        <h3>Monitoring: Selesai</h3>
        <p id="monitoring_selesai_count">0</p>
      </div>
      <div class="stat-card" onclick="jumpToModuleAndFilter('MonitoringEvaluasi', 'Pelaksanaan')">
        <h3>Monitoring: Dalam Proses</h3>
        <p id="monitoring_berjalan_count">0</p>
      </div>
      <div class="stat-card" onclick="jumpToModuleAndFilter('MonitoringEvaluasi')">
        <h3>Rataâ€‘rata Progres (%)</h3>
        <p id="monitoring_avg_progress">0%</p>
      </div>
    </div>
    <h2 style="margin-top: 40px; color: #00796b;">Catatan Penting:</h2>
    <ul>
    <li>Semua data yang ditampilkan di Dashboard ini difilter berdasarkan **Tahun Anggaran Aktif** yang Anda pilih.</li>
    <li>Semua data disimpan secara otomatis di **Browser Lokal (Local Storage) MAKA DARI ITU SELALU BACKUP DATA ANDA SECARA BERKALA**.</li>
    <li>Akun default: **admin/admin** (Admin Penuh) atau **operator/operator** (Hanya Input Data).</li>
    </ul>
</div>

<!-- START: PENAMBAHAN MODUL PROFIL DESA -->
<div class="module-content" id="ProfilDesa">
    <h1 class="module-header">Profil Desa ğŸ›ï¸</h1>
    <p>Kelola data umum dan profil singkat Desa untuk keperluan pelaporan.</p>
    <div class="form-container">
        <h2>Visi & Misi</h2>
        <label for="profil_visi">Visi Desa:</label>
        <textarea id="profil_visi" placeholder="Visi Jangka Menengah Desa..." required></textarea>
        
        <label for="profil_misi">Misi Desa:</label>
        <textarea id="profil_misi" placeholder="Misi Jangka Menengah Desa..." required></textarea>
        
        <h2>Data Umum</h2>
        <label for="profil_luas_wilayah">Luas Wilayah (Ha/KmÂ²):</label>
        <input type="text" id="profil_luas_wilayah" placeholder="Contoh: 125,5 Ha" required/>
        
        <label for="profil_jml_penduduk">Jumlah Penduduk (Jiwa):</label>
        <input type="number" id="profil_jml_penduduk" placeholder="Contoh: 3500" required/>
        
        <label for="profil_keterangan">Keterangan Tambahan:</label>
        <textarea id="profil_keterangan" placeholder="Informasi lain tentang profil desa..."></textarea>
        
        <button onclick="saveProfilDesa()">ğŸ’¾ Simpan Profil Desa</button>
    </div>
    <h3 style="margin-top: 30px;">Pratinjau Profil Tersimpan</h3>
    <div id="profil_desa_output"></div>
</div>
<!-- END: PENAMBAHAN MODUL PROFIL DESA -->

<!-- START: PENAMBAHAN MODUL RPJMDes -->
<div class="module-content" id="RPJMDes">
    <h1 class="module-header">RPJMDes (Rencana Pembangunan Jangka Menengah Desa) â³</h1>
    <p>Kelola Dokumen RPJMDes (8 Tahun).</p>
    <div class="form-container">
        <h2>Masa Berlaku Dokumen (8 Tahun)</h2>
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <label for="rpjm_tahun_awal">Tahun Awal Periode:</label>
                <input type="number" id="rpjm_tahun_awal" required/>
            </div>
            <div style="flex: 1;">
                <label for="rpjm_tahun_akhir">Tahun Akhir Periode:</label>
                <input type="number" id="rpjm_tahun_akhir" required/>
            </div>
        </div>
        
        <label for="rpjm_nomor_dokumen">Nomor dan Tanggal Dokumen RPJMDes:</label>
        <input type="text" id="rpjm_nomor_dokumen" placeholder="Contoh: 140/01/2023 (10 Jan 2023)"/>
        
        <h2>Visi & Strategi RPJMDes</h2>
        <label for="rpjm_visi_misi">Visi & Misi RPJMDes Jangka Panjang:</label>
        <textarea id="rpjm_visi_misi" placeholder="Uraian lengkap Visi dan Misi RPJMDes..."></textarea>
        
        <label for="rpjm_strategi">Strategi Pembangunan Jangka Menengah:</label>
        <textarea id="rpjm_strategi" placeholder="Uraian Strategi Umum, Kebijakan, dan Program Pokok..."></textarea>
        
        <button onclick="saveRPJMDes()">ğŸ’¾ Simpan Data Umum RPJMDes</button>
    </div>
    <h3 style="margin-top: 30px;">Pratinjau Dokumen RPJMDes</h3>
    <div id="rpjm_des_output"></div>

    <h2 class="module-header" style="margin-top: 40px;">Rencana Kegiatan Jangka Menengah (RPJMDes)</h2>
    <div class="form-container">
        <button onclick="showRPJMDesDetailModal()">â• Tambah Rencana Kegiatan</button>
    </div>
    <div id="rpjm_detail_list_output">
        <!-- Tabel RPJMDes Detail akan di-render di sini -->
    </div>
</div>
<!-- END: PENAMBAHAN MODUL RPJMDes -->

<div class="module-content" id="RancanganAPBDES">
    <h1 class="module-header">Ringkasan Rancangan APBDes ğŸ“ (Tahun <span id="rapbdes_current_year"></span>)</h1>
    <p>Tabel ini menampilkan ringkasan agregat anggaran RKP per Bidang dan Sub Bidang untuk tahun **<span id="rapbdes_filter_year_label"></span>**.</p>
    <h3 style="margin-top: 30px;">Ringkasan Anggaran per Bidang dan Sub Bidang</h3>
    <div id="rapbdes_summary_output"></div>
    <h3 style="margin-top:30px;">Rekapan Anggaran per Sumber Dana</h3>
    <div id="rapbdes_sumberdana_output"></div>
    <h3 style="margin-top: 30px;">Total Anggaran RKP Tahun <span id="rapbdes_total_year"></span>: <strong id="rapbdes_grand_total">Rp 0,00</strong></h3>
</div>

<!-- START: PERBAIKAN - Modul RKP menjadi modul Input -->
<div class="module-content" id="RencanaPembangunan">
    <h1 class="module-header">Rencana Pembangunan (RKP) ğŸ—“ï¸ (Tahun <span id="rkp_current_year"></span>)</h1>
    <p>Pilih dan impor kegiatan dari RPJMDes untuk dijadikan Rencana Kegiatan Pembangunan (RKP) tahunan. RKP ini akan menjadi dasar pembuatan RAB.</p>
    
    <div class="form-container">
        <button onclick="showImportRkpModal()">â• Impor Kegiatan dari RPJMDes</button>
    </div>
    
    <h3 style="margin-top: 30px;">Daftar RKP Tersimpan (Tahun <span id="rkp_table_year"></span>)</h3>
    <div id="rkp_list_output"></div>
</div>
<!-- END: PERBAIKAN -->

<div class="module-content" id="KegiatanPembangunan">
    <h1 class="module-header">Realisasi Kegiatan (Pelaksanaan) ğŸš§ (Tahun <span id="realisasi_current_year"></span>)</h1>
    <p>Input data realisasi anggaran dan progres fisik dari RKP yang sudah berjalan di tahun **<span id="realisasi_filter_year_label"></span>**.</p>
    <div class="form-container">
        <input id="realisasi_editing_id" type="hidden"/>
        <label for="realisasi_rkp_id">Pilih RKP yang Direalisasi (RKP Tahun <span id="realisasi_form_year"></span>):</label>
        <select id="realisasi_rkp_id" onchange="loadRkpDetails()" required="">
            <option value="">-- Pilih Kegiatan dari RKP --</option>
        </select>
        <label for="realisasi_rkp_anggaran_plan">Anggaran Rencana (Otomatis dari RKP):</label>
        <input disabled="" id="realisasi_rkp_anggaran_plan" type="text" value="Rp 0,00"/>
        
        <label for="realisasi_anggaran">Anggaran Realisasi (Rp):</label>
        <input id="realisasi_anggaran" onkeyup="formatNumberLive(this, false); calculateProgresOtomatis()" onblur="formatNumberLive(this, true); calculateProgresOtomatis()" placeholder="Contoh: 45.000.000,00" required="" type="text"/>
        
        <!-- MODIFIKASI: Input Progres Fisik menjadi Output Progres Otomatis -->
        <label for="realisasi_progres_fisik_otomatis">Progres Otomatis (%):</label>
        <input disabled="" id="realisasi_progres_fisik_otomatis" type="text" value="0%"/>
        <input id="realisasi_progres_fisik" type="hidden"/> <!-- Tetap menyimpan di hidden field untuk data model -->
        <!-- END MODIFIKASI -->

        <label for="realisasi_status">Status Kegiatan:</label>
        <select id="realisasi_status" required="">
            <option value="Perencanaan">Perencanaan</option>
            <option value="Pelaksanaan">Pelaksanaan</option>
            <option value="Selesai">Selesai</option>
            <option value="Batal">Batal</option>
        </select>
        <label for="realisasi_keterangan">Keterangan Tambahan:</label>
        <textarea id="realisasi_keterangan" placeholder="Realisasi s/d tahap 1, ada sisa anggaran."></textarea>
        <button onclick="saveRealisasi()">Simpan Data Realisasi</button>
        <button class="action-btn cancel-btn" onclick="clearRealisasiForm()">Batal/Reset Form</button>
    </div>
    <h3 style="margin-top: 30px;">Daftar Realisasi Kegiatan (Tahun <span id="realisasi_table_year"></span>)</h3>
    <div id="realisasi_list_output"></div>
    <!-- <div id="realisasi_pagination_controls" class="pagination-controls"></div> -->
</div>

<div class="module-content" id="MonitoringEvaluasi">
    <h1 class="module-header">Monitoring & Evaluasi Kegiatan ğŸ“Š (Tahun <span id="monitoring_current_year"></span>)</h1>
    <p>Tabel ini menampilkan perbandingan antara Rencana Kegiatan Pembangunan (RKP) dengan data realisasinya untuk tahun anggaran <strong><span id="monitoring_filter_year_label"></span></strong>.</p>
    <div class="filter-bar no-print">
        <label>Filter Status:</label>
        <select id="monitoring_status_filter" onchange="renderMonitoringTable()">
            <option value="">-- Semua Status --</option>
            <option value="Selesai">Selesai</option>
            <option value="Pelaksanaan">Dalam Proses</option>
            <option value="Perencanaan">Perencanaan</option>
            <option value="Batal">Batal</option>
        </select>
    </div>
    <h3 style="margin-top: 30px;">Tabel Monitoring Terpusat</h3>
    <div id="monitoring_output"></div>
</div>


<div id="RABKegiatanModule" class="module-content">
    <h2>Daftar Kegiatan RAB (RKA Header) ğŸ“ (Tahun <span id="rab_current_year"></span>)</h2>
    <p>Kelola daftar Kegiatan yang anggarannya akan dihitung dari Detil Belanja (RAB) per tahun **<span id="rab_filter_year_label"></span>**.</p>
    
    <!-- MODIFIKASI: Filter Bar Bidang untuk RAB Kegiatan -->
    <div class="filter-bar no-print" style="justify-content: flex-start;">
        <label>Filter Bidang:</label>
        <select id="rab_bidang_filter" onchange="applyRABBidangFilter()">
            <option value="">-- Semua Bidang --</option>
            <!-- Options akan diisi oleh JS -->
        </select>
        <button onclick="clearRABBidangFilter()" style="background-color: #6c757d;">Hapus Filter</button>
    </div>
    <!-- AKHIR MODIFIKASI FILTER -->
    
    <div class="rab-toolbar">
        <button onclick="tampilkanFormRAB()">â• Tambah Kegiatan</button>
    </div>
    <table id="tabelRABKegiatan" class="data-table">
        <thead>
          <tr>
            <th style="width: 15%;">Jenis APBDes</th>
            <th style="width: 45%; text-align: left;">Sub Bidang/Kegiatan/Sub Kegiatan (Level 4)</th>
            <th style="width: 10%;">Waktu Pelaksanaan</th>
            <th style="width: 15%;">Total Anggaran (Rp)</th>
            <th style="width: 15%;">Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
            <tr id="rab-grand-total-row" style="background-color: #004d40; color: white; font-weight: bold;">
                <td colspan="3" style="text-align: right; padding: 15px 12px; font-size: 18px;">GRAND TOTAL ANGGARAN KESELURUHAN</td>
                <td colspan="2" style="text-align: right; font-size: 18px;" id="rab_grand_total_output">Rp 0,00</td>
            </tr>
        </tfoot>
    </table>
    <!-- <div id="rab_kegiatan_pagination_controls" class="pagination-controls"></div> -->
</div>

<!-- START: MODAL BARU - INPUT DETAIL RPJMDes -->
<div id="rpjmDesDetailModal" class="modal-overlay">
  <div class="modal-content" style="max-width: 800px;">
    <h3 id="rpjmDesDetailModalTitle">Tambah Rencana Kegiatan RPJMDes</h3>
    <input type="hidden" id="rpjm_detail_editing_index">

    <!-- START: PERBAIKAN INPUT RPJMDes -->
    <label for="rpjm_bidang">Bidang:</label>
    <select id="rpjm_bidang" onchange="populateRpjmSubBidang()" required></select>

    <label for="rpjm_sub_bidang">Sub Bidang:</label>
    <select id="rpjm_sub_bidang" onchange="populateRpjmKegiatan()" required disabled></select>
    
    <label for="rpjm_kegiatan">Kegiatan (Level 3):</label>
    <select id="rpjm_kegiatan" required disabled></select>
    
    <label for="rpjm_uraian_kegiatan">Uraian/Nama Spesifik Kegiatan (Jenis Kegiatan):</label>
    <input type="text" id="rpjm_uraian_kegiatan" placeholder="Contoh: Pembangunan Jalan Usaha Tani Dusun A" required>
    <!-- END: PERBAIKAN INPUT RPJMDes -->
    
    <div style="display: flex; gap: 10px;">
        <div style="flex: 1;">
            <label>Lokasi:</label>
            <input type="text" id="rpjm_detail_lokasi" placeholder="Contoh: Dusun A, RT 01"/>
        </div>
        <div style="flex: 1;">
            <label>Perkiraan Volume:</label>
            <input type="text" id="rpjm_detail_volume" placeholder="Contoh: 100 MÂ²"/>
        </div>
    </div>
    
    <label>Sasaran/Manfaat:</label>
    <textarea id="rpjm_detail_manfaat" placeholder="Contoh: Memperlancar akses pertanian 50 KK"></textarea>

    <h4 style="margin-top: 15px; text-align: left; color: #004d40;">Waktu Pelaksanaan (Tahun):</h4>
    <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; margin-bottom: 15px;">
        <!-- Checkbox 8 Tahun -->
        <label><input type="checkbox" id="rpjm_tahun_1"> 1</label>
        <label><input type="checkbox" id="rpjm_tahun_2"> 2</label>
        <label><input type="checkbox" id="rpjm_tahun_3"> 3</label>
        <label><input type="checkbox" id="rpjm_tahun_4"> 4</label>
        <label><input type="checkbox" id="rpjm_tahun_5"> 5</label>
        <label><input type="checkbox" id="rpjm_tahun_6"> 6</label>
        <label><input type="checkbox" id="rpjm_tahun_7"> 7</label>
        <label><input type="checkbox" id="rpjm_tahun_8"> 8</label>
    </div>
    
    <h4 style="margin-top: 15px; text-align: left; color: #004d40;">Perkiraan Biaya & Sumber Pembiayaan:</h4>
    <div style="display: flex; gap: 10px;">
        <div style="flex: 2;">
            <label>Jumlah (Rp):</label>
            <input type="text" id="rpjm_detail_jumlah" placeholder="Contoh: 50.000.000,00" onkeyup="formatNumberLive(this, false)" onblur="formatNumberLive(this, true)" required/>
        </div>
        <div style="flex: 1;">
            <label>Sumber:</label>
            <select id="rpjm_detail_sumber">
                <option value="DD">DD</option>
                <option value="ADD">ADD</option>
                <option value="PBH">PBH</option>
                <option value="PBK/PBP">Bantuan (Kab/Prov)</option>
                <option value="PAD">PAD</option>
                <option value="DLL">Lain-Lain</option>
            </select>
        </div>
    </div>

    <h4 style="margin-top: 15px; text-align: left; color: #004d40;">Perkiraan Pola Pelaksanaan:</h4>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; text-align: left;">
        <label><input type="checkbox" id="rpjm_pola_swakelola"> Swakelola</label>
        <label><input type="checkbox" id="rpjm_pola_antardesa"> Kerjasama Antar Desa</label>
        <label><input type="checkbox" id="rpjm_pola_pihakketiga"> Kerjasama Pihak Ketiga</label>
    </div>

    <div class="modal-actions" style="justify-content: center;">
      <button onclick="saveRPJMDesDetail()">Simpan Rencana</button>
      <button onclick="document.getElementById('rpjmDesDetailModal').style.display = 'none';" class="cancel-btn">Batal</button>
    </div>
  </div>
</div>
<!-- END: MODAL BARU - INPUT DETAIL RPJMDes -->

<!-- START: PERBAIKAN - Modal untuk Impor RKP dari RPJMDes -->
<div id="importRkpFromRpjmdesModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px;">
      <h3>Impor Kegiatan dari RPJMDes untuk RKP Tahun <span id="rkp_import_modal_year"></span></h3>
      <p>Pilih satu atau lebih kegiatan dari daftar di bawah yang direncanakan untuk tahun ini.</p>
      <div id="rpjmdes_import_list_output" style="max-height: 50vh; overflow-y: auto; border: 1px solid #eee; padding: 10px; text-align: left;">
        <!-- Daftar kegiatan akan dirender di sini oleh JavaScript -->
      </div>
      <div class="modal-actions" style="justify-content: center;">
        <button onclick="saveRkpFromRpjmdes()">Simpan Pilihan ke RKP</button>
        <button onclick="document.getElementById('importRkpFromRpjmdesModal').style.display = 'none';" class="cancel-btn">Batal</button>
      </div>
    </div>
</div>
<!-- END: PERBAIKAN -->


<div id="RABDetailModule" class="module-content">
    <h2 id="detailRabTitle">Rincian Anggaran Biaya (Detil Belanja)</h2>
    <div id="rab-detail-header">
        <span id="detailHeaderApbdes"></span> |
        <span id="detailHeaderKegiatan"></span>
        <br>
        <span id="detailHeaderWaktu"></span>
        <br>
        <strong style="color: #00796b;">Total Anggaran Kegiatan: <span id="detailHeaderTotal"></span></strong>
    </div>
    <div class="rab-toolbar">
        <!-- TOMBOL INI MEMANGGIL FUNGSI SISKEUDES -->
        <button onclick="tampilkanFormDetailBelanja()">â• Tambah Detil Belanja</button>
        <button onclick="cetakRABDetail()" class="no-print">ğŸ–¨ï¸ Cetak RAB Detil Kegiatan</button> 
        <button onclick="kembaliKeDaftarRAB()">â¬…ï¸ Kembali ke Daftar Kegiatan</button>
    </div>
    <table id="tabelDetailBelanja" class="data-table">
        <thead>
            <tr>
                <th style="width: 3%;">NO</th>
                <th style="width: 40%;">KODE REKENING (Level 5) / URAIAN BELANJA (Level 6)</th>
                <th style="width: 10%;">SUMBER DANA</th>
                <th style="width: 8%;">VOL & SATUAN</th>
                <th style="width: 12%;">HARGA SATUAN (Rp)</th>
                <th style="width: 12%;">JUMLAH (Rp)</th>
                <th style="width: 10%;">PKA</th>
                <th style="width: 5%;">LOKASI</th>
                <th style="width: 5%;">AKSI</th>
            </tr>
        </thead>
        <tbody></tbpody>
        <tfoot>
            <tr id="detail-total-row">
                <td colspan="5" style="padding: 10px; text-align: right;">TOTAL JUMLAH BELANJA</td>
                <td id="detail-total-jumlah" style="padding: 10px; text-align: right;">Rp 0,00</td>
                <td colspan="3"></td>
            </tr>
        </tfoot>
    </table>
</div>

<div id="formDetailModal" class="modal-overlay">
  <div class="modal-content">
    <h3 id="formDetailTitle">â• Tambah Detil Belanja</h3>
    <input type="hidden" id="detailKegiatanIndex">
    <input type="hidden" id="detailIndex">

    <!-- START: GRUP DROP DOWN LEVEL 3 & 5 (DISEM BUNYIKAN KETIKA MODE LANJUTAN) -->
    <div id="formDetailModalJenisAkunGroup">
        <label>Jenis Belanja (5.1.X / 5.2.X / 5.3.X):</label>
        <select id="detailJenisAkun" onchange="populateObyekAkun()" required>
            <option value="">-- Pilih Jenis Belanja --</option>
        </select>
    </div>

    <div id="formDetailModalObyekAkunGroup">
        <label>Objek Belanja (5.X.X.XX - Level 5):</label>
        <select id="detailObyekAkun" onchange="generateUraianPlaceholder()" required disabled>
            <option value="">-- Pilih Objek Belanja --</option>
        </select>
    </div>
    <!-- END: GRUP DROP DOWN LEVEL 3 & 5 -->
    
    <!-- BARU: DISPLAY LEVEL 5 YANG SEDANG AKTIF (SIMULASI SISKEUDES) -->
    <div id="activeObyekDisplay" style="text-align: left; margin-bottom: 15px; border: 1px solid #00796b; padding: 10px; border-radius: 4px; display: none;">
         <strong style="color: #004d40;">Objek Belanja Aktif (Level 5):</strong>
         <span id="activeObyekKode"></span> - <span id="activeObyekNama"></span>
         <a href="#" onclick="changeObyekAndCloseDetail()" style="float: right; color: #d9534f; font-size: 0.9em;">[Ganti Objek]</a>
         <input type="hidden" id="detailObyekAktifKode">
    </div>
    <!-- AKHIR DISPLAY LEVEL 5 -->


    <label>Rincian Obyek (Level 6) / Uraian Detail Belanja:</label>
    <input type="text" id="detailUraian" placeholder="Rincian Obyek/Uraian Detail Belanja (Wajib Diisi)" required>
    
    <label>Sumber Dana:</label>
    <select id="detailSumberDana">
        <option value="DD">DD (Dana Desa)</option>
        <option value="ADD">ADD (Alokasi Dana Desa)</option>
        <option value="PBH">PBH (Bagi Hasil Pajak & Retribusi)</option>
        <option value="PBK">PBK (Bantuan Keuangan Kab/Kota)</option>
        <option value="PBP">PBP (Bantuan Keuangan Provinsi)</option>
        <option value="PAD">PAD (Pendapatan Asli Desa)</option>
        <option value="SWADAYA">Swadaya Masyarakat</option>
        <option value="LAIN-LAIN">Lain-Lain Pendapatan</option>
    </select>

    <div style="display: flex; justify-content: space-between; gap: 10px;">
        <input type="text" id="detailVolume" placeholder="Volume (Cth: 1.234,50)" required style="width: 40%;" oninput="formatNumberLive(this, false)" onblur="formatNumberLive(this, true)">
        <input type="text" id="detailSatuan" placeholder="Satuan (Cth: Unit/M2)" required style="width: 60%;">
    </div>
    
    <input type="text" id="detailHargaSatuan" placeholder="Harga Satuan (Rp) (Cth: 1.000.000,90)" required oninput="formatNumberLive(this, false)" onblur="formatNumberLive(this, true)">

    <hr/>

    <label>Pilih Pelaksana Kegiatan (PKA):</label>
    <select id="selectPKAFromList" onchange="setPKAFields()" required>
        <option value="">-- Pilih Nama Pegawai PKA --</option>
        </select>
    
    <hr/>
    
    <input type="text" id="detailKet" placeholder="Keterangan Tambahan/Lokasi Fisik (Jika Berbeda dari Kegiatan)" required>

    <div class="modal-actions">
      <button onclick="simpanDetailBelanja()">Simpan Detil</button>
      <button onclick="tutupFormDetail()">Batal</button>
      <!-- TOMBOL INPUT BERKELANJUTAN (SIMULASI SISKEUDES) -->
      <button id="btnSimpanDanLanjut" onclick="simpanDetailBelanja(true)" style="background-color: #004d40; display: none;">Simpan & Lanjut</button>
    </div>
  </div>
</div>

<div id="formCetakRABPerBidangModal" class="modal-overlay">
  <div class="modal-content">
    <h3>Cetak RAB Berdasarkan Bidang</h3>
    <p>Pilih Bidang Kegiatan yang ingin dicetak RAB-nya:</p>
    
    <label>Pilih Bidang:</label>
    <select id="selectBidangCetakRAB" required>
        <option value="">-- Pilih Bidang --</option>
        </select>
    
    <div class="modal-actions">
      <button onclick="prosesCetakRABPerBidang()">Cetak RAB</button>
      <button onclick="document.getElementById('formCetakRABPerBidangModal').style.display = 'none';">Batal</button>
    </div>
  </div>
</div>

<div id="formImportModal" class="modal-overlay">
  <div class="modal-content">
    <h3>ğŸ“¥ Impor Data</h3>
    <p>Unggah file data cadangan (.json) yang telah di-export sebelumnya:</p>
    
    <label for="importFile">Pilih File JSON:</label>
    <input type="file" id="importFile" accept=".json" required>
    
    <p class="text-warning" style="font-size: 12px; color: #ffcc00; background: #004d40; padding: 5px; border-radius: 3px;">âš ï¸ Pastikan file yang diunggah adalah hasil export dari aplikasi ini.</p>

    <div class="modal-actions">
      <button onclick="importAllData()">Proses Impor</button>
      <button onclick="document.getElementById('formImportModal').style.display = 'none';">Batal</button>
    </div>
  </div>
</div>

<!-- NEW MODAL: UNTUK MENAMPILKAN DETIL RAB DARI RKP/REALISASI/MONITORING -->
<div id="rabDetailViewModal" class="modal-overlay">
  <div class="modal-content" style="max-width: 900px; padding: 20px;">
    <h3 id="rabViewModalTitle" style="text-align: left;">Rincian Anggaran Biaya Kegiatan</h3>
    <div id="rabViewDetailHeader" style="text-align: left; margin-bottom: 15px; border-bottom: 1px solid #ccc; padding-bottom: 10px; font-size: 14px;">
        <!-- Info Kegiatan, Total, dll. -->
    </div>
    <div id="rabViewDetailTableContainer" style="max-height: 60vh; overflow-y: auto; padding: 5px;">
        <!-- Tabel Detil Belanja akan di-inject di sini -->
    </div>
    <div class="modal-actions" style="justify-content: center;">
      <button onclick="document.getElementById('rabDetailViewModal').style.display = 'none';" class="cancel-btn">Tutup</button>
    </div>
  </div>
</div>
<!-- END NEW MODAL -->

<!-- START: MODAL BARU - INPUT KEGIATAN RAB (RKA Header) -->
<div id="formRABModal" class="modal-overlay">
  <div class="modal-content">
    <h3 id="formRABTitle">â• Tambah Kegiatan RAB (Tahun Aktif: <span id="rab_modal_year"></span>)</h3>
    <input type="hidden" id="rabKegiatanIndex">
    
    <!-- START: PERBAIKAN - Integrasi dengan RKPDes, bukan RPJMDes -->
    <label for="select_from_rkpdes">Impor dari Rencana RKPDes (Opsional):</label>
    <select id="select_from_rkpdes" onchange="populateRABFormFromRKP()">
        <option value="">-- Pilih Rencana dari RKPDes --</option>
    </select>
    <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">
    <!-- END: PERBAIKAN -->

    <label for="rabJenisApbdes">Jenis APBDes (Dokumen):</label>
    <select id="rabJenisApbdes" required>
        <option value="RAPBDes">RAPBDes</option>
        <option value="APBDes Awal">APBDes Awal</option>
        <option value="APBDes Perubahan">APBDes Perubahan</option>
    </select>

    <label for="rabBidang">Bidang:</label>
    <select id="rabBidang" onchange="populateSubBidang()" required>
        <option value="">-- Pilih Bidang --</option>
    </select>

    <label for="rabSubBidang">Sub Bidang:</label>
    <select id="rabSubBidang" onchange="populateKegiatan()" required disabled>
        <option value="">-- Pilih Sub Bidang --</option>
    </select>
    
    <label for="rabKegiatan">Kegiatan (Level 3):</label>
    <select id="rabKegiatan" required disabled>
        <option value="">-- Pilih Kegiatan --</option>
    </select>
    
    <label for="rabSubKegiatanNama">Sub Kegiatan / Uraian RKP (Level 4/Lokasi):</label>
    <input type="text" id="rabSubKegiatanNama" placeholder="Contoh: Pembangunan JUT Dusun A/100 M' TPT" required>
    
    <label for="rabWaktuPelaksanaan">Waktu Pelaksanaan (Bulan):</label>
    <input type="text" id="rabWaktuPelaksanaan" placeholder="Contoh: Jan-Maret / Tahap I, II, III" required>

    <div class="modal-actions">
      <button onclick="simpanRABKegiatan()">ğŸ’¾ Simpan Kegiatan</button>
      <button onclick="tutupFormRAB()" class="cancel-btn">Batal</button>
    </div>
  </div>
</div>
<!-- END: MODAL BARU - INPUT KEGIATAN RAB (RKA Header) -->

<!-- START: MODAL BARU - PEMILIHAN OBJEK (LEVEL 5) -->
<div id="selectObyekModal" class="modal-overlay">
  <div class="modal-content">
    <h3>Pilih Objek Belanja (Level 5)</h3>
    <p>Langkah 1: Pilih Jenis Belanja (Level 3)</p>
    <label for="selectObyekJenisAkun">Jenis Belanja (5.X.X):</label>
    <select id="selectObyekJenisAkun" onchange="populateObyekAkunSelectModal()" required>
        <option value="">-- Pilih Jenis Belanja --</option>
    </select>
    
    <p style="margin-top: 15px;">Langkah 2: Pilih Objek Belanja (Level 5)</p>
    <label for="selectObyekObyekAkun">Objek Belanja (5.X.X.XX):</label>
    <select id="selectObyekObyekAkun" required disabled>
        <option value="">-- Pilih Objek Belanja --</option>
    </select>
    
    <div class="modal-actions" style="justify-content: space-between;">
      <button onclick="confirmObyekSelectionAndOpenDetail()" style="background-color: #004d40;">Lanjut ke Input Detil (Level 6) Â»</button>
      <button onclick="document.getElementById('selectObyekModal').style.display = 'none';" class="cancel-btn">Batal</button>
    </div>
  </div>
</div>
<!-- END: MODAL BARU - PEMILIHAN OBJEK (LEVEL 5) -->

<!-- START: MODUL INVENTARIS KEKAYAAN -->
<div class="module-content" id="InventarisKekayaan">
    <h1 class="module-header">Inventaris Kekayaan Desa ğŸ  (Tahun Perolehan <span id="kekayaan_current_year"></span>)</h1>
    <p>Kelola data aset dan kekayaan yang dimiliki Desa, difilter berdasarkan tahun perolehan **<span id="kekayaan_filter_year_label"></span>**.</p>
    <div class="form-container">
        <h2>Input Data Kekayaan/Aset</h2>
        <input type="hidden" id="kekayaan_editing_id"/>
        
        <label for="kekayaan_nama">Nama Barang/Aset:</label>
        <input type="text" id="kekayaan_nama" placeholder="Contoh: Sepeda Motor Dinas" required/>

        <label for="kekayaan_kode">Kode Aset (Opsional):</label>
        <input type="text" id="kekayaan_kode" placeholder="Contoh: KIB-B.01"/>
        
        <div style="display: flex; gap: 20px;">
             <div style="flex: 1;">
                 <label for="kekayaan_tahun_perolehan">Tahun Perolehan:</label>
                 <input type="number" id="kekayaan_tahun_perolehan" required min="2010" max="2099"/>
             </div>
             <div style="flex: 1;">
                 <label for="kekayaan_nilai">Nilai Perolehan (Rp):</label>
                 <input type="text" id="kekayaan_nilai" onkeyup="formatNumberLive(this, false)" onblur="formatNumberLive(this, true)" placeholder="Contoh: 15.000.000,00" required/>
             </div>
        </div>
        
        <label for="kekayaan_kondisi">Kondisi Barang/Aset:</label>
        <select id="kekayaan_kondisi" required>
            <option value="Baik">Baik</option>
            <option value="Rusak Ringan">Rusak Ringan</option>
            <option value="Rusak Berat">Rusak Berat</option>
        </select>
        
        <label for="kekayaan_keterangan">Keterangan Tambahan (Lokasi/Spesifikasi):</label>
        <textarea id="kekayaan_keterangan" placeholder="Informasi lokasi fisik atau spesifikasi aset..."></textarea>
        
        <button onclick="saveKekayaan()">ğŸ’¾ Simpan Data Kekayaan</button>
        <button class="action-btn cancel-btn" onclick="clearKekayaanForm()">Batal/Reset Form</button>
    </div>
    
    <h3 style="margin-top: 30px;">Daftar Inventaris Kekayaan (Tahun <span id="kekayaan_table_year"></span>)</h3>
    <div id="kekayaan_list_output"></div>
</div>
<!-- END: MODUL INVENTARIS KEKAYAAN -->

<!-- START: MODUL INVENTARIS HASIL PEMBANGUNAN -->
<div class="module-content" id="InventarisHasil">
    <h1 class="module-header">Inventaris Hasil Pembangunan ğŸ—ï¸ (Tahun Selesai <span id="hasil_current_year"></span>)</h1>
    <p>Kelola data hasil pembangunan fisik yang telah diselesaikan Desa, difilter berdasarkan tahun selesai **<span id="hasil_filter_year_label"></span>**.</p>
    <div class="form-container">
        <h2>Input Data Hasil Pembangunan Fisik</h2>
        <input type="hidden" id="hasil_editing_id"/>
        
        <label for="hasil_nama">Nama Hasil Kegiatan:</label>
        <input type="text" id="hasil_nama" placeholder="Contoh: Pembangunan Gedung Serbaguna Tahap II" required/>
        
        <div style="display: flex; gap: 20px;">
             <div style="flex: 1;">
                 <label for="hasil_tahun_selesai">Tahun Selesai:</label>
                 <input type="number" id="hasil_tahun_selesai" required min="2010" max="2099"/>
             </div>
             <div style="flex: 1;">
                 <label for="hasil_biaya">Biaya Pembangunan (Rp):</label>
                 <input type="text" id="hasil_biaya" onkeyup="formatNumberLive(this, false)" onblur="formatNumberLive(this, true)" placeholder="Contoh: 150.000.000,00" required/>
             </div>
        </div>

        <label for="hasil_lokasi">Lokasi Fisik / Volume Hasil:</label>
        <input type="text" id="hasil_lokasi" placeholder="Contoh: Dusun C / 250 MÂ²" required/>
        
        <label for="hasil_manfaat">Manfaat/Keterangan:</label>
        <textarea id="hasil_manfaat" placeholder="Manfaat yang diperoleh masyarakat atau keterangan tambahan..."></textarea>
        
        <button onclick="saveHasil()">ğŸ’¾ Simpan Data Hasil</button>
        <button class="action-btn cancel-btn" onclick="clearHasilForm()">Batal/Reset Form</button>
    </div>
    
    <h3 style="margin-top: 30px;">Daftar Inventaris Hasil Pembangunan (Tahun <span id="hasil_table_year"></span>)</h3>
    <div id="hasil_list_output"></div>
</div>
<!-- END: MODUL INVENTARIS HASIL PEMBANGUNAN -->

<!-- START: MODUL LAPORAN & EKSPOR DATA -->
<div class="module-content" id="LaporanEksporData">
    <h1 class="module-header">Laporan &amp; Ekspor Data ğŸ’¾</h1>
    <p>Cetak Dokumen Laporan Perencanaan dan Keuangan Desa serta Kelola Data Cadangan (Backup).</p>
    
    <div class="form-container">
        <h2>Cetak Dokumen Perencanaan (Tahun Anggaran <span id="laporan_current_year">${currentFilterYear}</span>)</h2>
        <p>Pilih dokumen yang ingin dicetak. Pastikan data di modul terkait sudah lengkap.</p>
        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
            <!-- START: TAMBAH TOMBOL CETAK RPJMDes -->
            <button onclick="cetakLaporanDariModul('RPJMDes')">ğŸ–¨ï¸ Cetak RPJMDes</button>
            <!-- END: TAMBAH TOMBOL CETAK RPJMDes -->
            <button onclick="cetakLaporanDariModul('RencanaPembangunan')">ğŸ–¨ï¸ Cetak RKP</button>
            <button onclick="cetakLaporanDariModul('RancanganAPBDES')">ğŸ–¨ï¸ Cetak Ringkasan APBDes</button>
            <button onclick="tampilkanFormCetakRABPerBidang()">ğŸ–¨ï¸ Cetak RAB Per Bidang</button>
            <button onclick="cetakRABKeseluruhan()">ğŸ–¨ï¸ Cetak RAB Keseluruhan</button>
            <button onclick="cetakLaporanDariModul('MonitoringEvaluasi')">ğŸ–¨ï¸ Cetak Laporan Monitoring</button>
            
            <!-- START: FIX - Tambahkan tombol Cetak Inventaris Kekayaan -->
            <button onclick="cetakLaporanDariModul('InventarisKekayaan')">ğŸ–¨ï¸ Cetak Inventaris Kekayaan</button>
            <!-- END: FIX -->
            
            <button onclick="cetakLaporanDariModul('InventarisHasil')">ğŸ–¨ï¸ Cetak Inventaris Hasil</button>
            <!-- START: PENAMBAHAN TOMBOL CETAK INVENTARIS PEMBANGUNAN SESUAI PERMINTAAN (Diperbaiki agar hanya 1 tombol untuk Hasil/Pembangunan) -->
            <!-- <button onclick="cetakLaporanDariModul('InventarisHasil')">ğŸ–¨ï¸ Cetak Inventaris Pembangunan</button> -->
            <!-- END: PENAMBAHAN TOMBOL CETAK INVENTARIS PEMBANGUNAN SESUAI PERMINTAAN -->
        </div>
    </div>
    
    <div class="form-container">
        <h2>Kelola Identitas Wilayah (KOP Laporan)</h2>
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <label for="input_desa">Nama Desa:</label>
                <input type="text" id="input_desa" placeholder="Cth: Janapria" required/>
                <label for="input_kecamatan">Nama Kecamatan:</label>
                <input type="text" id="input_kecamatan" placeholder="Cth: Janapria" required/>
                <label for="input_kabupaten">Nama Kabupaten:</label>
                <input type="text" id="input_kabupaten" placeholder="Cth: Lombok Tengah" required/>
                <label for="input_provinsi">Nama Provinsi:</label>
                <input type="text" id="input_provinsi" placeholder="Cth: Nusa Tenggara Barat" required/>
            </div>
             <div style="flex: 1;">
                <label for="input_alamat">Alamat Desa (KOP):</label>
                <input type="text" id="input_alamat" placeholder="Cth: Jalan Utama Desa" required/>
                <label for="input_kodepos">Kode Pos (KOP):</label>
                <input type="text" id="input_kodepos" placeholder="Cth: 83551" required/>
                 <div style="margin-top: 15px;">
                    <button onclick="saveWilayah()">ğŸ’¾ Simpan Identitas</button>
                    <button onclick="hapusWilayah()" class="action-btn delete-btn">ğŸ—‘ï¸ Hapus Identitas</button>
                </div>
            </div>
        </div>
        
        <h3 style="margin-top: 20px;">Pengaturan Logo (KOP Laporan)</h3>
        <input type="file" id="logo_input" accept="image/*" onchange="previewLogo(event)">
        <p id="logo_upload_message" style="color:red; font-size:12px; margin-top:5px;"></p>
        <img id="logo_preview" src="" alt="Logo Desa Preview" class="desa-logo-sidebar" style="margin: 10px 0 0 0; border: none; padding: 0;"/>
        <div style="margin-top: 10px;">
             <button onclick="saveDesaLogo()">ğŸ’¾ Simpan Logo</button>
             <button onclick="removeDesaLogo()" class="action-btn delete-btn">ğŸ—‘ï¸ Hapus Logo</button>
        </div>
        
    </div>

    <div class="form-container">
        <h2>Kelola Data Cadangan (Backup)</h2>
        <p>Gunakan fitur ini untuk menyimpan salinan data Anda atau memindahkannya ke perangkat lain.</p>
        <button onclick="exportAllData()" style="background-color: #004d40;">â¬‡ï¸ Export (Download) Semua Data</button>
        <button onclick="document.getElementById('formImportModal').style.display = 'flex';" style="background-color: #f0ad4e;">â¬†ï¸ Import (Upload) Data</button>
    </div>
</div>
<!-- END: MODUL LAPORAN & EKSPOR DATA -->

<!-- START: MODUL MANAJEMEN PENGGUNA -->
<div class="module-content" id="ManajemenUser">
    <h1 class="module-header">Manajemen Pengguna ğŸ‘¥</h1>
    <p>Kelola akun pengguna (Admin hanya bisa diatur oleh Admin). Akun demo otomatis kedaluwarsa setelah 7 hari.</p>
    <div class="form-container">
        <h2>Tambah/Edit Pengguna</h2>
        <input type="hidden" id="user_editing_id"/>
        
        <label for="user_username">Username:</label>
        <input type="text" id="user_username" placeholder="Username unik" required/>

        <label for="user_password">Password (Kosongkan jika tidak ingin diubah):</label>
        <input type="password" id="user_password" placeholder="Isi untuk membuat/mengubah password" />
        
        <label for="user_role">Peran (Role):</label>
        <select id="user_role" required>
            <option value="admin">Admin Penuh</option>
            <option value="operator">Operator (Hanya Input Data)</option>
        </select>
        
        <div style="margin: 15px 0; text-align: left;">
            <input type="checkbox" id="user_is_demo" style="width: auto; margin-right: 10px;"/> 
            <label for="user_is_demo" style="display: inline; font-weight: normal; color: #d9534f;">Jadikan Akun Demo (Kedaluwarsa 7 Hari)</label>
        </div>

        <button onclick="saveUser()">ğŸ’¾ Simpan Pengguna</button>
        <button class="action-btn cancel-btn" onclick="clearUserForm()">Batal/Reset Form</button>
    </div>
    
    <h3 style="margin-top: 30px;">Daftar Pengguna Aktif</h3>
    <div id="user_list_output"></div>
</div>
<!-- END: MODUL MANAJEMEN PENGGUNA -->

<!-- START: MODUL PENGATURAN RAB -->
<div class="module-content" id="PengaturanRAB">
    <h1 class="module-header">Pengaturan RAB âš™ï¸ & Tanda Tangan</h1>
    <p>Kelola daftar Pelaksana Kegiatan Anggaran (PKA) dan Akun Belanja (Level 5) kustom.</p>

    <div class="form-container">
        <h2>Pengaturan Tanda Tangan Utama (Untuk KOP Laporan)</h2>
        <label for="settingNamaKades">Nama Kepala Desa:</label>
        <input type="text" id="settingNamaKades" placeholder="Nama Lengkap Kepala Desa" required/>

        <label for="settingNamaSekdes">Nama Sekretaris Desa:</label>
        <input type="text" id="settingNamaSekdes" placeholder="Nama Lengkap Sekretaris Desa" required/>
        
        <label for="settingNamaKaurRen">Nama Kaur Perencanaan:</label>
        <input type="text" id="settingNamaKaurRen" placeholder="Nama Lengkap Kaur Perencanaan" required/>
        
        <button onclick="saveRABSettings()">ğŸ’¾ Simpan Tanda Tangan</button>
    </div>
    
    <div class="form-container">
        <h2 id="pka_list_header">Kelola Daftar Pelaksana Teknis Kegiatan (PKA)</h2>
        <input type="hidden" id="pka_editing_index"/>
        
        <label for="pka_nama_input">Nama Pegawai:</label>
        <input type="text" id="pka_nama_input" placeholder="Contoh: Sumiati" required/>

        <label for="pka_jabatan_input">Jabatan di Tanda Tangan (PKA):</label>
        <input type="text" id="pka_jabatan_input" placeholder="Contoh: KAUR KEUANGAN / KAUR PERENCANAAN" required/>
        
        <button onclick="saveCustomPKA()">ğŸ’¾ Simpan PKA</button>
        <button class="action-btn cancel-btn" onclick="clearCustomPKAForm()">Batal/Reset Form</button>
        
        <h3 style="margin-top: 20px;">Daftar PKA Tersimpan</h3>
        <div id="pka_list_output"></div>
    </div>
    
    <div class="form-container">
        <h2 id="akun_belanja_list_header">Kelola Daftar Akun Belanja (Obyek) Tambahan</h2>
        <p>Tambahkan akun Level 5 kustom. Format harus `5.X.X.XX`.</p>
        <input type="hidden" id="obyek_editing_id"/>
        
        <label for="obyek_kode_input">Kode Akun Obyek (Level 5):</label>
        <input type="text" id="obyek_kode_input" placeholder="Contoh: 5.3.9.99" required/>

        <label for="obyek_nama_input">Nama Uraian Obyek:</label>
        <input type="text" id="obyek_nama_input" placeholder="Contoh: Belanja Modal Khusus Lain-Lain" required/>
        
        <button onclick="saveCustomObyekAccount()">ğŸ’¾ Simpan Obyek</button>
        <button class="action-btn cancel-btn" onclick="clearCustomObyekForm()">Batal/Reset Form</button>
        
        <h3 style="margin-top: 20px;">Daftar Obyek Kustom Tersimpan</h3>
        <div id="obyek_list_output"></div>
    </div>
</div>
<!-- END: MODUL PENGATURAN RAB -->

<!-- START: MODAL KONFIRMASI HAPUS SEMUA DATA -->
<div id="confirmClearAllModal" class="modal-overlay">
  <div class="modal-content" style="max-width: 400px; text-align: left;">
    <h3 style="color: #d9534f;">âš ï¸ HAPUS SEMUA DATA PERMANEN</h3>
    <p>Tindakan ini akan menghapus semua data (RKP, Realisasi, RAB, Inventaris, User, Setting, dll.) yang tersimpan di browser lokal Anda. **Tindakan ini tidak dapat dibatalkan.**</p>
    <p style="font-weight: bold;">Untuk konfirmasi, ketik kata **HAPUS** (huruf kapital) di kolom bawah:</p>
    
    <label for="clearAllVerificationInput" style="margin-top: 10px;">Ketik HAPUS:</label>
    <input type="text" id="clearAllVerificationInput" required style="width: 100%; text-align: center; font-weight: bold; color: #d9534f;"/>
    
    <div class="modal-actions" style="justify-content: space-between; margin-top: 25px;">
      <button onclick="clearAllData()" style="background-color: #d9534f;">âŒ Konfirmasi Hapus Permanen</button>
      <button onclick="document.getElementById('confirmClearAllModal').style.display = 'none';" class="cancel-btn">Batal</button>
    </div>
  </div>
</div>
<!-- END: MODAL KONFIRMASI HAPUS SEMUA DATA -->
<footer class="app-footer">
    Hak Cipta Â© 2025 Evhan Syahreza | Perangkat Desa Janapria, Kec. Janapria, Kab. Lombok Tengah, NTB
</footer>

<script>
// =======================================================================
// === 1. GLOBAL VARIABLES & CORE DATA ===================================
// =======================================================================

// --- RAB PARAMETERS (Gunakan yang paling lengkap) ---
const RAB_PARAMETERS = [{"kode": "01","nama": "BIDANG PENYELENGGARAN PEMERINTAHAN DESA","subBidang": [{"kode": "01.01.","nama": "Penyelenggaran Belanja Siltap, Tunjangan dan Operasional Pemerintahan Desa","kegiatan": [{"kode": "01.01.01.","nama": "Penyediaan Penghasilan Tetap dan Tunjangan Kepala Desa"}, {"kode": "01.01.02.","nama": "Penyediaan Penghasilan Tetap dan Tunjangan Perangkat Desa"}, {"kode": "01.01.03.","nama": "Penyediaan Jaminan Sosial bagi Kepala Desa dan Perangkat Desa"}, {"kode": "01.01.04.","nama": "Penyediaan Operasional Pemerintah Desa (ATK, Honor PKPKD dan PPKD dll)"}, {"kode": "01.01.05.","nama": "Penyediaan Tunjangan BPD"}, {"kode": "01.01.06.","nama": "Penyediaan Operasional BPD (rapat, ATK, Makan Minum, Pakaian Seragam, Listrik dll)"}, {"kode": "01.01.07.","nama": "Penyediaan Insentif/Operasional RT/RW"}, {"kode": "01.01.08.","nama": "Penyediaan Operasional Pemerintah Desa yang bersumber dari Dana Desa"}, {"kode": "01.01.90.","nama": "Penyediaan Tunjangan Kepala Desa Persiapan"}, {"kode": "01.01.91.","nama": "Penyediaan Penghasilan Tetap Perangkat Desa Persiapan"}, {"kode": "01.01.92.","nama": "Penyediaan Jaminan Sosial bagi BPD"}, {"kode": "01.01.93.","nama": "Penyediaan Jaminan Sosial Bagi Lembaga Kemasyarakatan Desa"}]}, {"kode": "01.02.","nama": "Penyediaan Sarana Prasarana Pemerintahan Desa","kegiatan": [{"kode": "01.02.01.","nama": "Penyediaan Sarana (Aset Tetap) Perkantoran/Pemerintahan"}, {"kode": "01.02.02.","nama": "Pemeliharaan Gedung/Prasarana Kantor Desa"}, {"kode": "01.02.03.","nama": "Pembangunan/Rehabilitasi/Peningkatan Gedung/Prasarana Kantor Desa **)"}]}, {"kode": "01.03.","nama": "Pengelolaan Administrasi Kependudukan, Pencatatan Sipil, Statistik dan Kearsipan","kegiatan": [{"kode": "01.03.01.","nama": "Pelayanan Administrasi Umum dan Kependudukan"}, {"kode": "01.03.02.","nama": "Penyusunan, Pendataan, dan Pemutakhiran Profil Desa **)"}, {"kode": "01.03.03.","nama": "Pengelolaan Administrasi dan Kearsipan Pemerintahan Desa"}, {"kode": "01.03.04.","nama": "Penyuluhan dan Penyadaran Masyarakat tentang Kependudukan dan Capil"}, {"kode": "01.03.05.","nama": "Pemetaan dan Analisis Kemiskinan Desa secara Partisipatif"}]}, {"kode": "01.04.","nama": "Penyelenggaraan Tata Praja Pemerintahan, Perencanaan, Keuangan dan Pelaporan","kegiatan": [{"kode": "01.04.01.","nama": "Penyelenggaraan Musyawarah Perencanaan Desa/Pembahasan APBDes (Reguler)"}, {"kode": "01.04.02.","nama": "Penyelenggaraan Musyawarah Desa Lainnya (Musdus, Rembug desa Non Reguler)"}, {"kode": "01.04.03.","nama": "Penyusunan Dokumen Perencanaan Desa (RPJMDesa/RKPDesa dll)"}, {"kode": "01.04.04.","nama": "Penyusunan Dokumen Keuangan Desa (APBDes, APBDes Perubahan, LPJ dll)"}, {"kode": "01.04.05.","nama": "Pengelolaan Administrasi/ Inventarisasi/Penilaian Aset Desa"}, {"kode": "01.04.06.","nama": "Penyusunan Kebijakan Desa (Perdes/Perkades selain Perencanaan/Keuangan)"}, {"kode": "01.04.07.","nama": "Penyusunan Laporan Kepala Desa, LPPDesa dan Informasi Kepada Masyarakat"}, {"kode": "01.04.08.","nama": "Pengembangan Sistem Informasi Desa"}, {"kode": "01.04.09.","nama": "Koordinasi/Kerjasama Penyelenggaraan Pemerintahan & Pembangunan Desa"}, {"kode": "01.04.10.","nama": "Dukungan & Sosialisasi Pelaksanaan Pilkades, Pemilihan Ka. Kewilayahan & BPD"}, {"kode": "01.04.11.","nama": "Penyelenggaraan Lomba antar Kewilayahan & Pengiriman Kontingen dalam Mengikuti Lomba Desa"}, {"kode": "01.04.12.","nama": "Dukungan Biaya Operasional dan Biaya Lainnya untuk Desa Persiapan"}]}, {"kode": "01.05.","nama": "Sub Bidang Pertanahan","kegiatan": [{"kode": "01.05.01.","nama": "Sertifikasi Tanah Kas Desa"}, {"kode": "01.05.02.","nama": "Administrasi Pertanahan (Pendaftaran Tanah dan Pemberian Registrasi Agenda Pertanahan)"}, {"kode": "01.05.03.","nama": "Fasilitasi Sertifikasi Tanah untuk Masyarakat Miskin"}, {"kode": "01.05.04.","nama": "Kegiatan Mediasi Konflik Pertanahan"}, {"kode": "01.05.05.","nama": "Kegiatan Penyuluhan Pertanahan"}, {"kode": "01.05.06.","nama": "Adminstrasi Pajak Bumi dan Bangunan (PBB)"}, {"kode": "01.05.07.","nama": "Penentuan/Penegasan Batas/patok Tanah Kas Desa"}]}]}, {"kode": "02","nama": "BIDANG PELAKSANAAN PEMBANGUNAN DESA","subBidang": [{"kode": "02.01.","nama": "Sub Bidang Pendidikan","kegiatan": [{"kode": "02.01.01.","nama": "Penyelenggaraan PAUD/TK/TPA/TKA/TPQ/Madrasah Non-Formal Milik Desa (Honor, Pakaian dll)"}, {"kode": "02.01.02.","nama": "Dukungan Penyelenggaraan PAUD (APE, Sarana PAUD dst)"}, {"kode": "02.01.03.","nama": "Penyuluhan dan Pelatihan Pendidikan Bagi Masyarakat"}, {"kode": "02.01.04.","nama": "Pemeliharaan Sarana Prasarana Perpustakaan/Taman Bacaan/Sanggar Belajar Milik Desa"}, {"kode": "02.01.05.","nama": "Pemeliharaan Sarana Prasarana PAUD/TK/Î¤Î¡Î‘/Î¤ÎšÎ‘/TPQ/Madrasah Non-formal Milik Desa"}, {"kode": "02.01.06.","nama": "Pembangunan/Rehabilitasi/Peningkatan/Pengadaan Sarana/Prasarana/Alat Peraga PAUD/TK/TPA/Î¤ÎšÎ‘/TPQ/M"}, {"kode": "02.01.07.","nama": "Pembangunan/Rehabilitasi/Peningkatan Sarana/Prasarana Perpustakaan/Taman Bacaan Desa/ Sanggar Belaja"}, {"kode": "02.01.08.","nama": "Pengelolaan Perpustakaan Milik Desa (Pengadaan Buku, Honor, Taman Baca)"}, {"kode": "02.01.09.","nama": "Pengembangan dan Pembinaan Sanggar Seni dan Belajar"}, {"kode": "02.01.10.","nama": "Dukungan Pendidikan bagi Siswa Miskin/Berprestasi"}]}, {"kode": "02.02.","nama": "Sub Bidang Kesehatan","kegiatan": [{"kode": "02.02.01.","nama": "Penyelenggaraan Pos Kesehatan Desa/Polindes Milik Desa (obat, Insentif, KB, dsb)"}, {"kode": "02.02.02.","nama": "Penyelenggaraan Posyandu (Makanan Tambahan, Kelas Bumil, Lansia, Insentif)"}, {"kode": "02.02.03.","nama": "Penyuluhan dan Pelatihan Bidang Kesehatan (Untuk Masyarakat, Tenaga dan Kader Kesehatan dil)"}, {"kode": "02.02.04.","nama": "Penyelenggaraan Desa Siaga Kesehatan"}, {"kode": "02.02.05.","nama": "Pembinaan Palang Merah Remaja (PMR) Tingkat Desa"}, {"kode": "02.02.06.","nama": "Pengasuhan Bersama atau Bina Keluarga Balita (BKB)"}, {"kode": "02.02.07.","nama": "Pembinaan dan Pengawasan Upaya Kesehatan Tradisional"}, {"kode": "02.02.08.","nama": "Pemeliharaan Sarana Prasarana Posyandu/Polindes/PKD"}, {"kode": "02.02.09.","nama": "Pembangunan/Rehabilitasi/Peningkatan/Pengadaan Sarana/Prasarana Posyandu/Polindes/PKD **"}]}, {"kode": "02.03.","nama": "Sub Bidang Pekerjaan Umum dan Penataan Ruang","kegiatan": [{"kode": "02.03.01.","nama": "Pemeliharaan Jalan Desa"}, {"kode": "02.03.02.","nama": "Pemeliharaan Jalan Lingkungan Pemukiman/Gang"}, {"kode": "02.03.03.","nama": "Pemeliharaan Jalan Usaha Tani"}, {"kode": "02.03.04.","nama": "Pemeliharaan Jembatan Desa"}, {"kode": "02.03.05.","nama": "Pemeliharaan Prasarana Jalan Desa (Gorong-gorong/Selokan/Parit/Drainase dll)"}, {"kode": "02.03.06.","nama": "Pemeliharaan Gedung/Prasarana Balai Desa/Balai Kemasyarakatan"}, {"kode": "02.03.07.","nama": "Pemeliharaan Pemakaman /Situs Bersejarah/Petilasan Milik Desa"}, {"kode": "02.03.08.","nama": "Pemeliharaan Embung Milik Desa"}, {"kode": "02.03.09.","nama": "Pemeliharaan Monumen/Gapura/Batas Desa"}, {"kode": "02.03.10.","nama": "Pembangunan/Rehabilitas/Peningkatan/Pengerasan Jalan Desa **)"}, {"kode": "02.03.11.","nama": "Pembangunan/Rehabilitasi/Peningkatan/Pengerasan Jalan Lingkungan Permukiman **)"}, {"kode": "02.03.12.","nama": "Pembangunan/Rehabilitasi/Peningkatan/Pengerasan Jalan Usaha Tani **)"}, {"kode": "02.03.13.","nama": "Pembangunan/Rehabilitasi/Peningkatan/Pengerasan Jembatan Milik Desa **)"}, {"kode": "02.03.14.","nama": "Pembangunan/Rehabilitasi/Peningkatan Prasarana Jalan Desa (Gorong, selokan dll)"}, {"kode": "02.03.15.","nama": "Pembangunan/Rehabilitasi/Peningkatan Balai Desa/Balai Kemasyarakatan **)"}, {"kode": "02.03.16.","nama": "Pembangunan/Rehabilitasi/Peningkatan Pemakaman Milik Desa/Situs Bersejarah Milik Desa/Petilasan"}, {"kode": "02.03.17.","nama": "Pembuatan/Pemutakhiran Peta Wilayah dan Sosial Desa **)"}, {"kode": "02.03.18.","nama": "Penyusunan Dokumen Perencanaan Tata Ruang Desa"}, {"kode": "02.03.19.","nama": "Pembangunan/Rehabilitasi/Peningkatan Embung Desa **)"}, {"kode": "02.03.20.","nama": "Pembangunan/Rehabilitasi/Peningkatan Monumen/Gapura/Batas Desa **)"}]}, {"kode": "02.04.","nama": "Sub Bidang Kawasan Pemukiman","kegiatan": [{"kode": "02.04.01.","nama": "Dukungan Pelaksanaan Program Pembangunan/Rehab Rumah Tidak Layak Huni GAKIN"}, {"kode": "02.04.02.","nama": "Pemeliharaan Sumur Resapan Milik Desa"}, {"kode": "02.04.03.","nama": "Pemeliharaan Sumber Air Bersih Milik Desa (Mata Air, Penampung Air, Sumur Bor dll)"}, {"kode": "02.04.04.","nama": "Pemeliharaan Sambungan Air Bersih ke Rumah Tangga (Pipanisasi dll)"}, {"kode": "02.04.05.","nama": "Pemeliharaan Sanitasi Pemukiman (Gorong-gorong, Selokan, Parit diluar Prasarana Jalan))"}, {"kode": "02.04.06.","nama": "Pemeliharaan Fasilitas Jamban Umum/MCK Umum dil"}, {"kode": "02.04.07.","nama": "Pemeliharaan Fasilitas Pengelolaan Sampah Desa (Penampungan, Bank Sampah, dll)"}, {"kode": "02.04.08.","nama": "Pemeliharaan Sistem Pembuangan Air Limbah (Drainase, Air limbah Rumah Tangga)"}, {"kode": "02.04.09.","nama": "Pemeliharaan Taman/Taman Bermain Anak Milik Desa"}, {"kode": "02.04.10.","nama": "Pembangunan/Rehabilitasi/Peningkatan Sumur Resapan **)"}, {"kode": "02.04.11.","nama": "Pembangunan/Rehabilitasi/Peningkatan Sumber Air Bersih Milik Desa **)"}, {"kode": "02.04.12.","nama": "Pembangunan/Rehabilitasi/Peningkatan Sambungan Air Bersih ke Rumah Tangga **)"}, {"kode": "02.04.13.","nama": "Pembangunan/Rehabilitasi/Peningkatan Sanitasi Permukiman **)"}, {"kode": "02.04.14.","nama": "Pembangunan/Rehabilitasi/Peningkatan Fasilitas Jamban Umum/MCK umum, dll **)"}, {"kode": "02.04.15.","nama": "Pembangunan/Rehabilitasi/Peningkatan Fasilitas Pengelolaan Sampah **)"}, {"kode": "02.04.16.","nama": "Pembangunan/Rehabilitasi/Peningkatan Sistem Pembuangan Air Limbah **)"}, {"kode": "02.04.17.","nama": "Pembangunan/Rehabilitasi/Peningkatan Taman/Taman Bermain Anak Milik Desa **)"}]}, {"kode": "02.05.","nama": "Sub Bidang Kehutanan dan Lingkungan Hidup","kegiatan": [{"kode": "02.05.01.","nama": "Pengelolaan Hutan Milik Desa"}, {"kode": "02.05.02.","nama": "Pengelolaan Lingkungan Hidup Milik Desa"}, {"kode": "02.05.03.","nama": "Pelatihan/Sosialisasi/Penyuluhan/Penyadaran tentang LH danKehutanan **)"}]}, {"kode": "02.06.","nama": "Sub Bidang Perhubungan, Komunikasi dan Informatika","kegiatan": [{"kode": "02.06.01.","nama": "Pembuatan Rambu-rambu di Jalan Desa"}, {"kode": "02.06.02.","nama": "Penyelenggaraan Informasi Publik Desa (Poster, Baliho DII)"}, {"kode": "02.06.03.","nama": "Pengelolaan dan Pembuatan Jaringan/Instalasi Komunikasi dan Informasi Lokal Desa"}, {"kode": "02.06.04.","nama": "Pemeliharaan Sarana dan Prasarana Transportasi Desa"}, {"kode": "02.06.05.","nama": "Pembangunan/Rehabilitasi/Peningkatan/Pengadaan Sarana & Prasarana Transportasi Desa"}, {"kode": "02.06.90.","nama": "Penyelenggaraan Expo Pembangunan Desa"}]}, {"kode": "02.07.","nama": "Sub Bidang Energi dan Sumberdaya Mineral","kegiatan": [{"kode": "02.07.01.","nama": "Pemeliharaan Sarana dan Prasarana Energi Alternatif Tingkat Desa"}, {"kode": "02.07.02.","nama": "Pembangunan/Rehabilitasi/Peningkatan Sarana & Prasarana Energi Alternatif Desa"}]}, {"kode": "02.08.","nama": "Sub Bidang Pariwisata","kegiatan": [{"kode": "02.08.01.","nama": "Pemeliharaan Sarana dan Prasarana Pariwisata Milik Desa"}, {"kode": "02.08.02.","nama": "Pembangunan/Rehabilitasi/Peningkatan Sarana dan Prasarana Pariwisata Milik **)"}, {"kode": "02.08.03.","nama": "Pengembangan Pariwisata Tingkat Desa"}]}]}, {"kode": "03","nama": "BIDANG PEMBINAAN KEMASYARAKATAN","subBidang": [{"kode": "03.01.","nama": "Sub Bidang Ketenteraman, Ketertiban Umum dan Perlindungan Masyarakat","kegiatan": [{"kode": "03.01.01.","nama": "Pengadaan/Penyelenggaraan Pos Keamanan Desa"}, {"kode": "03.01.02.","nama": "Penguatan & Peningkatan Kapasitas Tenaga Keamanan/Ketertiban oleh Pemdes"}, {"kode": "03.01.03.","nama": "Koordinasi Pembinaan Keamanan, Ketertiban & Perlindungan Masy. Skala Lokal Desa"}, {"kode": "03.01.04.","nama": "Persiapan Kesiapsiagaan/Tanggap Bencana Skala Lokal Desa"}, {"kode": "03.01.05.","nama": "Penyediaan Pos Kesiapsiagaan Bencana Skala Lokal Desa"}, {"kode": "03.01.06.","nama": "Bantuan Hukum Untuk Aparatur Desa dan Masyarakat Miskin"}, {"kode": "03.01.07.","nama": "Pelatihan/Penyuluhan/Sosialisasi kepada Masy. di Bid. Hukum & Pelindungan Masy."}]}, {"kode": "03.02.","nama": "Sub Bidang Kebudayaan dan Keagamaan","kegiatan": [{"kode": "03.02.01.","nama": "Pembinaan Group Kesenian dan Kebudayaan Tingkat Desa"}, {"kode": "03.02.02.","nama": "Pengiriman Kontingen Group Kesenian & Kebudayaan (Wakil Desa tkt. Kec/Kab/Kot)"}, {"kode": "03.02.03.","nama": "Penyelenggaraan Festival Kesenian, Adat/Kebudayaan, dan Keagamaan (HUT RI, Raya Keagamaan dil)"}, {"kode": "03.02.04.","nama": "Pemeliharaan Sarana Prasarana Kebudayaan, Rumah Adat dan Keagamaan Milik Desa"}, {"kode": "03.02.05.","nama": "Pembangunan/Rehabilitasi Sarana Prasarana Kebudayaan/Rumah Adat/Kegamaan Milik Desa **)"}]}, {"kode": "03.03.","nama": "Sub Bidang Kepemudaan dan Olahraga","kegiatan": [{"kode": "03.03.01.","nama": "Pengiriman Kontingen Kepemudaan & Olahraga Sebagai Wakil Desa tkt Kec/Kab/Kota"}, {"kode": "03.03.02.","nama": "Penyelenggaraan Pelatihan Kepemudaan Tingkat Desa"}, {"kode": "03.03.03.","nama": "Penyelenggaraan Festival/Lomba Kepemudaan dan Olahraga Tingkat Desa"}, {"kode": "03.03.04.","nama": "Pemeliharaan Sarana dan Prasarana Kepemudaan dan Olahraga Milik Desa"}, {"kode": "03.03.05.","nama": "Pembangunan/Rehabilitasi/Peningkatan Sarana dan Prasarana Kepemudaan & Olahraga Milik Desa"}, {"kode": "03.03.06.","nama": "Pembinaan Karang Taruna/Klub Kepemudaan/Olahraga Tingkat Desa"}]}, {"kode": "03.04.","nama": "Sub Bidang Kelembagaan Masyarakat","kegiatan": [{"kode": "03.04.01.","nama": "Pembinaan Lembaga Adat"}, {"kode": "03.04.02.","nama": "Pembinaan LKMD/LPM/LPMD"}, {"kode": "03.04.03.","nama": "Pembinaan PKK"}, {"kode": "03.04.04.","nama": "Pelatihan Pembinaan Lembaga Kemasyarakatan"}, {"kode": "03.04.90.","nama": "Penyelenggaraan Balai Mediasi"}]}]}, {"kode": "04","nama": "BIDANG PEMBERDAYAAN MASYARAKAT","subBidang": [{"kode": "04.01.","nama": "Sub Bidang Kelautan dan Perikanan","kegiatan": [{"kode": "04.01.01.","nama": "Pemeliharaan Karamba/Kolam Perikanan Darat Milik Desa"}, {"kode": "04.01.02.","nama": "Pemeliharaan Pelabuhan Perikanan Sungai/Kecil Milik Desa"}, {"kode": "04.01.03.","nama": "Pembangunan/Rehabilitasi/Peningkatan Karamba/Kolam Perikanan Darat Milik Desa"}, {"kode": "04.01.04.","nama": "Pembangunan/Rehabilitasi/Peningkatan Pelabuhan Perikanan Sungai/Kecil Milik Desa"}, {"kode": "04.01.05.","nama": "Bantuan Perikanan (Bibit/Pakan/dll)"}, {"kode": "04.01.06.","nama": "Bimtek/Pelatihan/Pengenalan TTG untuk Perikanan Darat/Nelayan **)"}, {"kode": "04.01.90.","nama": "Pelatihan Pengolahan Hasil Perikanan / Kelautan"}, {"kode": "04.01.91.","nama": "Peningkatan Produksi Kelautan"}]}, {"kode": "04.02.","nama": "Sub Bidang Pertanian dan Peternakan","kegiatan": [{"kode": "04.02.01.","nama": "Peningkatan Produksi Tanaman Pangan (alat produksi/pengelolaan/penggilingan)"}, {"kode": "04.02.02.","nama": "Peningkatan Produksi Peternakan (alat produksi/pengelolaan/kandang)"}, {"kode": "04.02.03.","nama": "Penguatan Ketahanan Pangan Tingkat Desa (Lumbung Desa dll)"}, {"kode": "04.02.04.","nama": "Pemeliharaan Saluran Irigasi Tersier/Sederhana"}, {"kode": "04.02.05.","nama": "Pelatihan/Bimtek/Pengenalan Teknologi Tepat Guna untuk Pertanian/Peternakan"}, {"kode": "04.02.06.","nama": "Pembangunan/Rehabilitasi/Peningkatan Saluran Irigasi Tersier/Sederhana"}, {"kode": "04.02.90.","nama": "Pembangunan/ Rehabilitasi Sarana dan Prasarana Pembenihan"}, {"kode": "04.02.91.","nama": "Pelatihan Pengolahan Hasil Pertanian/Peternakan"}]}, {"kode": "04.03.","nama": "Sub Bidang Peningkatan Kapasitas Aparatur Desa","kegiatan": [{"kode": "04.03.01.","nama": "Peningkatan Kapasitas Kepala Desa"}, {"kode": "04.03.02.","nama": "Peningkatan Kapasitas Perangkat Desa"}, {"kode": "04.03.03.","nama": "Peningkatan Kapasitas BPD"}, {"kode": "04.03.90.","nama": "Study Banding/Pelatihan"}]}, {"kode": "04.04.","nama": "Sub Bidang Pemberdayaan Perempuan, Perlindungan Anak dan Keluarga","kegiatan": [{"kode": "04.04.01.","nama": "Pelatihan dan Penyuluhan Pemberdayaan Perempuan"}, {"kode": "04.04.02.","nama": "Pelatihan dan Penyuluhan Perlindungan Anak"}, {"kode": "04.04.03.","nama": "Pelatihan dan Penguatan Penyandang Difabel (Penyandang Disabilitas)"}, {"kode": "04.04.90.","nama": "Penguatan Hak Identitas Bagi Anak/ Perempuan"}, {"kode": "04.04.91.","nama": "Penyelenggaraan Desa Layak Anak"}, {"kode": "04.04.92.","nama": "Pemberdayaan Perempuan Melalui PKK"}, {"kode": "04.04.93.","nama": "Pelatihan / Penyuluhan Bagi Tenaga Kerja Perempuan"}]}, {"kode": "04.05.","nama": "Sub Bidang Koperasi, Usaha Micro Kecil dan Menengah (UMKM)","kegiatan": [{"kode": "04.05.01.","nama": "Pelatihan Manajemen Koperasi/KUD/UMKM"}, {"kode": "04.05.02.","nama": "Pengembangan Sarana Prasarana Usaha Mikro, Kecil, Menengah dan Koperasi"}, {"kode": "04.05.03.","nama": "Pengadaan Teknologi Tepat Guna Untuk Pengembangan Ekonomi Pedesaan Non Pertanian"}]}, {"kode": "04.06.","nama": "Sub Bidang Dukungan Penanaman Modal","kegiatan": [{"kode": "04.06.01.","nama": "Pembentukan BUM Desa (Persiapan dan Pembentukan Awal BUMDesa)"}, {"kode": "04.06.02.","nama": "Pelatihan Pengelolaan BUM Desa (Pelatihan yg dilaksanakan oleh Pemdes)"}]}, {"kode": "04.07.","nama": "Sub Bidang Perdagangan dan Perindustrian","kegiatan": [{"kode": "04.07.01.","nama": "Pemeliharaan Pasar Desa/Kios Milik Desa"}, {"kode": "04.07.02.","nama": "Pembangunan/Rehab Pasar Desa/Kios Milik Desa"}, {"kode": "04.07.03.","nama": "Pengembangan Industri Kecil Tingkat Desa"}, {"kode": "04.07.04.","nama": "Pembentukan/Fasilitasi/Pelatihan/Pendampingan kelompok usaha ekonomi produktif"}]}]}, {"kode": "05","nama": "BIDANG PENANGGULANGAN BENCANA, DARURAT DAN MENDESAK DESA","subBidang": [{"kode": "05.01.","nama": "Sub Bidang Penanggulangan Bencana","kegiatan": [{"kode": "05.01.00.","nama": "Kegiatan Penanggulangan Bencana"}]}, {"kode": "05.02.","nama": "Sub Bidang Keadaan Darurat","kegiatan": [{"kode": "05.02.00.","nama": "Penanganan Keadaan Darurat"}]}, {"kode": "05.03.","nama": "Sub Bidang Keadaan Mendesak","kegiatan": [{"kode": "05.03.00.","nama": "Penanganan Keadaan Mendesak"}]}]}];

// PERBAIKAN: Mengubah struktur BELANJA_ACCOUNTS agar sesuai dengan 3 level (Jenis, Objek, dan Rincian Obyek Kustom)
const BELANJA_ACCOUNTS = [
    // === 5.1 Belanja Pegawai (DILENGKAPI) ===
    {kode: "5.1", nama: "Belanja Pegawai", jenis: [
        {kode: "5.1.1", nama: "Penghasilan Tetap dan Tunjangan Kepala Desa", obyek: [
            {kode: "5.1.1.01", nama: "Penghasilan Tetap Kepala Desa"}, 
            {kode: "5.1.1.02", nama: "Tunjangan Kepala Desa"}, 
            {kode: "5.1.1.99", nama: "Penerimaan Lain-lain Kepala Desa yang Sah"}
        ]},
        {kode: "5.1.2", nama: "Penghasilan Tetap dan Tunjangan Perangkat Desa", obyek: [
            {kode: "5.1.2.01", nama: "Penghasilan Tetap Perangkat Desa"}, 
            {kode: "5.1.2.02", nama: "Tunjangan Perangkat Desa"}, 
            {kode: "5.1.2.99", nama: "Penerimaan Lain-lain Perangkat Desa yang Sah"}
        ]},
        {kode: "5.1.3", nama: "Jaminan Sosial Kepala Desa dan Perangkat Desa", obyek: [
            {kode: "5.1.3.01", nama: "Jaminan Kesehatan Kepala Desa"}, 
            {kode: "5.1.3.02", nama: "Jaminan Kesehatan Perangkat Desa"}, 
            {kode: "5.1.3.03", nama: "Jaminan Ketenagakerjaan Kepala Desa"}, 
            {kode: "5.1.3.04", nama: "Jaminan Ketenagakerjaan Perangkat Desa"}
        ]},
        {kode: "5.1.4", nama: "Tunjangan BPD", obyek: [
            {kode: "5.1.4.01", nama: "Tunjangan Kedudukan BPD"}, 
            {kode: "5.1.4.02", nama: "Tunjangan Kinerja BPD"},
            {kode: "5.1.4.90", nama: "Tunjangan Jaminan Kesehatan BPD"}, 
            {kode: "5.1.4.91", nama: "Tunjangan Jaminan Ketenagakerjaan BPD"}
        ]}
    ]},
    
    // === 5.2 Belanja Barang dan Jasa (DILENGKAPI DARI OCR) ===
    {kode: "5.2", nama: "Belanja Barang dan Jasa", jenis: [
        {kode: "5.2.1", nama: "Belanja Barang Perlengkapan", obyek: [
            {kode: "5.2.1.01", nama: "Belanja Alat Tulis Kantor dan Benda Pos"}, 
            {kode: "5.2.1.02", nama: "Belanja Perlengkapan Alat-alat Listrik"}, 
            {kode: "5.2.1.03", nama: "Belanja Perlengkapan Alat Rumah Tangga dan Bahan Kebersihan"},
            {kode: "5.2.1.04", nama: "Belanja Bahan Bakar Minyak/Gas/Isi Ulang Tabung Pemadam Kebakaran"},
            {kode: "5.2.1.05", nama: "Belanja Barang Cetak dan Penggandaan"}, 
            {kode: "5.2.1.06", nama: "Belanja Barang Konsumsi (Makan/Minum)"},
            {kode: "5.2.1.07", nama: "Belanja Bahan Material"}, 
            {kode: "5.2.1.08", nama: "Belanja Bendera/Umbul-umbul/Spanduk"},
            {kode: "5.2.1.09", nama: "Belanja Pakaian Dinas/Seragam/Atribut"}, 
            {kode: "5.2.1.10", nama: "Belanja Bahan Obat-obatan"},
            {kode: "5.2.1.11", nama: "Belanja Pakan Hewan, Obat-obatan Hewan"}, 
            {kode: "5.2.1.12", nama: "Belanja Pupuk/Obat-obatan Pertanian"},
            {kode: "5.2.1.90", nama: "Belanja Hadiah"}, 
            {kode: "5.2.1.99", nama: "Belanja Barang Perlengkapan Lainnya"}
        ]},
        {kode: "5.2.2", nama: "Belanja Jasa Honorarium", obyek: [
            {kode: "5.2.2.01", nama: "Belanja Jasa Honorarium Tim Pelaksana Kegiatan"}, 
            {kode: "5.2.2.02", nama: "Belanja Jasa Honorarium Pembantu Tugas Umum Desa/Operator"}, 
            {kode: "5.2.2.03", nama: "Belanja Jasa Honorarium/Insentif Pelayanan Desa"},
            {kode: "5.2.2.04", nama: "Belanja Jasa Honorarium Tenaga Ahli/Profesi/Konsultan/Narasumber"},
            {kode: "5.2.2.05", nama: "Belanja Jasa Honorarium Petugas"}, 
            {kode: "5.2.2.06", nama: "Belanja Jasa Honorarium PKPKD dan PPKD"},
            {kode: "5.2.2.07", nama: "Belanja Jasa Honorarium Staf Administrasi BPD"},
            {kode: "5.2.2.08", nama: "Belanja Jasa Uang Saku Pelatihan/Seminar/Bimbingan Teknis"},
            {kode: "5.2.2.99", nama: "Belanja Jasa Honorarium Lainnya"}
        ]},
        {kode: "5.2.3", nama: "Belanja Perjalanan Dinas", obyek: [
            {kode: "5.2.3.01", nama: "Belanja Perjalanan Dinas Dalam Kabupaten/Kota"}, 
            {kode: "5.2.3.02", nama: "Belanja Perjalanan Dinas Luar Kabupaten/Kota"},
            {kode: "5.2.3.03", nama: "Belanja Kursus Pelatihan"} 
        ]},
        {kode: "5.2.4", nama: "Belanja Jasa Sewa", obyek: [
            {kode: "5.2.4.01", nama: "Belanja Jasa Sewa Bangunan/Gedung/Ruang"}, 
            {kode: "5.2.4.02", nama: "Belanja Jasa Sewa Peralatan/Perlengkapan"}, 
            {kode: "5.2.4.03", nama: "Belanja Jasa Sewa Sarana Mobilitas"},
            {kode: "5.2.4.99", nama: "Belanja Jasa Sewa Lainnya"}
        ]},
        {kode: "5.2.5", nama: "Belanja Operasional Perkantoran", obyek: [
            {kode: "5.2.5.01", nama: "Belanja Jasa Langganan Listrik"}, 
            {kode: "5.2.5.02", nama: "Belanja Jasa Langganan Air Bersih"}, 
            {kode: "5.2.5.03", nama: "Belanja Jasa Langganan Majalah/Surat Kabar"},
            {kode: "5.2.5.04", nama: "Belanja Jasa Langganan Telepon"},
            {kode: "5.2.5.05", nama: "Belanja Jasa Langganan Internet"},
            {kode: "5.2.5.06", nama: "Belanja Jasa Kurir/Pos/Giro"},
            {kode: "5.2.5.07", nama: "Belanja Jasa Perpanjangan Ijin/Pajak"},
            {kode: "5.2.5.08", nama: "Belanja Insentif/Operasional RT/RW"},
            {kode: "5.2.5.90", nama: "Belanja Jasa Publikasi"},
            {kode: "5.2.5.91", nama: "Belanja iuran Jaminan Kesehatan Staf Desa"},
            {kode: "5.2.5.92", nama: "Belanja iuran Jaminan Ketenagakerjaan Staf Desa"},
            {kode: "5.2.5.93", nama: "Belanja Iuran Jaminan Ketenagakerjaan Anggota LKD"},
            {kode: "5.2.5.99", nama: "Belanja Operasional Perkantoran lainnya"}
        ]},
        {kode: "5.2.6", nama: "Belanja Pemeliharaan", obyek: [
            {kode: "5.2.6.01", nama: "Belanja Pemeliharaan Mesin dan Peralatan Berat"},
            {kode: "5.2.6.02", nama: "Belanja Pemeliharaan Kendaraan Bermotor"},
            {kode: "5.2.6.03", nama: "Belanja Pemeliharaan Peralatan"},
            {kode: "5.2.6.04", nama: "Belanja Pemeliharaan Bangunan"},
            {kode: "5.2.6.05", nama: "Belanja Pemeliharaan Jalan"},
            {kode: "5.2.6.06", nama: "Belanja Pemeliharaan Jembatan"},
            {kode: "5.2.6.07", nama: "Belanja Pemeliharaan Irigasi/Saluran Sungai/Embung/Air Bersih"},
            {kode: "5.2.6.08", nama: "Belanja Pemeliharaan Jaringan dan Instalasi (Listrik, telepon, internet, komunikasi dll)"},
            {kode: "5.2.6.99", nama: "Belanja Pemeliharaan Lainnya"}
        ]},
        {kode: "5.2.7", nama: "Belanja Barang dan Jasa yang Diserahkan kepada Masyarakat", obyek: [
            {kode: "5.2.7.01", nama: "Belanja Bahan Perlengkapan untuk Diserahkan kepada Masyarakat"},
            {kode: "5.2.7.02", nama: "Belanja Bantuan Mesin/Peralatan/Kendaraan untuk Diserahkan kepada Masyarakat"},
            {kode: "5.2.7.03", nama: "Belanja Bantuan Bangunan untuk Diserahkan kepada Masyarakat"},
            {kode: "5.2.7.04", nama: "Belanja Beasiswa Berprestasi/Masyarakat Miskin"},
            {kode: "5.2.7.05", nama: "Belanja Bantuan Bibit Tanaman/Hewan/Ikan"},
            {kode: "5.2.7.99", nama: "Belanja Barang untuk Diserahkan kepada Masyarakat Lainnya"}
        ]}
    ]},
    
    // === 5.3 Belanja Modal (DILENGKAPI DARI OCR) ===
    {kode: "5.3", nama: "Belanja Modal", jenis: [
        {kode: "5.3.1", nama: "Belanja Modal Pengadaan Tanah", obyek: [
            {kode: "5.3.1.01", nama: "Belanja Modal Pembebasan/Pembelian Tanah"},
            {kode: "5.3.1.02", nama: "Belanja Modal Pembayaran Honorarium Tim Tanah"},
            {kode: "5.3.1.03", nama: "Belanja Modal Pengukuran dan Pembuatan Sertifikat Tanah"},
            {kode: "5.3.1.04", nama: "Belanja Modal Pengurukan dan Pematangan Tanah"},
            {kode: "5.3.1.05", nama: "Belanja Modal Perjalanan Pengadaan Tanah"},
            {kode: "5.3.1.99", nama: "Belanja Modal Pengadaan Tanah Lainnya"}
        ]},
        {kode: "5.3.2", nama: "Belanja Modal Peralatan dan Mesin", obyek: [
            {kode: "5.3.2.01", nama: "Belanja Modal Pembayaran Honor Tim Pelaksana Kegiatan (PM)"}, 
            {kode: "5.3.2.02", nama: "Belanja Modal Peralatan Elektronik dan Alat Studio"},
            {kode: "5.3.2.03", nama: "Belanja Modal Peralatan Komputer"},
            {kode: "5.3.2.04", nama: "Belanja Modal Peralatan Mebelair dan Aksesoris Ruangan"},
            {kode: "5.3.2.05", nama: "Belanja Modal Peralatan Dapur"},
            {kode: "5.3.2.06", nama: "Belanja Modal Peralatan Alat Ukur"},
            {kode: "5.3.2.07", nama: "Belanja Modal Peralatan Rambu-rambu/Patok Tanah"},
            {kode: "5.3.2.08", nama: "Belanja Modal Peralatan Khusus Kesehatan"},
            {kode: "5.3.2.09", nama: "Belanja Modal Peralatan Khusus Pertanian/Peternakan/Perikanan"},
            {kode: "5.3.2.10", nama: "Belanja Modal Mesin"},
            {kode: "5.3.2.11", nama: "Belanja Modal Pengadaan Alat-alat Berat"},
            {kode: "5.3.2.99", nama: "Belanja Modal Peralatan, Mesin dan Alat Berat Lainnya"}
        ]},
        {kode: "5.3.3", nama: "Belanja Modal Kendaraan", obyek: [
            {kode: "5.3.3.01", nama: "Belanja Modal Honor Tim Pengadaan (Kendaraan)"}, 
            {kode: "5.3.3.02", nama: "Belanja Modal Kendaraan Darat Bermotor"},
            {kode: "5.3.3.03", nama: "Belanja Modal Kendaaraan Darat Tidak Bermotor"},
            {kode: "5.3.3.04", nama: "Belanja Modal Kendaraan Air Bermotor"},
            {kode: "5.3.3.05", nama: "Belanja Modal Kendaraan Air Tidak Bermotor"},
            {kode: "5.3.3.99", nama: "Belanja Modal Kendaraan Lainnya"}
        ]},
        {kode: "5.3.4", nama: "Belanja Modal Gedung, Bangunan dan Taman", obyek: [
            {kode: "5.3.4.01", nama: "Belanja Modal Gedung, Bangunan, Taman - Honor Pelaksana Kegiatan"}, 
            {kode: "5.3.4.02", nama: "Belanja Modal Gedung, Bangunan, Taman - Upah Tenaga Kerja"},
            {kode: "5.3.4.03", nama: "Belanja Modal Gedung, Bangunan, Taman - Bahan Baku/Material"},
            {kode: "5.3.4.04", nama: "Belanja Modal Gedung, Bangunan, Taman - Sewa Peralatan"},
            {kode: "5.3.4.05", nama: "Belanja Modal Gedung, Bangunan, Taman - Administrasi Kegiatan"}
        ]},
        {kode: "5.3.5", nama: "Belanja Modal Jalan/Prasarana Jalan", obyek: [
            {kode: "5.3.5.01", nama: "Belanja Modal Jalan - Honor Tim Pelaksana Kegiatan"}, 
            {kode: "5.3.5.02", nama: "Belanja Modal Jalan - Upah Tenaga Kerja"},
            {kode: "5.3.5.03", nama: "Belanja Modal Jalan - Bahan Baku/Material"},
            {kode: "5.3.5.04", nama: "Belanja Modal Jalan - Sewa Peralatan"},
            {kode: "5.3.5.05", nama: "Belanja Modal Jalan - Administrasi Kegiatan"}
        ]},
        {kode: "5.3.6", nama: "Belanja Modal Jembatan", obyek: [ 
            {kode: "5.3.6.01", nama: "Belanja Modal Jembatan - Honor Pelaksana Kegiatan"},
            {kode: "5.3.6.02", nama: "Belanja Modal Jembatan - Upah Tenaga Kerja"},
            {kode: "5.3.6.03", nama: "Belanja Modal Jembatan - Bahan Baku/Material"},
            {kode: "5.3.6.04", nama: "Belanja Modal Jembatan - Sewa Peralatan"},
            {kode: "5.3.6.05", nama: "Belanja Modal Jembatan - Administrasi Kegiatan"}
        ]},
        {kode: "5.3.7", nama: "Belanja Modal Irigasi/Embung/Drainase/Air Limbah/Persampahan", obyek: [
            {kode: "5.3.7.01", nama: "Belanja Modal Irigasi/Embung/Drainase/dll - Honor Tim Pelaksana Kegiatan"},
            {kode: "5.3.7.02", nama: "Belanja Modal Irigasi/Embung/Drainase/dll - Upah Tenaga Kerja"},
            {kode: "5.3.7.03", nama: "Belanja Modal Irigasi/Embung/Drainase/dll - Bahan Baku/Material"},
            {kode: "5.3.7.04", nama: "Belanja Modal Irigasi/Embung/Drainase/dll - Sewa Peralatan"},
            {kode: "5.3.7.05", nama: "Belanja Modal Irigasi/Embung/Drainase/dll - Administrasi Kegiatan"}
        ]},
        {kode: "5.3.8", nama: "Belanja Modal Jaringan/Instalasi", obyek: [ 
            {kode: "5.3.8.01", nama: "Belanja Modal Jaringan/Instalasi - Honor Tim Pelaksana Kegiatan"},
            {kode: "5.3.8.02", nama: "Belanja Modal Jaringan/Instalasi - Upah Tenaga Kerja"},
            {kode: "5.3.8.03", nama: "Belanja Modal Jaringan/Instalasi - Bahan Baku/Material"},
            {kode: "5.3.8.04", nama: "Belanja Modal Jaringan/Instalasi - Sewa Peralatan"},
            {kode: "5.3.8.05", nama: "Belanja Modal Jaringan/Instalasi - Administrasi Kegiatan"}
        ]},
        {kode: "5.3.9", nama: "Belanja Modal Lainnya", obyek: [
            {kode: "5.3.9.01", nama: "Belanja Khusus Pendidikan dan Perpustakaan"},
            {kode: "5.3.9.02", nama: "Belanja Khusus Olahraga"},
            {kode: "5.3.9.03", nama: "Belanja Modal Khusus Kesenian/Kebudayaan/Keagamaan"},
            {kode: "5.3.9.04", nama: "Belanja Modal Tumbuhan/Tanaman"},
            {kode: "5.3.9.05", nama: "Belanja Modal Hewan"},
            {kode: "5.3.9.99", nama: "Belanja Modal Lainnya"}
        ]}
    ]},
    
    // === 5.4 Belanja Tidak Terduga (DARI OCR Page 10) ===
    {kode: "5.4", nama: "Belanja Tidak Terduga", jenis: [
        {kode: "5.4.1", nama: "Belanja Tidak Terduga", obyek: [
            {kode: "5.4.1.01", nama: "Belanja Tidak Terduga"}
        ]}
    ]}
];

// START NEW: APBDES REVENUE ACCOUNTS (4.x) dari OCR Page 5-6
const APBDES_REVENUE_ACCOUNTS = [
    // 4.1. Pendapatan Asli Desa
    { kode: "4.1", nama: "Pendapatan Asli Desa", jenis: [
        { kode: "4.1.1", nama: "Hasil Usaha Desa" },
        { kode: "4.1.2", nama: "Hasil Aset Desa" },
        { kode: "4.1.3", nama: "Swadaya, Partisipasi dan Gotong Royong" },
        { kode: "4.1.4", nama: "Lain-Lain Pendapatan Asli Desa" }
    ]},
    // 4.2. Pendapatan Transfer
    { kode: "4.2", nama: "Pendapatan Transfer", jenis: [
        { kode: "4.2.1", nama: "Dana Desa" },
        { kode: "4.2.2", nama: "Bagi Hasil Pajak dan Retribusi" },
        { kode: "4.2.3", nama: "Alokasi Dana Desa" },
        { kode: "4.2.4", nama: "Bantuan Keuangan Provinsi" },
        { kode: "4.2.5", nama: "Bantuan Keuangan Kabupaten/Kota" }
    ]},
    // 4.3. Pendapatan Lain-lain
    { kode: "4.3", nama: "Pendapatan Lain-lain", jenis: [
        { kode: "4.3.1", nama: "Penerimaan dari Hasil Kerjasama Antar Desa" },
        { kode: "4.3.2", nama: "Penerimaan dari Hasil Kerjasama dengan Pihak Ketiga" },
        { kode: "4.3.3", nama: "Penerimaan Bantuan dari Perusahaan yang Berlokasi di Desa" },
        { kode: "4.3.4", nama: "Hibah dan Sumbangan dari Pihak Ketiga" },
        { kode: "4.3.5", nama: "Koreksi Kesalahan Belanja Tahun-tahun Sebelumnya" },
        { kode: "4.3.6", nama: "Bunga Bank" },
        { kode: "4.3.9", nama: "Lain-lain pendapatan Desa yang sah" }
    ]}
];
// END NEW: APBDES REVENUE ACCOUNTS

// START NEW: APBDES FINANCING ACCOUNTS (6.x) dari OCR Page 10-11
const APBDES_FINANCING_ACCOUNTS = [
    // 6.1. Penerimaan Pembiayaan
    { kode: "6.1", nama: "Penerimaan Pembiayaan", jenis: [
        { kode: "6.1.1", nama: "SILPA Tahun Sebelumnya" },
        { kode: "6.1.2", nama: "Pencairan Dana Cadangan" },
        { kode: "6.1.3", nama: "Hasil Penjualan Kekayaan Desa Yang Dipisahkan" },
        { kode: "6.1.4", nama: "Penerimaan Kembali Penyertaan Modal" },
        { kode: "6.1.9", nama: "Penerimaan Pembiayaan Lainnya" }
    ]},
    // 6.2. Pengeluaran Pembiayaan
    { kode: "6.2", nama: "Pengeluaran Pembiayaan", jenis: [
        { kode: "6.2.1", nama: "Pembentukan Dana Cadangan" },
        { kode: "6.2.2", nama: "Penyertaan Modal Desa" },
        { kode: "6.2.3", nama: "Setor Kembali Pendapatan Transfer" },
        { kode: "6.2.9", nama: "Pengeluaran Pembiayaan Lainnya" }
    ]}
];
// END NEW

const PARAMETER_KEGIATAN = RAB_PARAMETERS; // PENTING: gunakan RAB_PARAMETERS sebagai sumber kebenasan

/* === GLOBAL VARIABLE & DATA STORAGE (INTEGRATED) === */
let currentFilterYear = new Date().getFullYear();
// NEW: Default professional icon (SVG Data URL)
const DEFAULT_SIPDES_LOGO_SVG = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23e0f2f1" d="M12 15.5a3.5 3.5 0 100-7 3.5 3.5 0 000 7zm1-13.63L13.66 4.1a8.4 8.4 0 011.66 1.1L17.5 4.5l2.12 3.66-2.4 1.4a8.42 8.42 0 010 3.8l2.4 1.41-2.12 3.66-2.18-.77a8.4 8.4 0 01-1.66 1.1L13 21.5V23h-2v-1.5l-.66-1.14a8.4 8.4 0 01-1.66-1.1L6.5 19.5l-2.12-3.66 2.4-1.4a8.42 8.42 0 010-3.8l-2.4-1.41L6.5 4.5l2.18.77a8.4 8.4 0 011.66-1.1L11 2.5V1h2v1.5z"/></svg>';
let desaLogoBase64 = localStorage.getItem('desaLogoBase64') || '';
// NEW: Variabel global untuk filter cepat
let currentModuleFilter = {}; 

let isPrintingMode = false; // <<< PERBAIKAN: FLAG GLOBAL UNTUK MENGONTROL PENCETAKAN LENGKAP

let desaSettings = loadData('desaSettings', {
    namaDesa: 'Contoh',
    namaKecamatan: 'Contoh',
    namaKabupaten: 'Contoh',
    namaProvinsi: 'Contoh', 
    tahunAnggaran: String(currentFilterYear),
    logoDataUrl: '', 
    namaKades: 'Nama Kepala Desa',
    namaSekdes: 'Nama Sekretaris Desa',
    namaKaurRen: 'Nama Kaur Perencanaan', // NEW: Field Kaur Perencanaan
    desaAlamat: 'Jalan Utama',
    desaKodePos: '12345'
});

// Data RAB dan Setting (dari SIPDes-RAB)
let rabData = loadData('rabData', []);
// NEW: Custom PKA List
let customPKAList = loadData('customPKAList', []); 
// NEW: Custom Akun Belanja Obyek
let customObyekAccounts = loadData('customObyekAccounts', []); 

// START: PENAMBAHAN DATA PROFIL DESA & RPJMDes
let profilDesaData = loadData('profilDesaData', {
    visi: 'Visi Desa Default',
    misi: 'Misi Desa Default',
    luasWilayah: '0 Ha',
    jmlPenduduk: 0,
    keterangan: ''
});
// =======================================================================
// === START: PERBAIKAN PADA INISIALISASI RPJMDes =========================
// =======================================================================
// Logika pemuatan data disederhanakan. Hanya satu 'loadData' untuk objek utama.
// Data 'detailRencana' akan termuat sebagai bagian dari objek 'rpjmDesData'.
let rpjmDesData = loadData('rpjmDesData', {
    tahunAwal: new Date().getFullYear(),
    tahunAkhir: new Date().getFullYear() + 7,
    nomorDokumen: '',
    visiMisi: '',
    strategi: '',
    detailRencana: [] // Nilai default jika 'rpjmDesData' belum ada di localStorage
});
// =======================================================================
// === END: PERBAIKAN PADA INISIALISASI RPJMDes ===========================
// =======================================================================


let sipdesAuthData = loadData('sipdesAuthData', null);
let currentRABIndex = -1; 
// NEW: Variabel Global untuk Mode Siskeudes
let currentObyekAkun = ''; 


// Data SIPDes Lainnya (Tetap)
let RealisasiData = JSON.parse(localStorage.getItem('RealisasiData')) || [];
let KekayaanData = JSON.parse(localStorage.getItem('KekayaanData')) || [];
let HasilData = JSON.parse(localStorage.getItem('HasilData') || '[]');
let authenticatedUser = null; 
let UserData = loadData('UserData', []); 

// NEW: Pagination Global Variables (Dihapus/diubah untuk menampilkan semua data)
const rowsPerPage = 9999; // Ditingkatkan untuk menampilkan semua data
let currentPageRkp = 1;
let currentPageRealisasi = 1;
let currentPageRABKegiatan = 1;
let currentPageKekayaan = 1;
let currentPageHasil = 1;

// =======================================================================
// === 2. UTILITY & DATA FUNCTIONS (Load/Save/Hash/Format) ===============
// =======================================================================

// Fungsi Load/Save Data
function loadData(key, defaultValue) {
    try {
        const data = localStorage.getItem(key);
        if (key === 'desaSettings' && data) {
            const parsedData = JSON.parse(data);
            return { ...defaultValue, ...parsedData };
        }
        return data ? JSON.parse(data) : defaultValue;
    } catch (e) {
        console.error("Error loading data from localStorage:", e);
        return defaultValue;
    }
}
function saveData(key, data) {
    try { localStorage.setItem(key, JSON.stringify(data)); } 
    catch (e) { console.error("Error saving data to localStorage:", e); alert("Gagal menyimpan data."); }
}

// Fungsi Hashing SHA-256 (Dari SIPDes-RAB)
async function hashPassword(password) {
  const enc = new TextEncoder();
  const data = enc.encode(password);
  // Pastikan lingkungan mendukung crypto.subtle (tidak akan bekerja di IE atau lingkungan tertentu)
  if (typeof crypto === 'undefined' || !crypto.subtle) {
      return hashPasswordSimple(password);
  }
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}
// Untuk compatibility dengan SIPDes lama (yang menggunakan hash sederhana)
function hashPasswordSimple(password) {
    let hash = 0;
    for (let i = 0; i < password.length; i++) {
        let char = password.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash |= 0;
    }
    return hash.toString();
}


// Fungsi Format Rupiah & Angka (Dari SIPDes-RAB)
function cleanAndParseFloat(value) {
    if (typeof value !== 'string') value = String(value);
    const cleaned = value.replace(/[^0-9,.]/g, '').replace(/\./g, '');
    const floatString = cleaned.replace(/,/g, '.');
    return parseFloat(floatString) || 0;
}

function formatRupiah(angka, isMoney = true) {
    let finalAngka = parseFloat(angka);
    // PERBAIKAN: Mengganti finalAngska menjadi finalAngka
    if (isNaN(finalAngka)) { 
        finalAngka = 0; 
    } 
    
    let decimalPlaces = isMoney ? 2 : (finalAngka % 1 !== 0) ? finalAngka.toString().split('.')[1]?.length || 0 : 0;
    if (decimalPlaces > 2) decimalPlaces = 2; 
    
    let parts = finalAngka.toFixed(decimalPlaces).toString().split('.'); 
    let integerPart = parts[0];
    let decimalPart = parts.length > 1 ? parts[1] : '';

    let sisa = integerPart.length % 3;
    let rupiah = integerPart.substr(0, sisa);
    let ribuan = integerPart.substr(sisa).match(/\d{3}/gi);

    if (ribuan) {
        let separator = sisa ? '.' : '';
        rupiah += separator + ribuan.join('.');
    }
    
    if (decimalPart && parseFloat('0.' + decimalPart) > 0) {
        rupiah = rupiah + ',' + decimalPart;
    } else if (isMoney) {
        rupiah = rupiah + ',00';
    }

    return rupiah || '0';
}

function formatNumberLive(input, isBlur = false) {
    let value = input.value;
    const isMoney = input.id.includes('HargaSatuan') || input.id.includes('anggaran') || input.id.includes('nilai') || input.id.includes('biaya');
    
    value = value.replace(/[^0-9,.]/g, '');
    if (value.startsWith(',') || value.startsWith('.')) { value = "0" + value; }
    value = value.replace(/\./g, '');
    const commaSplit = value.split(',');
    if (commaSplit.length > 2) { value = commaSplit[0] + ',' + commaSplit.slice(1).join(''); }

    if (!isBlur) {
        let cleanFloat = cleanAndParseFloat(value);
        let formattedValue = formatRupiah(cleanFloat, false).replace(/,/g, 'XCOMMAX');
        
        formattedValue = formattedValue.replace(/[^0-9XCOMMAX]/g, '');
        let parts = formattedValue.split('XCOMMAX');
        let integerPart = parts[0] || '0';
        let decimalPart = parts.length > 1 ? parts[1] : '';

        let sisa = integerPart.length % 3;
        let formattedInteger = integerPart.substr(0, sisa);
        let ribuan = integerPart.substr(sisa).match(/\d{3}/gi);

        if (ribuan) {
            let separator = sisa ? '.' : '';
            formattedInteger += separator + ribuan.join('.');
        }
        
        if (decimalPart) { input.value = formattedInteger + ',' + decimalPart; } 
        else if (value.endsWith(',')) { input.value = formattedInteger + ','; } 
        else { input.value = formattedInteger; }

    } else {
        let floatValue = cleanAndParseFloat(value);
        input.value = formatRupiah(floatValue, isMoney);
    }
}

// Fungsi Hitung Total RAB (Dari SIPDes-RAB)
function calculateRABTotal(rab) {
    if (!rab || !rab.detailBelanja || rab.detailBelanja.length === 0) { return 0; }
    return rab.detailBelanja.reduce((total, item) => {
        // PENTING: Gunakan cleanAndParseFloat untuk memastikan perhitungan benar
        return total + (cleanAndParseFloat(item.volume) * cleanAndParseFloat(item.hargaSatuan));
    }, 0);
}

// Fungsi parseAnggaranRaw dari SIPDes_Revisi untuk compatibility
function parseAnggaranRaw(anggaranStr) {
    return cleanAndParseFloat(anggaranStr);
}

// START: PERBAIKAN - Fungsi pembantu untuk update UI
/**
 * Memperbarui konten elemen secara aman, baik itu input atau elemen teks.
 * @param {string} id - ID elemen yang akan diperbarui.
 * @param {string} content - Teks atau nilai yang akan dimasukkan.
 */
function updateElementContent(id, content) {
    const element = document.getElementById(id);
    if (element) {
        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA' || element.tagName === 'SELECT') {
            element.value = content;
        } else {
            element.textContent = content;
        }
    }
}
// END: PERBAIKAN


// =======================================================================
// === 3. AUTHENTICATION FUNCTIONS =======================================
// =======================================================================

async function initializeAuthSystem() {
    if (!sipdesAuthData || !sipdesAuthData.users || sipdesAuthData.users.length === 0) {
        // Fallback or Initial setup for local environment if data is missing
        if (typeof crypto !== 'undefined' && crypto.subtle) {
             const defaultAdminHash = await hashPassword('admin'); 
             const defaultOpHash = await hashPassword('operator');
             UserData = [
                { id: 'admin', username: 'admin', passwordHash: defaultAdminHash, role: 'admin', expirationDate: null }, 
                { id: 'operator', username: 'operator', passwordHash: defaultOpHash, role: 'operator', expirationDate: null }
             ];
        } else {
            // Simple hash for environments without crypto.subtle (e.g., very old browsers, file:// protocol limits)
            const defaultAdminHash = hashPasswordSimple('admin'); 
            const defaultOpHash = hashPasswordSimple('operator');
            UserData = [
                { id: 'admin', username: 'admin', passwordHash: defaultAdminHash, role: 'admin', expirationDate: null }, 
                { id: 'operator', username: 'operator', passwordHash: defaultOpHash, role: 'operator', expirationDate: null }
             ];
        }
        
        sipdesAuthData = { users: UserData, currentUser: null };
        saveData('sipdesAuthData', sipdesAuthData);
        saveData('UserData', UserData); 
    } else {
        UserData = sipdesAuthData.users;
    }

    // NEW: Initialize customPKAList from old desaSettings if it exists and list is empty
    if (customPKAList.length === 0 && desaSettings.namaPKADefault && desaSettings.jabatanPKADefault) {
        customPKAList.push({
            nama: desaSettings.namaPKADefault,
            jabatan: desaSettings.jabatanPKADefault,
            id: 'pka_' + Date.now()
        });
        // Clear old default PKA fields from desaSettings to avoid double saving/confusion
        delete desaSettings.namaPKADefault;
        delete desaSettings.jabatanPKADefault;
        saveData('desaSettings', desaSettings);
        saveData('customPKAList', customPKAList);
    }
}
function updateUIAfterLogin(user) {
    // Logo in sidebar is now handled by updateDesaLogoDisplay()
    // document.getElementById('desa_logo').style.display = 'block'; 
    if (user.role === 'admin') {
        document.getElementById('menu_manajemen_user').classList.remove('app-hidden');
    } else {
        document.getElementById('menu_manajemen_user').classList.add('app-hidden');
    }
    updateDesaLogoDisplay();
    renderSidebarWilayah();
    // Ensure app container is visible after successful login/check
    document.getElementById('app_container').classList.remove('app-hidden');
    document.getElementById('login_overlay').style.display = 'none';
}

async function loginUser() {
    showSplash("Memverifikasi user...");
    const username = document.getElementById('username_input').value;
    const password = document.getElementById('password_input').value;
    const messageElement = document.getElementById('login_message');

    if (!sipdesAuthData || sipdesAuthData.users || sipdesAuthData.users.length === 0) {
        await initializeAuthSystem(); 
    }
    
    let enteredHash;
    try {
         enteredHash = await hashPassword(password);
    } catch(e) {
         enteredHash = hashPasswordSimple(password); // Fallback
    }

    const user = UserData.find(u => u.username.toLowerCase() === username.toLowerCase() && u.passwordHash === enteredHash);
    
    setTimeout(() => {
        if (user) {
            
            // START NEW EXPIRATION CHECK LOGIC
            if (user.expirationDate) {
                const expirationDate = new Date(user.expirationDate);
                const now = new Date();
                
                if (expirationDate < now) {
                    messageElement.textContent = 'Login Gagal. Akun demo ini telah KEDALUWARSA!';
                    document.getElementById('password_input').value = '';
                    hideSplash();
                    return; // Hentikan proses login
                }
            }
            // END NEW EXPIRATION CHECK LOGIC
            
            authenticatedUser = { ...user, id: user.username };
            sessionStorage.setItem('auth_user', JSON.stringify(authenticatedUser));
            sipdesAuthData.currentUser = user.username;
            saveData('sipdesAuthData', sipdesAuthData);
            
            updateUIAfterLogin(authenticatedUser); 
            messageElement.textContent = '';
            restoreLastActiveModule();
            
            const initialModuleId = document.querySelector('.module-content.active').id;
            renderModuleData(initialModuleId);

            hideSplash(() => { alert(`âœ… Selamat datang, ${user.username}!`); });
        } else {
            messageElement.textContent = 'Login Gagal. Username atau Password salah!';
            document.getElementById('password_input').value = '';
            hideSplash();
        }
    }, 700);
}

function logoutUser() {
    showSplash("Logging out...");
    setTimeout(() => {
        authenticatedUser = null;
        sessionStorage.removeItem('auth_user'); 
        
        sipdesAuthData.currentUser = null;
        saveData('sipdesAuthData', sipdesAuthData);

        document.getElementById('login_overlay').style.display = 'flex';
        document.getElementById('app_container').classList.add('app-hidden');
        document.getElementById('username_input').value = '';
        document.getElementById('password_input').value = '';
        document.getElementById('login_message').textContent = '';
        updateDesaLogoDisplay(); 
        hideSplash();
    }, 500);
}

function checkAuthentication(showAlert = true) {
    if (authenticatedUser) {
        updateUIAfterLogin(authenticatedUser);
        return true;
    }

    const storedUser = sessionStorage.getItem('auth_user');
    if (storedUser) {
        try {
            authenticatedUser = JSON.parse(storedUser);
            // Tambahkan pengecekan kedaluwarsa saat restore session
            if (authenticatedUser.expirationDate) {
                const expirationDate = new Date(authenticatedUser.expirationDate);
                const now = new Date();
                if (expirationDate < now) {
                     sessionStorage.removeItem('auth_user');
                     authenticatedUser = null;
                }
            }
            if(authenticatedUser) {
                updateUIAfterLogin(authenticatedUser);
                return true;
            }
        } catch (e) {
            console.error('Gagal memproses data pengguna tersimpan:', e);
            sessionStorage.removeItem('auth_user');
        }
    }

    if (showAlert) {
        document.getElementById('login_overlay').style.display = 'flex';
        document.getElementById('app_container').classList.add('app-hidden');
        authenticatedUser = null;
    }
    return false;
}
function restoreLastActiveModule() {
    const lastModule = localStorage.getItem('lastActiveModule') || 'Dashboard';
    
    document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
    document.querySelectorAll('.module-content').forEach(m => m.classList.remove('active'));
    
    // Check if the last module exists before trying to activate it
    const moduleElement = document.getElementById(lastModule);
    if (moduleElement) {
        moduleElement.classList.add('active');
        const menuItem = Array.from(document.querySelectorAll('.sidebar a'))
            .find(a => a.getAttribute('onclick')?.includes(lastModule));
        if (menuItem) menuItem.classList.add('active');
    } else {
        // Fallback to Dashboard if last module is missing
        document.getElementById('Dashboard').classList.add('active');
        Array.from(document.querySelectorAll('.sidebar a'))
            .find(a => a.getAttribute('onclick')?.includes('Dashboard')).classList.add('active');
    }
}
function showSplash(message) {
    document.getElementById('splash-message').textContent = message || 'Memuat aplikasi...';
    // Use the final logic for logo source
    document.getElementById('splash-logo').src = desaLogoBase64 || DEFAULT_SIPDES_LOGO_SVG; 
    document.getElementById('splash-overlay').style.opacity = '1';
    document.getElementById('splash-overlay').style.display = 'flex';
}
function hideSplash(callback) {
    const splash = document.getElementById('splash-overlay');
    splash.style.opacity = '0';
    setTimeout(() => {
        splash.style.display = 'none';
        if (callback) callback();
    }, 500); 
}


// =======================================================================
// === 4. CORE MODULE LOGIC & RENDERERS ==================================
// =======================================================================

// START: PERBAIKAN - Fungsi updateFilterYearDisplay dibuat lebih aman
function updateFilterYearDisplay() {
    // Menggunakan fungsi pembantu `updateElementContent` untuk menghindari error 'null'
    updateElementContent('filter_year_input', currentFilterYear);

    updateElementContent('dashboard_current_year', currentFilterYear);
    updateElementContent('dashboard_filter_year_label', currentFilterYear);

    updateElementContent('rapbdes_current_year', currentFilterYear);
    updateElementContent('rapbdes_filter_year_label', currentFilterYear);
    updateElementContent('rapbdes_total_year', currentFilterYear);

    updateElementContent('rkp_current_year', currentFilterYear);
    updateElementContent('rkp_filter_year_label', currentFilterYear);
    updateElementContent('rkp_table_year', currentFilterYear);
    
    // Perbaikan untuk modal impor RKP
    updateElementContent('rkp_import_modal_year', currentFilterYear);

    updateElementContent('realisasi_current_year', currentFilterYear);
    updateElementContent('realisasi_filter_year_label', currentFilterYear);
    updateElementContent('realisasi_table_year', currentFilterYear);
    updateElementContent('realisasi_form_year', currentFilterYear);

    updateElementContent('monitoring_current_year', currentFilterYear);
    updateElementContent('monitoring_filter_year_label', currentFilterYear);
    
    updateElementContent('rab_modal_year', currentFilterYear);
    updateElementContent('rab_current_year', currentFilterYear);
    updateElementContent('rab_filter_year_label', currentFilterYear);

    updateElementContent('kekayaan_current_year', currentFilterYear);
    updateElementContent('kekayaan_filter_year_label', currentFilterYear);
    updateElementContent('kekayaan_table_year', currentFilterYear);
    updateElementContent('kekayaan_tahun_perolehan', currentFilterYear);

    updateElementContent('hasil_current_year', currentFilterYear);
    updateElementContent('hasil_filter_year_label', currentFilterYear);
    updateElementContent('hasil_table_year', currentFilterYear);

    desaSettings.tahunAnggaran = String(currentFilterYear);
    saveData('desaSettings', desaSettings);

    const activeModule = document.querySelector('.module-content.active');
    if (activeModule) {
        renderModuleData(activeModule.id);
    }
}
// END: PERBAIKAN

function setFilterYear(year) {
    currentFilterYear = year;
    updateFilterYearDisplay();
}

function renderModuleData(moduleId) {
    if (!checkAuthentication(false)) return;

    switch(moduleId) {
        case 'Dashboard': renderDashboardStats(); break;
        case 'ProfilDesa': renderProfilDesa(); break;
        case 'RPJMDes': renderRPJMDes(); renderRPJMDesDetailTable(); break;
        case 'RancanganAPBDES': renderRapbdesSummary(); renderRapbdesSumberDana(); break;
        case 'RencanaPembangunan': renderRkpTable(); break; 
        case 'KegiatanPembangunan': populateRealisasiRkpDropdown(); clearRealisasiForm(); renderRealisasiTable(); break;
        case 'MonitoringEvaluasi': 
            if (currentModuleFilter[moduleId] && currentModuleFilter[moduleId].status) {
                const filterSelect = document.getElementById('monitoring_status_filter');
                if (filterSelect) {
                    filterSelect.value = currentModuleFilter[moduleId].status;
                }
                currentModuleFilter = {};
            } else {
                 const filterSelect = document.getElementById('monitoring_status_filter');
                 if (filterSelect && !filterSelect.value) filterSelect.value = '';
            }
            renderMonitoringTable(); 
            break;
        case 'RABKegiatanModule': 
            // START: FIX Missing Function Call
            populateRABBidangFilter(document.getElementById('rab_bidang_filter')?.value);
            // END: FIX Missing Function Call
            renderRABKegiatan(); 
            populateBidang(); 
            break;
        case 'RABDetailModule': 
             currentObyekAkun = '';
             renderDetailBelanja(); 
             populateJenisAkun(); 
             populatePKASelect(); 
             break;
        case 'InventarisKekayaan': clearKekayaanForm(); renderInventarisKekayaanTable(); break;
        case 'InventarisHasil': clearHasilForm(); renderInventarisHasilTable(); break;
        case 'LaporanEksporData': renderSidebarWilayah(); loadRABSettings(); break; 
        case 'ManajemenUser': renderUserTable(); clearUserForm(); break;
        case 'PengaturanRAB': loadRABSettings(); break;
    }
}
function showModule(linkElement, moduleId) {
    if (!checkAuthentication()) return;

    if (moduleId === 'ManajemenUser' && authenticatedUser.role !== 'admin') {
        alert('Akses Ditolak: Hanya Admin yang dapat mengakses modul Manajemen Pengguna.');
        const lastActiveModule = localStorage.getItem('lastActiveModule') || 'Dashboard';
        if (lastActiveModule !== 'ManajemenUser') {
             document.getElementById(lastActiveModule).classList.add('active');
             const menuItem = Array.from(document.querySelectorAll('.sidebar a')).find(a => a.getAttribute('onclick')?.includes(lastActiveModule));
             if (menuItem) menuItem.classList.add('active');
             renderModuleData(lastActiveModule);
        } else {
             document.getElementById('Dashboard').classList.add('active');
             Array.from(document.querySelectorAll('.sidebar a')).find(a => a.getAttribute('onclick')?.includes('Dashboard')).classList.add('active');
             renderModuleData('Dashboard');
        }
        return; 
    }

    document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
    if (linkElement) linkElement.classList.add('active');

    document.querySelectorAll('.module-content').forEach(content => content.classList.remove('active'));
    document.getElementById(moduleId).classList.add('active');

    localStorage.setItem('lastActiveModule', moduleId);
    renderSidebarWilayah(); 
    updateFilterYearDisplay();
    renderModuleData(moduleId);
}

// NEW: Quick Jump/Filter Function
function jumpToModuleAndFilter(moduleId, filterStatus = null) {
    currentModuleFilter = {};
    if (filterStatus) {
        currentModuleFilter[moduleId] = { status: filterStatus };
    }
    
    const linkElement = document.querySelector(`.sidebar a[onclick*="${moduleId}"]`);
    if (linkElement) {
        showModule(linkElement, moduleId); 
    } else {
        showModule(null, moduleId);
    }
}

// NEW: Fungsi untuk navigasi cepat dari Ringkasan APBDes ke RKP dengan filter Sumber Dana
function jumpToRkpAndFilterSource(source) {
    currentModuleFilter['RencanaPembangunan'] = { source: source };
    const linkElement = document.querySelector(`.sidebar a[onclick*="RencanaPembangunan"]`);
    showModule(linkElement, 'RencanaPembangunan');
}

// NEW: Fungsi untuk menghapus filter RKP
function clearRkpFilter() {
    delete currentModuleFilter['RencanaPembangunan'];
    const linkElement = document.querySelector(`.sidebar a[onclick*="RencanaPembangunan"]`);
    showModule(linkElement, 'RencanaPembangunan');
}


// 4.1 DASHBOARD
function renderDashboardStats() {
    const RKP = getRKPData();
    const Realisasi = window.RealisasiData || JSON.parse(localStorage.getItem('RealisasiData') || '[]');
    const Kekayaan = window.KekayaanData || JSON.parse(localStorage.getItem('KekayaanData') || '[]');
    const Hasil = window.HasilData || JSON.parse(localStorage.getItem('HasilData') || '[]');

    const filteredRkp = RKP; 
    
    const filteredRkpIds = filteredRkp.map(r => r.id);
    const filteredRealisasi = Realisasi.filter(realisasi => filteredRkpIds.includes(realisasi.rkp_id) && parseInt(realisasi.tahun) === currentFilterYear);

    const rpjmdesCount = rpjmDesData.detailRencana ? rpjmDesData.detailRencana.length : 0;
    document.getElementById('rpjmdes_count').textContent = rpjmdesCount;

    document.getElementById('rkp_count').textContent = filteredRkp.length;
    const totalRkpAnggaran = filteredRkp.reduce((sum, rkp) => sum + cleanAndParseFloat(rkp.anggaran), 0);
    document.getElementById('rkp_total_anggaran').textContent = formatRupiah(totalRkpAnggaran);

    const totalRealisasiAnggaran = filteredRealisasi.reduce((sum, realisasi) => sum + cleanAndParseFloat(realisasi.realisasi_anggaran), 0);
    
    document.getElementById('realisasi_total_anggaran').textContent = formatRupiah(totalRealisasiAnggaran);

    const filteredKekayaan = Kekayaan.filter(k => parseInt(k.tahun_perolehan) === currentFilterYear);
    document.getElementById('kekayaan_count').textContent = filteredKekayaan.length;

    const filteredHasil = Hasil.filter(h => parseInt(h.tahun_selesai) === currentFilterYear);
    document.getElementById('hasil_count').textContent = filteredHasil.length;
    const totalHasilBiaya = filteredHasil.reduce((sum, h) => sum + cleanAndParseFloat(h.biaya), 0);
    document.getElementById('hasil_total_biaya').textContent = formatRupiah(totalHasilBiaya);

    let selesaiCount = 0;
    let berjalanCount = 0;
    let progresSum = 0;
    let progresItems = 0;

    filteredRkp.forEach(rkp => {
        const rel = RealisasiData.find(r => r.rkp_id === rkp.id && parseInt(r.tahun) === currentFilterYear);
        const status = rel ? (rel.status || 'Perencanaan') : 'Perencanaan';
        if (status.toLowerCase() === 'selesai') selesaiCount++;
        else if (status.toLowerCase() === 'pelaksanaan') berjalanCount++;
        
        if (rel && typeof rel.progres_fisik !== 'undefined' && rel.progres_fisik !== '') {
            progresSum += Number(rel.progres_fisik) || 0;
            progresItems++;
        }
    });

    document.getElementById('monitoring_selesai_count').textContent = selesaiCount;
    document.getElementById('monitoring_berjalan_count').textContent = berjalanCount;

    const avgProgress = progresItems > 0 ? (progresSum / progresItems).toFixed(2) : 0;
    document.getElementById('monitoring_avg_progress').textContent = avgProgress + '%';
}

// 4.2 RINGKASAN APBDES
function renderRapbdesSummary() {
    const filteredRkp = getRKPData();
    let summary = {};
    let grandTotal = 0;

    filteredRkp.forEach(rkp => {
        const bidang = rkp.bidang;
        const subBidang = rkp.subbidang;
        const anggaran = cleanAndParseFloat(rkp.anggaran);

        if (!summary[bidang]) { summary[bidang] = { total: 0, subBidang: {} }; }
        if (!summary[bidang].subBidang[subBidang]) { summary[bidang].subBidang[subBidang] = 0; }

        summary[bidang].total += anggaran;
        summary[bidang].subBidang[subBidang] += anggaran;
        grandTotal += anggaran;
    });

    let html = '<table class="data-table"><thead><tr>';
    html += '<th>Bidang</th><th>Sub Bidang</th><th>Total Anggaran</th></tr></thead><tbody>';

    const sortedBidangKeys = Object.keys(summary).sort((a, b) => {
        const codeA = parseInt(a.substring(0, 2));
        const codeB = parseInt(b.substring(0, 2));
        return codeA - codeB;
    });

    for (const bidang of sortedBidangKeys) {
        const bidangData = summary[bidang];
        const subBidangKeys = Object.keys(bidangData.subBidang);
        const rowSpan = subBidangKeys.length;

        subBidangKeys.forEach((subBidang, index) => {
            html += '<tr>';
            if (index === 0) {
                html += `<td rowspan="${rowSpan}" style="font-weight: bold; background-color: #f0fdf9; vertical-align: middle;">${bidang}</td>`;
            }
            html += `<td>${subBidang}</td>`;
            html += `<td>${formatRupiah(bidangData.subBidang[subBidang])}</td>`;
            html += '</tr>';
        });

        html += `<tr>
            <td colspan="2" style="text-align: right; font-weight: bold; background-color: #e0f2f1;">Total Bidang ${bidang.split(' ')[0]}:</td>
            <td style="font-weight: bold; background-color: #e0f2f1;">${formatRupiah(bidangData.total)}</td>
        </tr>`;
    }

    html += '</tbody></table>';

    if (filteredRkp.length === 0) {
        html = '<p>Belum ada RKP yang diinput untuk tahun ' + currentFilterYear + '</p>';
    }

    document.getElementById('rapbdes_summary_output').innerHTML = html;
    document.getElementById('rapbdes_grand_total').textContent = formatRupiah(grandTotal);
}

function renderRapbdesSumberDana() {
    const dataTahun = getRKPData();
    const totals = {};
    dataTahun.forEach(r => {
        const sumberList = r.sumber_dana.split(',').map(s => s.trim()).filter(Boolean);
        const nominal = cleanAndParseFloat(r.anggaran); 
        
        const share = sumberList.length > 0 ? nominal / sumberList.length : nominal;
        
        sumberList.forEach(sumber => {
             if (!totals[sumber]) totals[sumber] = 0;
             totals[sumber] += share;
        });

        if (sumberList.length === 0) {
         const sumber = 'Tidak Diketahui';
            if (!totals[sumber]) totals[sumber] = 0;
            totals[sumber] += nominal;
        }
    });

    if (Object.keys(totals).length === 0) {
        document.getElementById('rapbdes_sumberdana_output').innerHTML = '<p style="color:red;">Belum ada data RKP untuk tahun ini.</p>';
        return;
    }

    let html = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Sumber Dana</th>
                    <th>Total Anggaran (Rp)</th>
                </tr>
            </thead>
            <tbody>
    `;

    let idx = 1;
    let grandTotal = 0;
    const sortedKeys = Object.keys(totals).sort();
    sortedKeys.forEach(sumber => {
        const total = totals[sumber];
        html += `
            <tr onclick="jumpToRkpAndFilterSource('${sumber}')" style="cursor:pointer;" title="Klik untuk lihat kegiatan ${sumber}">
                <td>${idx++}</td>
                <td>${sumber}</td>
                <td style="text-align:right;">${formatRupiah(total)}</td>
            </tr>`;
        grandTotal += total;
    });

    html += `
            <tr>
                <th colspan="2" style="text-align:right;">Jumlah Total</th>
                <th style="text-align:right;">${formatRupiah(grandTotal)}</th>
            </tr>
        </tbody>
        </table>
    `;

    document.getElementById('rapbdes_sumberdana_output').innerHTML = html;
}

// 4.3 RKP
// START: PERBAIKAN - Perubahan fundamental pada Modul RKP
// Data RKP sekarang disimpan di `rkpData`
let rkpData = loadData('RkpData', []);

function getRKPData() {
    // Fungsi ini sekarang hanya memfilter data RKP yang sudah ada
    return rkpData.filter(rkp => parseInt(rkp.tahun) === currentFilterYear);
}

// Fungsi untuk menampilkan modal impor dari RPJMDes
function showImportRkpModal() {
    if (!checkAuthentication()) return;
    
    document.getElementById('rkp_import_modal_year').textContent = currentFilterYear;
    const outputDiv = document.getElementById('rpjmdes_import_list_output');
    
    const relevantYearInRpjm = currentFilterYear - rpjmDesData.tahunAwal + 1;
    
    const existingRkpRpjmIds = getRKPData().map(rkp => rkp.rpjmdesId).filter(Boolean);

    const availableItems = (rpjmDesData.detailRencana || []).filter(item => {
        // Cek apakah item ini untuk tahun berjalan DAN belum diimpor ke RKP
        return item.waktu.includes(relevantYearInRpjm) && !existingRkpRpjmIds.includes(item.id);
    });

    if (availableItems.length === 0) {
        outputDiv.innerHTML = '<p style="text-align: center; color: #777;">Tidak ada kegiatan baru dari RPJMDes yang dijadwalkan untuk tahun ini atau semua sudah diimpor.</p>';
    } else {
        let listHtml = '<ul style="list-style-type: none; padding: 0;">';
        availableItems.forEach(item => {
            listHtml += `
                <li style="margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                    <label style="display: flex; align-items: center; font-weight: normal; color: #333;">
                        <input type="checkbox" class="rpjmdes-import-checkbox" value="${item.id}" style="margin-right: 15px; width: auto;">
                        <div>
                            <strong>${item.kegiatanNama}</strong> (${item.uraianKegiatan})
                            <br>
                            <small style="color: #00796b;">Lokasi: ${item.lokasi} | Volume: ${item.volume} | Anggaran: Rp ${item.jumlah}</small>
                        </div>
                    </label>
                </li>
            `;
        });
        listHtml += '</ul>';
        outputDiv.innerHTML = listHtml;
    }
    
    document.getElementById('importRkpFromRpjmdesModal').style.display = 'flex';
}

// Fungsi untuk menyimpan kegiatan yang dipilih dari RPJMDes ke RKP
function saveRkpFromRpjmdes() {
    const selectedCheckboxes = document.querySelectorAll('.rpjmdes-import-checkbox:checked');
    if (selectedCheckboxes.length === 0) {
        alert("Tidak ada kegiatan yang dipilih. Silakan centang kegiatan yang ingin diimpor.");
        return;
    }

    selectedCheckboxes.forEach(checkbox => {
        const rpjmdesId = checkbox.value;
        const item = rpjmDesData.detailRencana.find(d => d.id === rpjmdesId);
        
        if (item) {
            const newRkp = {
                id: 'rkp_' + Date.now() + '_' + rkpData.length,
                rpjmdesId: item.id, // Referensi ke item asli
                tahun: currentFilterYear,
                bidang: `${item.bidangKode} ${item.bidangNama}`,
                subbidang: `${item.subBidangKode} ${item.subBidangNama}`,
                kegiatan_code: item.kegiatanKode,
                kegiatan: item.kegiatanNama,
                uraian_kegiatan: item.uraianKegiatan,
                lokasi: item.lokasi,
                volume: item.volume,
                anggaran: item.jumlah, // Menggunakan 'jumlah' dari RPJMDes sebagai pagu
                sumber_dana: item.sumber,
                waktu_pelaksanaan: '' // Dikosongkan untuk diisi manual di RKP jika perlu
            };
            rkpData.push(newRkp);
        }
    });

    saveData('RkpData', rkpData);
    document.getElementById('importRkpFromRpjmdesModal').style.display = 'none';
    renderRkpTable();
    alert(`${selectedCheckboxes.length} kegiatan berhasil diimpor ke RKP Tahun ${currentFilterYear}.`);
}

function deleteRkp(id) {
    if (!checkAuthentication()) return;

    // Periksa apakah RKP ini sudah digunakan di RAB
    const isUsedInRAB = rabData.some(rab => rab.rkpId === id && parseInt(rab.rabTahun) === currentFilterYear);
    if (isUsedInRAB) {
        alert("Gagal menghapus! Kegiatan RKP ini sudah digunakan dalam modul RAB. Hapus data di RAB terlebih dahulu.");
        return;
    }

    if (confirm('Anda yakin ingin menghapus data RKP ini?')) {
        rkpData = rkpData.filter(r => r.id !== id);
        saveData('RkpData', rkpData);
        renderRkpTable();
        alert('Data RKP berhasil dihapus.');
    }
}

// START: MODIFIKASI FUNGSI renderRkpTable UNTUK KLASIFIKASI BERDASARKAN BIDANG
function renderRkpTable() {
    if (!checkAuthentication()) return;

    let allRkp = getRKPData();
    let filterStatusHtml = ''; 
    const rkpFilter = currentModuleFilter['RencanaPembangunan'];
    if (rkpFilter && rkpFilter.source) {
        const sourceFilter = rkpFilter.source;
        allRkp = allRkp.filter(rkp => rkp.sumber_dana === sourceFilter);
        filterStatusHtml = `<div class="filter-bar" style="background-color: #ffe0b2; color: #e65100; font-weight:bold;">
                                Filter Aktif: Hanya menampilkan kegiatan dengan Sumber Dana <strong>${sourceFilter}</strong>. 
                                <button onclick="clearRkpFilter()">Hapus Filter</button>
                            </div>`;
        // Clear filter after applying it once to prevent sticking
        delete currentModuleFilter['RencanaPembangunan']; 
    }
    
    // 1. Grouping data by Bidang (Level 1)
    const groupedRkp = allRkp.reduce((acc, rkp) => {
        const key = rkp.bidang; // Full string "01 BIDANG..."
        if (!acc[key]) {
            acc[key] = { items: [], totalBidang: 0 };
        }
        acc[key].items.push(rkp);
        acc[key].totalBidang += cleanAndParseFloat(rkp.anggaran);
        return acc;
    }, {});
    
    // 2. Sorting by Bidang Kode (first two characters)
    const sortedKeys = Object.keys(groupedRkp).sort((a, b) => a.substring(0, 2).localeCompare(b.substring(0, 2)));


    let tableHtml = '<table class="data-table"><thead><tr>';
    tableHtml += '<th>#</th><th>Bidang/Sub Bidang/Kegiatan</th><th>Uraian/Lokasi/Volume</th><th>Waktu</th><th>Pagu Anggaran</th><th>Sumber Dana</th><th>Aksi</th>';
    tableHtml += '</tr></thead><tbody>';

    const overallGrandTotal = allRkp.reduce((sum, rkp) => sum + cleanAndParseFloat(rkp.anggaran), 0);
    let overallIndex = 0;

    if (allRkp.length === 0) {
        tableHtml += `<tr><td colspan="7" style="text-align: center; padding: 15px;">Belum ada RKP yang diimpor untuk tahun ${currentFilterYear}. Silakan impor dari RPJMDes.</td></tr>`;
    } else {
        
        sortedKeys.forEach(bidangKey => {
            const bidangGroup = groupedRkp[bidangKey];
            const bidangCode = bidangKey.substring(0, 2);
            
            // Header Bidang (Classification)
            tableHtml += `
                 <tr style="background-color: #b2dfdb; font-weight: bold; font-size: 1.1em;">
                     <td colspan="7" style="text-align: left; padding: 10px 12px; color: #004d40;">
                         BIDANG ${bidangKey}
                     </td>
                 </tr>
            `;
            
            // Sort items within the Bidang by Sub Bidang Kode
            bidangGroup.items.sort((a, b) => a.subbidang.localeCompare(b.subbidang));
            
            bidangGroup.items.forEach((rkp) => {
                overallIndex++;
                tableHtml += `<tr>
                    <td>${overallIndex}</td>
                    <td>
                        <small style="color:#004d40;">Bidang: ${rkp.bidang}</small><br>
                        <small style="color:#00796b;">Sub: ${rkp.subbidang}</small><br>
                        <strong>${rkp.kegiatan}</strong>
                    </td>
                    <td>
                        ${rkp.uraian_kegiatan}<br>
                        <small style="font-style: italic;">Lokasi: ${rkp.lokasi || 'N/A'}</small><br>
                        <small style="font-style: italic;">Volume: ${rkp.volume || 'N/A'}</small>
                    </td>
                    <td>${rkp.waktu_pelaksanaan}</td>
                    <td style="text-align: right;">${rkp.anggaran}</td>
                    <td>${rkp.sumber_dana}</td>
                    <td>
                        <button class="action-btn delete-btn" onclick="deleteRkp('${rkp.id}')">ğŸ—‘ï¸ Hapus</button>
                    </td>
                </tr>`;
            });
            
            // Footer/Total Bidang
            tableHtml += `
                 <tr style="background-color: #e0f2f1; font-weight: bold;">
                     <td colspan="4" style="text-align: right; padding: 8px 12px; color: #004d40;">
                         TOTAL PAGU BIDANG ${bidangCode}
                     </td>
                     <td style="text-align: right; color: #004d40;">
                         ${formatRupiah(bidangGroup.totalBidang)}
                     </td>
                     <td colspan="2"></td>
                 </tr>
            `;
        });
    }

    tableHtml += `<tr>
        <td colspan="4" style="text-align: right; font-weight: bold; background-color: #004d40; color: white; padding: 15px 12px; font-size: 1.2em;">GRAND TOTAL ANGGARAN RKP KESELURUHAN:</td>
        <td style="text-align: right; font-weight: bold; background-color: #004d40; color: white; padding: 15px 12px; font-size: 1.2em;">${formatRupiah(overallGrandTotal)}</td>
        <td colspan="2" style="background-color: #004d40;"></td>
    </tr>`;
    tableHtml += '</tbody></table>';

    document.getElementById('rkp_list_output').innerHTML = filterStatusHtml + tableHtml;
}
// END: MODIFIKASI FUNGSI renderRkpTable

// 4.4 REALISASI
function populateRealisasiRkpDropdown() {
    const selectRkp = document.getElementById('realisasi_rkp_id');
    if (!selectRkp) return;
    selectRkp.innerHTML = '<option value="">-- Pilih Kegiatan dari RKP --</option>';

    const filteredRkp = getRKPData(); // Sekarang mengambil dari rkpData yang independen

    filteredRkp.sort((a, b) => {
        const codeA = a.bidang.split(' ')[0] + a.subbidang.split(' ')[0] + a.kegiatan_code;
        const codeB = b.bidang.split(' ')[0] + b.subbidang.split(' ')[0] + b.kegiatan_code;
        return codeA.localeCompare(codeB);
    });

    filteredRkp.forEach(rkp => {
        const option = document.createElement('option');
        option.value = rkp.id;
        option.textContent = `${rkp.bidang.split(' ')[0]} - ${rkp.kegiatan} (${rkp.uraian_kegiatan})`;
        selectRkp.appendChild(option);
    });
}

function calculateProgresOtomatis() {
    const progOtomatisEl = document.getElementById('realisasi_progres_fisik_otomatis');
    const progHiddenEl = document.getElementById('realisasi_progres_fisik');
    if (!progOtomatisEl || !progHiddenEl) return;
    
    const rkpId = document.getElementById('realisasi_rkp_id').value;
    const rkp = getRKPData().find(r => r.id === rkpId);
    const planAnggaran = rkp ? parseAnggaranRaw(rkp.anggaran) : 0;
    const realisasiAnggaranStr = document.getElementById('realisasi_anggaran').value;
    const realisasiAnggaran = parseAnggaranRaw(realisasiAnggaranStr);
    
    let progress = 0;
    if (planAnggaran > 0) {
        progress = (realisasiAnggaran / planAnggaran) * 100;
    }
    
    if (progress > 100) progress = 100; 

    const finalProgress = progress.toFixed(2);

    progOtomatisEl.value = finalProgress + '%';
    progHiddenEl.value = finalProgress;
}


function loadRkpDetails() {
    const rkpId = document.getElementById('realisasi_rkp_id').value;
    const rkp = getRKPData().find(r => r.id === rkpId);
    
    const planInput = document.getElementById('realisasi_rkp_anggaran_plan');
    const anggaranInput = document.getElementById('realisasi_anggaran');
    const statusSelect = document.getElementById('realisasi_status');
    const keteranganTextarea = document.getElementById('realisasi_keterangan');

    if (!planInput || !anggaranInput || !statusSelect || !keteranganTextarea) return; 

    if (rkp) {
        planInput.value = rkp.anggaran;
        const existingRealisasi = RealisasiData.find(r => r.rkp_id === rkpId && parseInt(r.tahun) === currentFilterYear);
        
        if (existingRealisasi) {
            document.getElementById('realisasi_editing_id').value = existingRealisasi.id;
            anggaranInput.value = existingRealisasi.realisasi_anggaran;
            statusSelect.value = existingRealisasi.status;
            keteranganTextarea.value = existingRealisasi.keterangan;
            alert('Data realisasi untuk RKP ini sudah ada. Form telah diisi dengan data yang tersimpan untuk diedit.');
        } else {
            // Jika belum ada realisasi, set default
            document.getElementById('realisasi_editing_id').value = '';
            anggaranInput.value = '';
            statusSelect.value = 'Perencanaan';
            keteranganTextarea.value = '';
        }
        calculateProgresOtomatis();
    } else {
        clearRealisasiForm();
    }
}
function saveRealisasi() {
    if (!checkAuthentication()) return;

    const rkp_id = document.getElementById('realisasi_rkp_id').value;
    const realisasi_anggaran = document.getElementById('realisasi_anggaran').value;
    const progres_fisik = document.getElementById('realisasi_progres_fisik').value; 
    const status = document.getElementById('realisasi_status').value;
    const keterangan = document.getElementById('realisasi_keterangan').value;

    if (!rkp_id || !realisasi_anggaran || progres_fisik === '' || !status) {
        alert('Semua field wajib diisi.');
        return;
    }

    const rkp = getRKPData().find(r => r.id === rkp_id);
    if (!rkp) {
        alert('RKP tidak ditemukan. Silakan pilih kegiatan RKP yang valid.');
        return;
    }

    let id = document.getElementById('realisasi_editing_id').value || 'realisasi_' + Date.now();

    const newRealisasi = {
        id: id,
        rkp_id,
        tahun: currentFilterYear,
        realisasi_anggaran,
        progres_fisik: parseFloat(progres_fisik),
        status,
        keterangan
    };

    const index = RealisasiData.findIndex(r => r.id === id);
    if (index > -1) {
        RealisasiData[index] = newRealisasi;
    } else {
        RealisasiData.push(newRealisasi);
    }

    saveData('RealisasiData', RealisasiData);
    clearRealisasiForm();
    renderRealisasiTable();
    alert('Data Realisasi Kegiatan berhasil disimpan.');
}
function editRealisasi(id) {
    if (!checkAuthentication()) return;

    const realisasi = RealisasiData.find(r => r.id === id);
    if (realisasi) {
        const editIdInput = document.getElementById('realisasi_editing_id');
        const rkpIdSelect = document.getElementById('realisasi_rkp_id');
        
        if (!editIdInput || !rkpIdSelect) return; 
        
        editIdInput.value = realisasi.id;
        rkpIdSelect.value = realisasi.rkp_id;
        
        // Trigger onchange untuk memuat semua detail terkait
        loadRkpDetails();
        
        document.getElementById('realisasi_rkp_id').focus();
    }
}

function deleteRealisasi(id) {
    if (!checkAuthentication()) return;

    if (confirm('Anda yakin ingin menghapus data realisasi ini?')) {
        RealisasiData = RealisasiData.filter(r => r.id !== id);
        saveData('RealisasiData', RealisasiData);
        renderRealisasiTable();
        alert('Data Realisasi berhasil dihapus.');
    }
}

function clearRealisasiForm() {
    document.getElementById('realisasi_editing_id').value = '';
    document.getElementById('realisasi_rkp_id').value = '';
    document.getElementById('realisasi_rkp_anggaran_plan').value = 'Rp 0,00';
    document.getElementById('realisasi_anggaran').value = '';
    document.getElementById('realisasi_progres_fisik_otomatis').value = '0%';
    document.getElementById('realisasi_progres_fisik').value = '0';
    document.getElementById('realisasi_status').value = 'Perencanaan';
    document.getElementById('realisasi_keterangan').value = '';
}
function renderRealisasiTable() {
    if (!checkAuthentication()) return;

    const allRkpView = getRKPData(); // Sumber RKP sekarang benar
    
    // Filter realisasi berdasarkan RKP yang ada di tahun berjalan
    const allRealisasi = RealisasiData.filter(realisasi => 
        allRkpView.some(rkp => rkp.id === realisasi.rkp_id) && 
        parseInt(realisasi.tahun) === currentFilterYear
    );
    
    const filteredRealisasi = allRealisasi; 
    const startIndex = 0;

    let tableHtml = '<table class="data-table"><thead><tr>';
    tableHtml += '<th>#</th><th>Nama Kegiatan (RKP)</th><th>Anggaran Rencana</th><th>Anggaran Realisasi</th><th>Progres Otomatis</th><th>Status</th><th>Aksi</th>';
    tableHtml += '</tr></thead><tbody>';

    const overallTotalRencana = allRealisasi.reduce((sum, realisasi) => {
        const rkp = allRkpView.find(r => r.id === realisasi.rkp_id);
        return sum + (rkp ? cleanAndParseFloat(rkp.anggaran) : 0);
    }, 0);
    const overallTotalRealisasi = allRealisasi.reduce((sum, realisasi) => sum + cleanAndParseFloat(realisasi.realisasi_anggaran), 0);
    const itemsWithProgress = allRealisasi.filter(r => r.progres_fisik !== undefined && r.progres_fisik !== null);
    const overallTotalProgres = itemsWithProgress.reduce((sum, r) => sum + (Number(r.progres_fisik) || 0), 0);
    const overallAvgProgres = itemsWithProgress.length > 0 ? (overallTotalProgres / itemsWithProgress.length).toFixed(2) : 0;


    filteredRealisasi.forEach((realisasi, index) => {
        const rkp = allRkpView.find(r => r.id === realisasi.rkp_id);
        const anggaranRencana = rkp ? cleanAndParseFloat(rkp.anggaran) : 0;

        const rkpKode = rkp ? `${rkp.bidang.split(' ')[0]}` : 'N/A';
        const progressDisplay = (realisasi.progres_fisik || 0).toFixed(2) + '%';
        const subKegiatanDisplay = rkp ? rkp.uraian_kegiatan : 'N/A';

        tableHtml += `<tr>
            <td>${startIndex + index + 1}</td>
            <td>
                <strong style="color:#00796b;">${rkpKode}</strong> - ${rkp ? rkp.kegiatan : 'Kegiatan tidak ditemukan'} 
                <br><span style="font-size: 0.9em; font-style: italic;">(Sub Kegiatan: ${subKegiatanDisplay})</span>
                <br><small>${realisasi.keterangan}</small>
            </td>
            <td style="text-align: right;">${rkp ? rkp.anggaran : 'N/A'}</td>
            <td style="text-align: right;">${realisasi.realisasi_anggaran}</td>
            <td style="text-align: center;">${progressDisplay}</td>
            <td><span class="status-badge status-${realisasi.status.toLowerCase()}">${realisasi.status}</span></td>
            <td>
                <button class="action-btn edit-btn" onclick="editRealisasi('${realisasi.id}')">Edit</button>
                <button class="action-btn delete-btn" onclick="deleteRealisasi('${realisasi.id}')">Hapus</button>
            </td>
        </tr>`;
    });

    tableHtml += `<tr>
        <td colspan="2" style="text-align: right; font-weight: bold; background-color: #e0f2f1;">GRAND TOTAL/RATA-RATA:</td>
        <td style="text-align: right; font-weight: bold; background-color: #e0f2f1;">${formatRupiah(overallTotalRencana)}</td>
        <td style="text-align: right; font-weight: bold; background-color: #e0f2f1;">${formatRupiah(overallTotalRealisasi)}</td>
        <td style="text-align: center; font-weight: bold; background-color: #e0f2f1;">${overallAvgProgres}%</td>
        <td colspan="2" style="background-color: #e0f2f1;"></td>
    </tr>`;
    tableHtml += '</tbody></table>';

    if (allRealisasi.length === 0) {
        tableHtml = '<p>Belum ada Realisasi Kegiatan yang diinput untuk RKP tahun ' + currentFilterYear + '</p>';
    } 
    
    document.getElementById('realisasi_list_output').innerHTML = tableHtml;
}

// 4.5 MONITORING
function renderMonitoringTable() {
    if (!checkAuthentication()) return;

    const filterStatus = document.getElementById('monitoring_status_filter')?.value || '';

    const filteredRkp = getRKPData(); // Mengambil data RKP yang sudah benar

    const groupedRkp = filteredRkp.reduce((acc, rkp) => {
        const bidangKey = rkp.bidang;
        if (!acc[bidangKey]) {
            acc[bidangKey] = { totalAnggaran: 0, items: [] };
        }
        acc[bidangKey].items.push(rkp);
        acc[bidangKey].totalAnggaran += cleanAndParseFloat(rkp.anggaran);
        return acc;
    }, {});
    
    const RealisasiDataMap = RealisasiData.filter(r => parseInt(r.tahun) === currentFilterYear).reduce((map, obj) => { map[obj.rkp_id] = obj; return map; }, {});

    let htmlOutput = '';
    
    const sortedBidangKeys = Object.keys(groupedRkp).sort((a, b) => {
        const codeA = parseInt(a.substring(0, 2));
        const codeB = parseInt(b.substring(0, 2));
        return codeA - codeB;
    });

    if (filteredRkp.length === 0) {
        document.getElementById('monitoring_output').innerHTML = `<p>Belum ada RKP yang diinput untuk tahun ${currentFilterYear}.</p>`;
        return;
    }
    
    for (const bidangKey of sortedBidangKeys) {
        const group = groupedRkp[bidangKey];
        let totalBidangRealisasi = 0;
        let totalBidangAnggaran = 0;
        let hasItemsInGroup = false; 
        let cardContent = '';
        
        const filteredGroupItems = group.items.filter((rkp) => {
             const realisasi = RealisasiDataMap[rkp.id];
             const status = realisasi ? realisasi.status : 'Perencanaan';
             return filterStatus === '' || status === filterStatus;
        });

        filteredGroupItems.sort((a, b) => a.kegiatan_code.localeCompare(b.kegiatan_code));

        filteredGroupItems.forEach((rkp) => {
            const realisasi = RealisasiDataMap[rkp.id];
            const status = realisasi ? realisasi.status : 'Perencanaan';
            
            hasItemsInGroup = true;
            
            const anggaran = cleanAndParseFloat(rkp.anggaran);
            const realisasiAnggaran = realisasi ? cleanAndParseFloat(realisasi.realisasi_anggaran) : 0;
            const progresFisik = realisasi ? (Number(realisasi.progres_fisik) || 0) : 0;
            const penyerapan = anggaran > 0 ? ((realisasiAnggaran / anggaran) * 100).toFixed(2) : 0;

            totalBidangAnggaran += anggaran;
            totalBidangRealisasi += realisasiAnggaran;

            const progressBarHtml = `<div class="progress-bar-container" style="margin-top: 0;"><div class="progress-bar" style="width: ${progresFisik}%; background-color: ${progresFisik >= 100 ? '#5cb85c' : '#00796b'};">${progresFisik}%</div></div>`;
            const statusBadgeHtml = `<span class="status-badge status-${status.toLowerCase()}">${status}</span>`;
            
            const realisasiKeteranganHtml = realisasi && realisasi.keterangan ? `<p style="margin: 3px 0 0; font-size: 0.8em; color: #d9534f; font-style: italic;">Catatan Realisasi: ${realisasi.keterangan}</p>` : '';
            const subBidangNameOnly = rkp.subbidang.substring(rkp.subbidang.indexOf(' ') + 1);
            
            cardContent += `
                <div class="monitoring-kegiatan">
                    <div>
                        <small style="color:#666;">Kode: ${rkp.kegiatan_code} | Sumber Dana RKP: ${rkp.sumber_dana}</small><br>
                        <strong style="font-size: 1.05em;">${rkp.kegiatan}</strong>
                        <p style="margin: 3px 0 0; font-size: 0.85em; color: #004d40;">Sub Bidang: ${subBidangNameOnly}</p>
                        <p style="margin: 3px 0 0; font-size: 0.85em; color: #d9534f; font-weight: bold;">Sub Kegiatan (Level 4): ${rkp.uraian_kegiatan}</p>
                        <p style="margin: 3px 0 0; font-size: 0.85em; color: #004d40;">Waktu: ${rkp.waktu_pelaksanaan || 'N/A'}</p>
                        ${realisasiKeteranganHtml}
                    </div>
                    <div style="text-align: right;">${formatRupiah(anggaran)}</div>
                    <div style="text-align: right;">${formatRupiah(realisasiAnggaran)}</div>
                    <div style="text-align: center;">${statusBadgeHtml}</div>
                    <div class="prog-container">
                        <small>Fisik: ${progressBarHtml}</small>
                        <small>Serapan: ${penyerapan}%</small>
                    </div>
                </div>
            `;
        });
        
        if (hasItemsInGroup) {
            const totalBidangPenyerapan = totalBidangAnggaran > 0 ? (totalBidangRealisasi / totalBidangAnggaran * 100).toFixed(2) : 0;
            
            htmlOutput += `
                <div class="monitoring-card">
                    <div class="monitoring-header">${bidangKey}</div>
                    <div class="monitoring-detail">${cardContent}</div>
                    <div style="padding: 10px 15px; background-color: #e0f2f1; font-weight: bold; border-radius: 0 0 8px 8px; border-top: 1px solid #b2dfdb;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>TOTAL ANGGARAN: ${formatRupiah(totalBidangAnggaran)}</span>
                            <span>TOTAL REALISASI: ${formatRupiah(totalBidangRealisasi)}</span>
                            <span style="color: #d9534f;">PENYERAPAN: ${totalBidangPenyerapan}%</span>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    const overallGrandTotalAnggaran = filteredRkp.reduce((sum, rkp) => sum + cleanAndParseFloat(rkp.anggaran), 0);
    const overallRealisasiData = RealisasiData.filter(r => filteredRkp.map(rkp => rkp.id).includes(r.rkp_id) && parseInt(r.tahun) === currentFilterYear);
    const overallGrandTotalRealisasi = overallRealisasiData.reduce((sum, r) => sum + cleanAndParseFloat(r.realisasi_anggaran), 0);
    const overallItemsWithProgressForAvg = overallRealisasiData.filter(r => r.progres_fisik !== undefined && r.progres_fisik !== null);
    const overallTotalProgressForAvg = overallItemsWithProgressForAvg.reduce((sum, r) => sum + (Number(r.progres_fisik) || 0), 0);
    const avgProgress = overallItemsWithProgressForAvg.length > 0 ? (overallTotalProgressForAvg / overallItemsWithProgressForAvg.length).toFixed(2) : 0;
    const totalPenyerapan = overallGrandTotalAnggaran > 0 ? (overallGrandTotalRealisasi / overallGrandTotalAnggaran * 100).toFixed(2) : 0;

    htmlOutput += `
        <div style="margin-top: 30px; border: 2px solid #00796b; padding: 15px; background-color: #c8e6c9; font-weight: bold; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between;">
                <span>GRAND TOTAL RENCANA: ${formatRupiah(overallGrandTotalAnggaran)}</span>
                <span>GRAND TOTAL REALISASI: ${formatRupiah(overallGrandTotalRealisasi)}</span>
            </div>
            <div style="text-align: right; margin-top: 10px; font-size: 1.2em; color: #d9534f;">
                TOTAL PENYERAPAN: ${totalPenyerapan}% (Rata-rata Fisik: ${avgProgress}%)
            </div>
        </div>
    `;
    
    document.getElementById('monitoring_output').innerHTML = htmlOutput;
}

// 4.6 INVENTARIS
function saveKekayaan() {
    if (!checkAuthentication()) return;

    const id = document.getElementById('kekayaan_editing_id').value || 'kekayaan_' + Date.now();
    const nama = document.getElementById('kekayaan_nama').value;
    const kode = document.getElementById('kekayaan_kode').value;
    const tahun_perolehan = document.getElementById('kekayaan_tahun_perolehan').value;
    const nilai = document.getElementById('kekayaan_nilai').value;
    const kondisi = document.getElementById('kekayaan_kondisi').value;
    const keterangan = document.getElementById('kekayaan_keterangan').value;

    if (!nama || !tahun_perolehan || !nilai || !kondisi) { alert('Nama, Tahun Perolehan, Nilai, dan Kondisi wajib diisi.'); return; }

    const newKekayaan = { id, nama, kode, tahun_perolehan: parseInt(tahun_perolehan), nilai, kondisi, keterangan };

    const index = KekayaanData.findIndex(k => k.id === id);
    if (index > -1) { KekayaanData[index] = newKekayaan; } else { KekayaanData.push(newKekayaan); }

    saveData('KekayaanData', KekayaanData);
    clearKekayaanForm();
    renderInventarisKekayaanTable();
    alert('Data Inventaris Kekayaan berhasil disimpan.');
}
function editKekayaan(id) {
    if (!checkAuthentication()) return;

    const kekayaan = KekayaanData.find(k => k.id === id);
    if (kekayaan) {
        document.getElementById('kekayaan_editing_id').value = kekayaan.id;
        document.getElementById('kekayaan_nama').value = kekayaan.nama;
        document.getElementById('kekayaan_kode').value = kekayaan.kode;
        document.getElementById('kekayaan_tahun_perolehan').value = kekayaan.tahun_perolehan;
        document.getElementById('kekayaan_nilai').value = kekayaan.nilai;
        document.getElementById('kekayaan_kondisi').value = kekayaan.kondisi;
        document.getElementById('kekayaan_keterangan').value = kekayaan.keterangan;
    }
}
function deleteKekayaan(id) {
    if (!checkAuthentication()) return;

    if (confirm('Anda yakin ingin menghapus data aset ini?')) {
        KekayaanData = KekayaanData.filter(k => k.id !== id);
        saveData('KekayaanData', KekayaanData);
        renderInventarisKekayaanTable();
        alert('Data Inventaris Kekayaan berhasil dihapus.');
    }
}

function saveHasil() {
    if (!checkAuthentication()) return;

    const id = document.getElementById('hasil_editing_id').value || 'hasil_' + Date.now();
    const nama = document.getElementById('hasil_nama').value;
    const tahun_selesai = document.getElementById('hasil_tahun_selesai').value;
    const lokasi = document.getElementById('hasil_lokasi').value;
    const biaya = document.getElementById('hasil_biaya').value;
    const manfaat = document.getElementById('hasil_manfaat').value;

    if (!nama || !tahun_selesai || !biaya) { alert('Nama Hasil Kegiatan, Tahun Selesai, dan Biaya Pembangunan wajib diisi.'); return; }

    const newHasil = { id, nama, tahun_selesai: parseInt(tahun_selesai), lokasi, biaya, manfaat };

    const index = HasilData.findIndex(h => h.id === id);
    if (index > -1) { HasilData[index] = newHasil; } else { HasilData.push(newHasil); }

    saveData('HasilData', HasilData);
    clearHasilForm();
    renderInventarisHasilTable();
    alert('Data Hasil Pembangunan berhasil disimpan.');
}
function editHasil(id) {
    if (!checkAuthentication()) return;

    const hasil = HasilData.find(h => h.id === id);
    if (hasil) {
        document.getElementById('hasil_editing_id').value = hasil.id;
        document.getElementById('hasil_nama').value = hasil.nama;
        document.getElementById('hasil_tahun_selesai').value = hasil.tahun_selesai;
        document.getElementById('hasil_lokasi').value = hasil.lokasi;
        document.getElementById('hasil_biaya').value = hasil.biaya;
        document.getElementById('hasil_manfaat').value = hasil.manfaat;
    }
}
function deleteHasil(id) {
    if (!checkAuthentication()) return;

    if (confirm('Anda yakin ingin menghapus data hasil pembangunan ini?')) {
        HasilData = HasilData.filter(h => h.id !== id);
        saveData('HasilData', HasilData);
        renderInventarisHasilTable();
        alert('Data Hasil Pembangunan berhasil dihapus.');
    }
}

function clearKekayaanForm() {
    document.getElementById('kekayaan_editing_id').value = '';
    document.getElementById('kekayaan_nama').value = '';
    document.getElementById('kekayaan_kode').value = '';
    document.getElementById('kekayaan_tahun_perolehan').value = currentFilterYear;
    document.getElementById('kekayaan_nilai').value = '';
    document.getElementById('kekayaan_kondisi').value = 'Baik';
    document.getElementById('kekayaan_keterangan').value = '';
}
function clearHasilForm() {
    document.getElementById('hasil_editing_id').value = '';
    document.getElementById('hasil_nama').value = '';
    document.getElementById('hasil_tahun_selesai').value = currentFilterYear;
    document.getElementById('hasil_lokasi').value = '';
    document.getElementById('hasil_biaya').value = '';
    document.getElementById('hasil_manfaat').value = '';
}
function renderInventarisKekayaanTable() {
    if (!checkAuthentication()) return;

    const allKekayaan = KekayaanData.filter(k => parseInt(k.tahun_perolehan) === currentFilterYear);
    
    const filteredKekayaan = allKekayaan; 
    const startIndex = 0;

    let tableHtml = '<table class="data-table"><thead><tr>';
    tableHtml += '<th>#</th><th>Nama Barang/Aset</th><th>Kode Aset</th><th>Tahun Perolehan</th><th>Nilai Perolehan</th><th>Kondisi</th><th>Aksi</th>';
    tableHtml += '</tr></thead><tbody>';

    let overallGrandTotalNilai = allKekayaan.reduce((sum, k) => sum + cleanAndParseFloat(k.nilai), 0);

    filteredKekayaan.forEach((kekayaan, index) => {
        
        tableHtml += `<tr>
            <td>${startIndex + index + 1}</td>
            <td>${kekayaan.nama}</td>
            <td>${kekayaan.kode}</td>
            <td>${kekayaan.tahun_perolehan}</td>
            <td style="text-align: right;">${kekayaan.nilai}</td>
            <td>${kekayaan.kondisi}</td>
            <td>
                <button class="action-btn edit-btn" onclick="editKekayaan('${kekayaan.id}')">Edit</button>
                <button class="action-btn delete-btn" onclick="deleteKekayaan('${kekayaan.id}')">Hapus</button>
            </td>
        </tr>`;
    });

    tableHtml += `<tr>
        <td colspan="4" style="text-align: right; font-weight: bold; background-color: #e0f2f1;">GRAND TOTAL NILAI PEROLEHAN:</td>
        <td style="text-align: right; font-weight: bold; background-color: #e0f2f1;">${formatRupiah(overallGrandTotalNilai)}</td>
        <td colspan="2" style="background-color: #e0f2f1;"></td>
    </tr>`;
    tableHtml += '</tbody></table>';

    if (allKekayaan.length === 0) {
        tableHtml = '<p>Belum ada data Inventaris Kekayaan yang diinput untuk tahun ' + currentFilterYear + '</p>';
    } 

    document.getElementById('kekayaan_list_output').innerHTML = tableHtml;
    document.getElementById('kekayaan_table_year').textContent = currentFilterYear;
}

function renderInventarisHasilTable() {
    if (!checkAuthentication()) return;

    const allHasil = HasilData.filter(h => parseInt(h.tahun_selesai) === currentFilterYear);
    
    const filteredHasil = allHasil; 
    const startIndex = 0;
    
    let tableHtml = '<table class="data-table"><thead><tr>';
    tableHtml += '<th>#</th><th>Nama Hasil Kegiatan</th><th>Tahun Selesai</th><th>Lokasi/Volume</th><th>Biaya Pembangunan</th><th>Manfaat/Keterangan</th><th>Aksi</th>';
    tableHtml += '</tr></thead><tbody>';

    let overallGrandTotalBiaya = allHasil.reduce((sum, h) => sum + cleanAndParseFloat(h.biaya), 0);

    filteredHasil.forEach((hasil, index) => {
        
        tableHtml += `<tr>
            <td>${startIndex + index + 1}</td>
            <td>${hasil.nama}</td>
            <td>${hasil.tahun_selesai}</td>
            <td>${hasil.lokasi}</td>
            <td style="text-align: right;">${hasil.biaya}</td>
            <td>${hasil.manfaat}</td>
            <td>
                <button class="action-btn edit-btn" onclick="editHasil('${hasil.id}')">Edit</button>
                <button class="action-btn delete-btn" onclick="deleteHasil('${hasil.id}')">Hapus</button>
            </td>
        </tr>`;
    });

    tableHtml += `<tr>
        <td colspan="4" style="text-align: right; font-weight: bold; background-color: #e0f2f1;">GRAND TOTAL BIAYA PEMBANGUNAN:</td>
        <td style="text-align: right; font-weight: bold; background-color: #e0f2f1;">${formatRupiah(overallGrandTotalBiaya)}</td>
        <td colspan="2" style="background-color: #e0f2f1;"></td>
    </tr>`;
    tableHtml += '</tbody></table>';

    if (allHasil.length === 0) {
        tableHtml = '<p>Belum ada data Inventaris Hasil Pembangunan yang diinput untuk tahun ' + currentFilterYear + '</p>';
    } 

    document.getElementById('hasil_list_output').innerHTML = tableHtml;
    document.getElementById('hasil_table_year').textContent = currentFilterYear;
}

// 4.7 LAPORAN & EKSPOR
function updateDesaLogoDisplay() {
    const sidebarLogo = document.getElementById('desa_logo');
    const splashLogo = document.getElementById('splash-logo');
    const loginLogo = document.getElementById('login_logo');
    
    // Update global variable from settings
    desaLogoBase64 = desaSettings.logoDataUrl || localStorage.getItem('desaLogoBase64') || '';
    
    const finalLogoSrc = desaLogoBase64 || DEFAULT_SIPDES_LOGO_SVG;
    const isDefaultLogo = !desaLogoBase64;

    if (sidebarLogo) {
        sidebarLogo.src = finalLogoSrc;
        sidebarLogo.style.display = 'block';
        sidebarLogo.style.backgroundColor = isDefaultLogo ? '#fff' : 'white'; 
        sidebarLogo.style.padding = isDefaultLogo ? '5px' : '5px';
    }
    if (splashLogo) {
        splashLogo.src = finalLogoSrc;
        splashLogo.style.backgroundColor = isDefaultLogo ? 'white' : 'white'; // Keep white background on splash
    }
    if (loginLogo) {
        loginLogo.src = finalLogoSrc;
        loginLogo.style.display = 'block';
        loginLogo.style.backgroundColor = isDefaultLogo ? 'white' : 'white';
    }
    
    const preview = document.getElementById('logo_preview');
    if (preview) {
         preview.src = finalLogoSrc;
         preview.style.display = 'block';
    }
}
function saveDesaLogo() {
    if (!checkAuthentication()) return;
    desaLogoBase64 = desaSettings.logoDataUrl || '';
    localStorage.setItem('desaLogoBase64', desaLogoBase64);
    saveData('desaSettings', desaSettings);
    updateDesaLogoDisplay();
    alert('Logo Desa berhasil disimpan!');
}

// Function for logo preview (needed for LaporanEksporData)
function previewLogo(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('logo_preview');
    const message = document.getElementById('logo_upload_message');

    if (file) {
        if (file.size > 500 * 1024) { // 500 KB limit
            message.textContent = 'Ukuran file melebihi batas (maks 500 KB).';
            preview.style.display = 'none';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            message.textContent = '';
            // Store temporarily in settings until user clicks "Simpan Logo"
            desaSettings.logoDataUrl = e.target.result; 
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
        message.textContent = '';
        desaSettings.logoDataUrl = ''; 
    }
}
function removeDesaLogo() {
    if (!checkAuthentication()) return;
    if (confirm('Anda yakin ingin menghapus logo Desa? Logo default akan ditampilkan.')) {
        desaLogoBase64 = '';
        desaSettings.logoDataUrl = '';
        localStorage.removeItem('desaLogoBase64');
        saveData('desaSettings', desaSettings);
        updateDesaLogoDisplay();
        alert('Logo Desa berhasil dihapus! Logo default SIPDes ditampilkan.');
    }
}
function saveWilayah() {
    // Update fields in the global desaSettings object
    desaSettings.namaDesa = document.getElementById("input_desa").value.trim();
    desaSettings.namaKecamatan = document.getElementById("input_kecamatan").value.trim();
    desaSettings.namaKabupaten = document.getElementById("input_kabupaten").value.trim();
    desaSettings.namaProvinsi = document.getElementById("input_provinsi").value.trim();
    desaSettings.desaAlamat = document.getElementById("input_alamat").value.trim();
    desaSettings.desaKodePos = document.getElementById("input_kodepos").value.trim();

    // Save the updated desaSettings to localStorage
    saveData('desaSettings', desaSettings);
    
    // Opsional: Hapus key lama untuk menghindari konflik data di masa depan
    localStorage.removeItem("identitas_wilayah"); 

    alert("âœ… Identitas wilayah berhasil disimpan!");
    tampilkanWilayah(); // update tampilan sidebar dan form
}

function tampilkanWilayah() {
    // NEW: Migration check for old data stored in 'identitas_wilayah'
    const oldWilayahData = localStorage.getItem("identitas_wilayah");
    if (oldWilayahData && !desaSettings.desaAlamat && desaSettings.namaDesa === 'Contoh') { 
        // Only run if old key exists and new fields in desaSettings are still defaults (or close enough)
        const data = JSON.parse(oldWilayahData);
        // Map old fields to new fields (migration)
        desaSettings.namaDesa = data.desa || desaSettings.namaDesa;
        desaSettings.namaKecamatan = data.kecamatan || desaSettings.namaKecamatan;
        desaSettings.namaKabupaten = data.kabupaten || desaSettings.namaKabupaten;
        desaSettings.namaProvinsi = data.provinsi || desaSettings.namaProvinsi;
        desaSettings.desaAlamat = data.alamat || desaSettings.desaAlamat;
        desaSettings.desaKodePos = data.kodepos || desaSettings.desaKodePos;
        saveData('desaSettings', desaSettings);
        // Don't remove old key yet, but data is now consistent.
    }
    
    // Load from the consolidated source: desaSettings
    const data = desaSettings;

    // Sidebar Info
    if (document.getElementById("nama_desa")) {
        document.getElementById("nama_desa").textContent = data.namaDesa || "";
        document.getElementById("nama_kecamatan").textContent = data.namaKecamatan ? "Kec. " + data.namaKecamatan : "";
        document.getElementById("nama_kabupaten").textContent = data.namaKabupaten ? "Kab. " + data.namaKabupaten : "";
        document.getElementById("nama_provinsi").textContent = data.namaProvinsi ? "Prov. " + data.namaProvinsi : "";
    }

    // Isi ulang form jika form tersedia di halaman (menggunakan desaSettings)
    if (document.getElementById("input_desa")) {
        document.getElementById("input_desa").value = data.namaDesa || "";
        document.getElementById("input_kecamatan").value = data.namaKecamatan || "";
        document.getElementById("input_kabupaten").value = data.namaKabupaten || "";
        document.getElementById("input_provinsi").value = data.namaProvinsi || "";
        document.getElementById("input_alamat").value = data.desaAlamat || "";
        document.getElementById("input_kodepos").value = data.desaKodePos || "";
    }
}

function hapusWilayah() {
    if (confirm("Apakah Anda yakin ingin menghapus identitas wilayah? Tindakan ini akan mengosongkan data di KOP laporan.")) {
        // Clear fields in desaSettings
        desaSettings.namaDesa = 'Contoh'; // Diberi nilai default lagi
        desaSettings.namaKecamatan = 'Contoh';
        desaSettings.namaKabupaten = 'Contoh';
        desaSettings.namaProvinsi = 'Contoh';
        desaSettings.desaAlamat = '';
        desaSettings.desaKodePos = '';
        saveData('desaSettings', desaSettings);
        
        // Remove the old storage key as well
        localStorage.removeItem("identitas_wilayah");

        alert("ğŸ—‘ï¸ Identitas wilayah dihapus dan KOP direset ke nilai default.");
        tampilkanWilayah();
    }
}

function renderSidebarWilayah() {
    try {
        if (typeof tampilkanWilayah === "function") {
            tampilkanWilayah(); // Call the corrected function
            return;
        }
        // fallback kosong
        if (document.getElementById('nama_desa')) document.getElementById('nama_desa').textContent = '';
        if (document.getElementById('nama_kecamatan')) document.getElementById('nama_kecamatan').textContent = '';
        if (document.getElementById('nama_kabupaten')) document.getElementById('nama_kabupaten').textContent = '';
        if (document.getElementById('nama_provinsi')) document.getElementById('nama_provinsi').textContent = '';
    } catch (e) {
        console.error("renderSidebarWilayah error:", e);
    }
}

function exportAllData() {
    if (!checkAuthentication()) return;

    const allData = {
        rabData: rabData,
        // START: PERBAIKAN - Sertakan rkpData dalam ekspor
        rkpData: rkpData,
        // END: PERBAIKAN
        RealisasiData: RealisasiData,
        KekayaanData: KekayaanData,
        HasilData: HasilData,
        desaSettings: desaSettings,
        desaLogoBase64: desaLogoBase64,
        customPKAList: customPKAList,
        customObyekAccounts: customObyekAccounts,
        profilDesaData: profilDesaData,
        rpjmDesData: rpjmDesData,
        sipdesAuthData: { users: UserData, currentUser: null } 
    };

    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "backup_data_sipdes_terintegrasi_" + Date.now() + ".json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
    alert('Data berhasil diekspor. Jangan lupa simpan file JSON Anda.');
}
function importAllData() {
    if (!checkAuthentication()) return;

    if (!confirm('PERINGATAN: Mengimpor data akan MENIMPA SEMUA data yang ada di aplikasi ini. Lanjutkan?')) { return; }
    
    showSplash("Mengimpor data...");

    const fileInput = document.getElementById('importFile');
    const file = fileInput.files[0];

    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);

                // START: PERBAIKAN - Cek keberadaan rkpData atau rabData (untuk kompatibilitas)
                if ((importedData.rkpData || importedData.rabData) && importedData.RealisasiData && importedData.desaSettings) {
                // END: PERBAIKAN

                    rabData = importedData.rabData || [];
                    // START: PERBAIKAN - Muat rkpData dari file impor
                    rkpData = importedData.rkpData || [];
                    // END: PERBAIKAN
                    RealisasiData = importedData.RealisasiData;
                    KekayaanData = importedData.KekayaanData || [];
                    HasilData = importedData.HasilData || [];
                    customPKAList = importedData.customPKAList || [];
                    customObyekAccounts = importedData.customObyekAccounts || [];
                    UserData = importedData.sipdesAuthData?.users || UserData;
                    sipdesAuthData = importedData.sipdesAuthData || sipdesAuthData;
                    profilDesaData = importedData.profilDesaData || profilDesaData;
                    rpjmDesData = importedData.rpjmDesData || rpjmDesData;
                    
                    desaSettings = { 
                        ...desaSettings, 
                        ...importedData.desaSettings,
                        namaPKADefault: undefined,
                        jabatanPKADefault: undefined 
                    }; 
                    desaLogoBase64 = importedData.desaLogoBase64 || '';
                    
                    saveData('rabData', rabData);
                    saveData('RkpData', rkpData); // Simpan data RKP yang baru
                    saveData('RealisasiData', RealisasiData);
                    saveData('KekayaanData', KekayaanData);
                    saveData('HasilData', HasilData);
                    saveData('desaSettings', desaSettings);
                    saveData('customPKAList', customPKAList);
                    saveData('customObyekAccounts', customObyekAccounts);
                    saveData('profilDesaData', profilDesaData);
                    saveData('rpjmDesData', rpjmDesData);
                    saveData('UserData', UserData);
                    localStorage.setItem('desaLogoBase64', desaLogoBase64); 
                    saveData('sipdesAuthData', { users: UserData, currentUser: null });

                    alert('Data berhasil diimpor dan menimpa data lokal. Silakan refresh halaman.');
                    window.location.reload();
                } else {
                    alert('Struktur file JSON tidak valid atau tidak lengkap.');
                    hideSplash();
                }
            } catch (error) {
                alert('Gagal memproses file JSON: ' + error);
                hideSplash();
            }
        };
        reader.readAsText(file);
    } else {
        alert('Silakan pilih file JSON terlebih dahulu.');
        hideSplash();
    }
}

// 4.8 RAB & BELANJA

// START: Tambahkan definisi fungsi yang hilang
/**
 * Mengisi dropdown filter Bidang di Modul RAB (di luar modal).
 * Menggunakan RAB_PARAMETERS sebagai sumber data.
 * @param {string} selectedValue - Kode bidang yang sedang dipilih (dari filter).
 */
function populateRABBidangFilter(selectedValue = null) {
    const select = document.getElementById('rab_bidang_filter');
    if (!select) return;

    // Simpan nilai yang ada saat ini sebelum direset, jika ada
    const currentValue = selectedValue || select.value; 

    select.innerHTML = '<option value="">-- Semua Bidang --</option>';

    RAB_PARAMETERS.forEach(bidang => {
        const option = document.createElement('option');
        option.value = bidang.kode;
        option.textContent = `${bidang.kode} ${bidang.nama}`;
        if (bidang.kode === currentValue) {
             option.selected = true;
        }
        select.appendChild(option);
    });
}
// END: Tambahkan definisi fungsi yang hilang

function getKegiatanDataByCode(bidangKode, subBidangKode, kegiatanKode) {
    const bidang = RAB_PARAMETERS.find(b => b.kode === bidangKode);
    if (!bidang) return null;
    const subBidang = bidang.subBidang.find(s => s.kode === subBidangKode);
    if (!subBidang) return null;
    
    const kegiatan = subBidang.kegiatan.find(k => k.kode === kegiatanKode); 
    
    return {
        bidangNama: bidang.nama,
        subBidangNama: subBidang.nama,
        kegiatanNama: kegiatan ? kegiatan.nama : 'Kegiatan Tidak Ditemukan'
    };
}
function populateBidang() {
    const selectBidang = document.getElementById('rabBidang');
    if (!selectBidang) return;
    selectBidang.innerHTML = '<option value="">-- Pilih Bidang --</option>';
    RAB_PARAMETERS.forEach(bidang => {
        const option = document.createElement('option');
		option.value = bidang.kode;
        option.textContent = `${bidang.kode} ${bidang.nama}`;
        selectBidang.appendChild(option);
    });
    populateSubBidang('');
}

function populateSubBidang(selectedSubBidangKode = null) {
    const bidangKode = document.getElementById('rabBidang').value;
    const selectSubBidang = document.getElementById('rabSubBidang');
    const selectKegiatan = document.getElementById('rabKegiatan');

    if (!selectSubBidang || !selectKegiatan) return;

    selectSubBidang.innerHTML = '<option value="">-- Pilih Sub Bidang --</option>';
    selectKegiatan.innerHTML = '<option value="">-- Pilih Kegiatan --</option>';
    selectSubBidang.disabled = true; 
    selectKegiatan.disabled = true;

    if (bidangKode) {
        const bidang = RAB_PARAMETERS.find(b => b.kode === bidangKode);
        if (bidang) {
            for (const sub of bidang.subBidang) {
                const option = document.createElement('option');
                option.value = sub.kode;
                option.textContent = `${sub.kode} ${sub.nama}`;
                selectSubBidang.appendChild(option);
            }
            selectSubBidang.disabled = false;
            
            if (selectedSubBidangKode) {
                selectSubBidang.value = selectedSubBidangKode;
                populateKegiatan(null);
            }
        }
    }
}

function populateKegiatan(selectedKegiatanKode = null) {
    const bidangKode = document.getElementById('rabBidang').value;
    const subBidangKode = document.getElementById('rabSubBidang').value;
    const selectKegiatan = document.getElementById('rabKegiatan');

    if (!selectKegiatan) return;

    selectKegiatan.innerHTML = '<option value="">-- Pilih Kegiatan --</option>';
    selectKegiatan.disabled = true;

    if (bidangKode && subBidangKode) {
        const bidang = RAB_PARAMETERS.find(b => b.kode === bidangKode);
        if (bidang) {
            const subBidang = bidang.subBidang.find(s => s.kode === subBidangKode);
            if (subBidang) {
                for (const kegiatan of subBidang.kegiatan) {
                    const option = document.createElement('option');
                    option.value = kegiatan.kode;
                    option.textContent = `${kegiatan.kode} ${kegiatan.nama}`;
                    selectKegiatan.appendChild(option);
                }
                selectKegiatan.disabled = false;
                
                if (selectedKegiatanKode) {
                    selectKegiatan.value = selectedKegiatanKode;
                }
            }
        }
    }
}
// PERBAIKAN: Fungsi untuk mengisi dropdown Jenis Belanja (Untuk Modul Detil Belanja)
function populateJenisAkun(selectedJenis = null) {
    const selectJenis = document.getElementById('detailJenisAkun');
    const selectObyek = document.getElementById('detailObyekAkun');
    // Jika elemen tidak ada, jangan lakukan apa-apa
    if (!selectJenis || !selectObyek) return; 
    
    selectJenis.innerHTML = '<option value="">-- Pilih Jenis Belanja --</option>';
    selectObyek.innerHTML = '<option value="">-- Pilih Objek Belanja --</option>';
    selectObyek.disabled = true;

    // Kelompok Belanja (5.X)
    BELANJA_ACCOUNTS.forEach(kelompok => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = `${kelompok.kode} ${kelompok.nama}`;
        
        // Jenis Belanja (5.X.X)
        kelompok.jenis.forEach(jenis => {
            const option = document.createElement('option');
            option.value = jenis.kode;
            option.textContent = `${jenis.kode} - ${jenis.nama}`; 
            optgroup.appendChild(option);
        });
        selectJenis.appendChild(optgroup);
    });
    
    if (selectedJenis) {
        selectJenis.value = selectedJenis;
        populateObyekAkun();
    }
}

// PERBAIKAN: Fungsi untuk mengisi dropdown Objek Belanja (Untuk Modul Detil Belanja)
function populateObyekAkun(selectedObyek = null) {
    const jenisKode = document.getElementById('detailJenisAkun').value;
    const selectObyek = document.getElementById('detailObyekAkun');
    const inputUraian = document.getElementById('detailUraian');
    
    // Jika elemen tidak ada, jangan lakukan apa-apa
    if (!selectObyek || !inputUraian) return; 
    
    selectObyek.innerHTML = '<option value="">-- Pilih Objek Belanja --</option>';
    selectObyek.disabled = true;
    inputUraian.placeholder = 'Rincian Obyek/Uraian Detail Belanja (Wajib Diisi)';
    
    if (jenisKode) {
        let selectedJenis = null;
        let obyekList = []; // Array untuk menampung semua obyek (standar + kustom)

        // 1. Cari Objek Standar (Hardcoded)
        BELANJA_ACCOUNTS.forEach(kelompok => {
            if (selectedJenis) return;
            selectedJenis = kelompok.jenis.find(j => j.kode === jenisKode);
        });

        if (selectedJenis && selectedJenis.obyek) {
            // Map standar objek, tambahkan flag isCustom: false
            obyekList.push(...selectedJenis.obyek.map(o => ({...o, isCustom: false})));
        }

        // 2. Tambahkan Objek Kustom
        // Map custom objek, tambahkan flag isCustom: true
        customObyekAccounts.filter(o => o.kode.startsWith(jenisKode)).forEach(obyek => {
             obyekList.push({...obyek, isCustom: true});
        });

        // 3. Urutkan berdasarkan Kode Akun (Ascending) untuk urutan logis
        obyekList.sort((a, b) => a.kode.localeCompare(b.kode));


        if (obyekList.length > 0) {
             // 4. Populate Dropdown
             obyekList.forEach(obyek => {
                const option = document.createElement('option');
                option.value = obyek.kode;
                const customLabel = obyek.isCustom ? ' (Kustom)' : '';
                option.textContent = `${obyek.kode} - ${obyek.nama}${customLabel}`;
                selectObyek.appendChild(option);
             });
             selectObyek.disabled = false;
        }

        if (selectedObyek) {
            selectObyek.value = selectedObyek;
            generateUraianPlaceholder();
        }
    }
}


// NEW: Fungsi untuk mengisi dropdown Objek Belanja (Untuk Modal Pemilihan Level 5)
function populateObyekAkunSelectModal(selectedObyek = null) {
    const selectJenis = document.getElementById('selectObyekJenisAkun');
    const selectObyek = document.getElementById('selectObyekObyekAkun');
    
    // PENTING: Cek elemen sebelum mencoba membaca value
    if (!selectJenis || !selectObyek) return; 
    
    const jenisKode = selectJenis.value; // Ambil nilai setelah cek null
    
    selectObyek.innerHTML = '<option value="">-- Pilih Objek Belanja --</option>';
    selectObyek.disabled = true;
    
    if (jenisKode) {
        let selectedJenis = null;
        let obyekList = []; 

        // 1. Cari Objek Standar (Hardcoded)
        BELANJA_ACCOUNTS.forEach(kelompok => {
            if (selectedJenis) return;
            selectedJenis = kelompok.jenis.find(j => j.kode === jenisKode);
        });

        if (selectedJenis && selectedJenis.obyek) {
            obyekList.push(...selectedJenis.obyek.map(o => ({...o, isCustom: false})));
        }

        // 2. Tambahkan Objek Kustom
        customObyekAccounts.filter(o => o.kode.startsWith(jenisKode)).forEach(obyek => {
             obyekList.push({...obyek, isCustom: true});
        });

        // 3. Urutkan
        obyekList.sort((a, b) => a.kode.localeCompare(b.kode));


        if (obyekList.length > 0) {
             // 4. Populate Dropdown
             obyekList.forEach(obyek => {const option = document.createElement('option');
                option.value = obyek.kode;
                const customLabel = obyek.isCustom ? ' (Kustom)' : '';
                option.textContent = `${obyek.kode} - ${obyek.nama}${customLabel}`;
                selectObyek.appendChild(option);
             });
             selectObyek.disabled = false;
        }

        if (selectedObyek) {
            selectObyek.value = selectedObyek;
        }
    }
}

// PERBAIKAN: Fungsi untuk menghasilkan placeholder/uraian Objek Belanja
function generateUraianPlaceholder() {
    const obyekKode = document.getElementById('detailObyekAkun').value;
    const inputUraian = document.getElementById('detailUraian');
    
    if (obyekKode) {
        let obyekNama = '';
        const [k, j, t, o] = obyekKode.split('.');
        
        // Cari di hardcoded list
        BELANJA_ACCOUNTS.forEach(kelompok => {
            if (kelompok.kode === `${k}`) {
                kelompok.jenis.forEach(jenis => {
                    if (jenis.kode === `${k}.${j}.${t}`) {
                        jenis.obyek.forEach(obyek => {
                            if (obyek.kode === obyekKode) {
                                obyekNama = obyek.nama;
                            }
                        });
                    }
                });
            }
        });
        
        // Cek juga di akun kustom
        if (!obyekNama) {
            const customObyek = customObyekAccounts.find(o => o.kode === obyekKode);
            if (customObyek) obyekNama = customObyek.nama;
        }

        inputUraian.placeholder = `Rincian: ${obyekNama} (Wajib Diisi)`;
    } else {
        inputUraian.placeholder = 'Rincian Obyek/Uraian Detail Belanja (Wajib Diisi)';
    }
}

function populateBelanjaAccounts() {
    populateJenisAkun();
    // Tidak perlu memanggil populateObyekAkunSelectModal() di sini.
}

// NEW: Fungsi untuk membuka modal pemilihan Level 5
function showSelectObyekModal() {
    if (!checkAuthentication()) return;
    
    const selectJenisModal = document.getElementById('selectObyekJenisAkun');
    const selectObyek = document.getElementById('selectObyekObyekAkun');
    
    if (!selectJenisModal || !selectObyek) return; 

    // PENTING: Panggil populateJenisAkun() untuk memastikan dropdown utama terisi
    // karena modal ini akan menyalin isinya.
    populateJenisAkun(); 
    
    // Salin Opsi Level 3 dari dropdown utama ke dropdown modal
    // Clear old options in modal
    selectJenisModal.innerHTML = '<option value="">-- Pilih Jenis Belanja --</option>';

    // Re-populate modal's Level 3 options from data
    BELANJA_ACCOUNTS.forEach(kelompok => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = `${kelompok.kode} ${kelompok.nama}`;
        
        kelompok.jenis.forEach(jenis => {
            const option = document.createElement('option');
            option.value = jenis.kode;
            option.textContent = `${jenis.kode} - ${jenis.nama}`; 
            optgroup.appendChild(option);
        });
        selectJenisModal.appendChild(optgroup);
    });

    selectJenisModal.value = ''; // Reset pilihan
    
    // Reset Level 5 di modal Level 5
    selectObyek.innerHTML = '<option value="">-- Pilih Objek Belanja --</option>'; 
    selectObyek.disabled = true;
    
    document.getElementById('selectObyekModal').style.display = 'flex';
}

// NEW: Fungsi untuk konfirmasi pemilihan Level 5 dan membuka modal rincian
function confirmObyekSelectionAndOpenDetail() {
    const selectedObyek = document.getElementById('selectObyekObyekAkun').value;
    if (!selectedObyek) {
        alert("Silakan pilih Objek Belanja (Level 5) terlebih dahulu.");
        return;
    }
    
    currentObyekAkun = selectedObyek; // Set Level 5 aktif
    document.getElementById('selectObyekModal').style.display = 'none';
    
    // Buka modal rincian Level 6 (mode input berkelanjutan)
    tampilkanFormDetailBelanja( -1, currentObyekAkun); 
}

// NEW: Fungsi untuk mengganti Objek Level 5 (dipanggil dari form Detail/Level 6)
function changeObyekAndCloseDetail() {
    currentObyekAkun = ''; // Reset Level 5 yang aktif
    tutupFormDetail();
    // Tidak perlu renderDetailBelanja() di sini karena akan dilakukan di showSelectObyekModal() -> tampilkanFormDetailBelanja()
    showSelectObyekModal();
}

// START: PERBAIKAN - Fungsi untuk mengisi dropdown RKPDes di modal RAB
function populateRKPDesSelect() {
    const select = document.getElementById('select_from_rkpdes');
    if (!select) return;

    select.innerHTML = '<option value="">-- Pilih Rencana dari RKPDes --</option>';
    
    // Mengambil data RKP tahun berjalan
    const rkpItems = getRKPData(); 

    // Filter RKP yang belum dibuatkan RAB-nya (PENTING: Cek tahun RAB)
    const availableRkpItems = rkpItems.filter(rkp => 
        !rabData.some(rab => rab.rkpId === rkp.id && parseInt(rab.rabTahun) === currentFilterYear)
    );

    availableRkpItems.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;
        // Format tampilan: BidangKode - KegiatanNama (Uraian/Sub Kegiatan)
        const bidangKode = item.bidang.split(' ')[0];
        option.textContent = `${bidangKode} - ${item.kegiatan} (${item.uraian_kegiatan})`;
        select.appendChild(option);
    });
}

// START: PERBAIKAN - Fungsi untuk mengisi form RAB dari pilihan RKPDes
function populateRABFormFromRKP() {
    const select = document.getElementById('select_from_rkpdes');
    const selectedRkpId = select.value;

    if (selectedRkpId === '') {
        document.getElementById('rabBidang').value = '';
        populateSubBidang(); // Reset sub bidang & kegiatan
        document.getElementById('rabSubKegiatanNama').value = '';
        document.getElementById('rabWaktuPelaksanaan').value = '';
        return;
    }

    const item = getRKPData().find(rkp => rkp.id === selectedRkpId);
    if (item) {
        const bidangKode = item.bidang.split(' ')[0];
        const subBidangKode = item.subbidang.split(' ')[0];

        // 1. Isi dropdown Bidang dan trigger pemuatan Sub Bidang
        document.getElementById('rabBidang').value = bidangKode;
        populateSubBidang(subBidangKode); 
        
        // 2. Tunda sebentar untuk memastikan Sub Bidang terisi, lalu set Kegiatan
        setTimeout(() => {
            document.getElementById('rabSubBidang').value = subBidangKode;
            populateKegiatan(item.kegiatan_code); // Set kegiatan dan trigger pemuatan kegiatan
            
            // 3. Tunda sebentar untuk memastikan Kegiatan terisi (opsional, tapi aman)
            setTimeout(() => {
                document.getElementById('rabKegiatan').value = item.kegiatan_code;
                
                // 4. Isi Uraian Sub Kegiatan (Level 4) dan Waktu Pelaksanaan
                document.getElementById('rabSubKegiatanNama').value = item.uraian_kegiatan;
                document.getElementById('rabWaktuPelaksanaan').value = item.waktu_pelaksanaan;
                
            }, 50);
        }, 50);
    }
}
// END: PERBAIKAN

// RAB Kegiatan
function tampilkanFormRAB(index = -1) {
    if (!checkAuthentication()) return;
    const formModal = document.getElementById('formRABModal');
    document.getElementById('rabKegiatanIndex').value = index;
    
    const rabTitleElement = document.getElementById('formRABTitle');
    
    const titleText = index === -1 ? 'â• Tambah Kegiatan RAB' : 'âœï¸ Edit Kegiatan RAB';
    rabTitleElement.innerHTML = `${titleText} (Tahun Aktif: <span id="rab_modal_year">${currentFilterYear}</span>)`;

    // --- START: Perbaikan Utama untuk memastikan dropdown Bidang terisi ---
    
    // 1. Panggil fungsi untuk mengisi dropdown Bidang (WAJIB dipanggil setiap buka form)
    populateBidang(); 
    
    // 2. Panggil fungsi untuk mengisi dropdown RKPDes (Untuk Impor)
    populateRKPDesSelect();
    
    // 3. Panggil fungsi untuk mengisi dropdown Jenis Belanja Level 3 (Untuk Detail RAB, penting sebelum buka modal Level 5)
    populateJenisAkun(); 

    // --- END: Perbaikan Utama ---

    document.getElementById('rabJenisApbdes').value = 'RAPBDes';
    document.getElementById('rabBidang').value = '';
    document.getElementById('rabWaktuPelaksanaan').value = '';
    
    document.getElementById('rabSubKegiatanNama').value = ''; 
    
    document.getElementById('rabSubBidang').innerHTML = '<option value="">-- Pilih Sub Bidang --</option>';
    document.getElementById('rabSubBidang').disabled = true;
    document.getElementById('rabKegiatan').innerHTML = '<option value="">-- Pilih Kegiatan --</option>';
    document.getElementById('rabKegiatan').disabled = true;
    
    // Reset dropdown impor RKPDes
    document.getElementById('select_from_rkpdes').value = ''; 

    if (index !== -1) {
        const rab = rabData[index];
        document.getElementById('rabJenisApbdes').value = rab.jenisApbdes;
        document.getElementById('rabBidang').value = rab.bidangKode;
        
        // Memastikan dropdown terisi sebelum menetapkan nilai
        populateSubBidang(rab.subBidangKode); 
        
        setTimeout(() => {
            if(rab.kegiatanKode) {
                populateKegiatan(rab.kegiatanKode);
            }
        }, 100); 

      document.getElementById('rabWaktuPelaksanaan').value = rab.waktuPelaksanaan;
        document.getElementById('rabSubKegiatanNama').value = rab.subKegiatanNama || '';
        
        // Disable impor jika sedang mode edit
        document.getElementById('select_from_rkpdes').disabled = true;
    } else {
        document.getElementById('select_from_rkpdes').disabled = false;
    }

    formModal.style.display = 'flex';
}

function tutupFormRAB() {
    document.getElementById('formRABModal').style.display = 'none';
}

function simpanRABKegiatan() {
    if (!checkAuthentication()) return; // Tambahkan return untuk menghentikan jika autentikasi gagal
    const index = parseInt(document.getElementById('rabKegiatanIndex').value);
    
    const rkpId = document.getElementById('select_from_rkpdes').value;
    
    const jenisApbdes = document.getElementById('rabJenisApbdes').value;
    const bidangKode = document.getElementById('rabBidang').value;
    const subBidangKode = document.getElementById('rabSubBidang').value;
    const kegiatanKode = document.getElementById('rabKegiatan').value;
    const waktuPelaksanaan = document.getElementById('rabWaktuPelaksanaan').value;
    const subKegiatanNama = document.getElementById('rabSubKegiatanNama').value;

    if (!bidangKode || !subBidangKode || !kegiatanKode || !waktuPelaksanaan || !subKegiatanNama) {
        alert("Semua field harus diisi!"); return; 
    }

    const { bidangNama, subBidangNama, kegiatanNama } = getKegiatanDataByCode(bidangKode, subBidangKode, kegiatanKode);
    const id = index === -1 ? 'rab_' + Date.now() : rabData[index].id;

    const newRAB = {
        id,
        rkpId: rkpId || null,
        rabTahun: currentFilterYear, 
        jenisApbdes,
        bidangKode,
        bidangNama,
        subBidangKode,
        subBidangNama,
        kegiatanKode,
        kegiatanNama,
        subKegiatanNama,
        waktuPelaksanaan,
        totalAnggaran: 0,
        detailBelanja: [] 
    };

    if (index === -1) {
        rabData.push(newRAB);
        alert('Kegiatan RAB berhasil ditambahkan!');
    } else {
        newRAB.detailBelanja = rabData[index].detailBelanja; 
        newRAB.totalAnggaran = calculateRABTotal(newRAB); 
        rabData[index] = newRAB;
        alert('Kegiatan RAB berhasil diperbarui!');
    }

    saveData('rabData', rabData);
    renderRABKegiatan();
    tutupFormRAB();
}
function editRABKegiatan(id) {
    const index = rabData.findIndex(r => r.id === id);
    if (index > -1) tampilkanFormRAB(index);
}

function duplicateRABKegiatan(id) {
    if (!checkAuthentication()) return;
    if (authenticatedUser.role !== 'admin') { 
        alert('Akses ditolak. Hanya Admin yang dapat menduplikasi RAB.'); 
        return; 
    }
    
    const originalRAB = rabData.find(r => r.id === id);
    if (!originalRAB) {
        alert("Kegiatan RAB asli tidak ditemukan.");
        return;
    }

    const subKegiatanDisplay = originalRAB.subKegiatanNama || 'Belum Diisi';
    if (!confirm(`Anda yakin ingin menduplikasi kegiatan':\n"${originalRAB.kegiatanNama} > ${subKegiatanDisplay}"\nke Tahun Anggaran AKTIF saat ini (${currentFilterYear})?`)) {
        return;
    }

    const newRAB = JSON.parse(JSON.stringify(originalRAB));
    newRAB.id = 'rab_' + Date.now() + '_copy';
    newRAB.rabTahun = currentFilterYear;
    
    const originalName = originalRAB.kegiatanNama.substring(originalRAB.kegiatanNama.startsWith("DUPLIKAT - ") ? 11 : 0);
    newRAB.kegiatanNama = "DUPLIKAT - " + originalName;
    
    const originalSubName = (originalRAB.subKegiatanNama || '').startsWith("DUPLIKAT - ") 
        ? (originalRAB.subKegiatanNama).substring(11) 
        : (originalRAB.subKegiatanNama || '');
        
    newRAB.subKegiatanNama = "DUPLIKAT - " + originalSubName;
    
    rabData.push(newRAB);
    saveData('rabData', rabData);

    renderRABKegiatan();
    alert(`âœ… Kegiatan RAB "${originalName}" berhasil diduplikasi ke Tahun Anggaran ${currentFilterYear}.`);
}

function hapusRABKegiatan(id) {
    if (!checkAuthentication()) return;
    if (confirm("Apakah Anda yakin ingin menghapus Kegiatan RAB ini beserta semua Rincian Belanja di dalamnya? Aksi ini tidak dapat dibatalkan.")) {
        const index = rabData.findIndex(r => r.id === id);
        if (index > -1) {
            rabData.splice(index, 1);
            saveData('rabData', rabData);
            renderRABKegiatan();
            alert("Kegiatan RAB berhasil dihapus.");
        }
    }
}


function renderRABKegiatan() {
    if (!checkAuthentication()) return;
    
    const selectedBidangKode = document.getElementById('rab_bidang_filter')?.value;
    
    let filteredRAB = rabData.filter(rab => parseInt(rab.rabTahun) === currentFilterYear);
    
    if (selectedBidangKode) {
        filteredRAB = filteredRAB.filter(rab => rab.bidangKode === selectedBidangKode);
    }
    
    const tableBody = document.querySelector('#tabelRABKegiatan tbody');
    if (!tableBody) return;
    tableBody.innerHTML = '';
    
    const itemsToDisplay = filteredRAB; 

    if (itemsToDisplay.length === 0) {
        let message = 'Belum ada data Kegiatan RAB.';
        if (selectedBidangKode) {
             message = `Belum ada data Kegiatan RAB untuk Bidang ${selectedBidangKode}.`;
        }
        tableBody.innerHTML = `<tr><td colspan="5" style="padding: 20px; color: #777;">${message} Silakan tambahkan.</td></tr>`;
        document.getElementById('rab_grand_total_output').textContent = formatRupiah(0);
        return;
    }

    const groupedRAB = itemsToDisplay.reduce((acc, rab, index) => {
        rab.originalIndex = rabData.findIndex(r => r.id === rab.id); 
        const key = rab.bidangKode;
        if (!acc[key]) {
            acc[key] = { nama: rab.bidangNama, kode: rab.bidangKode, items: [] };
        }
        acc[key].items.push(rab);
        return acc;
    }, {});

    const sortedBidangKeys = Object.keys(groupedRAB).sort((a, b) => parseInt(a) - parseInt(b));

    const totalAnggaranFiltered = filteredRAB.reduce((sum, rab) => sum + calculateRABTotal(rab), 0);
    
    for (const kodeBidang of sortedBidangKeys) {
        const bidangGroup = groupedRAB[kodeBidang];
        let totalBidang = 0;

        const headerRow = tableBody.insertRow();
        headerRow.style.backgroundColor = '#b2dfdb';
        headerRow.style.fontWeight = 'bold';
        headerRow.innerHTML = `
            <td colspan="5" style="text-align: left; padding: 10px 12px; font-size: 16px; color: #004d40;">
                BIDANG: ${bidangGroup.kode} ${bidangGroup.nama}
            </td>
        `;
        
        bidangGroup.items.sort((a, b) => {
            if (a.subBidangKode < b.subBidangKode) return -1;
            if (a.subBidangKode > b.subBidangKode) return 1;
            if (a.kegiatanKode < b.kegiatanKode) return -1;
            if (a.kegiatanKode > b.kegiatanKode) return 1;
            return 0;
        });


        bidangGroup.items.forEach((rab) => {
            const total = calculateRABTotal(rab);
            rab.totalAnggaran = total; 

            totalBidang += total;

            const row = tableBody.insertRow();
            
            if (isPrintingMode) { row.style.pageBreakInside = 'avoid'; }

            const subKegiatanDisplay = rab.subKegiatanNama || 'Belum Diisi';

            row.innerHTML = `
                <td>${rab.jenisApbdes}</td>
                <td style="text-align: left;">
                    <strong style="color: #00796b;">${rab.subBidangKode} ${rab.subBidangNama}</strong>
                    <br>${rab.kegiatanKode} ${rab.kegiatanNama}
                    <br><span style="font-size: 0.9em; font-style: italic;">(Sub Kegiatan: ${subKegiatanDisplay})</span>
                </td>
                <td>${rab.waktuPelaksanaan}</td>
                <td style="text-align: right;">${formatRupiah(total, true)}</td>
                <td class="rab-actions">
                    <button onclick="bukaDetailRAB(${rab.originalIndex})" style="background: #1e88e5;">ğŸ“‹ Detil</button>
                    <button onclick="duplicateRABKegiatan('${rab.id}')" style="background: #ff9800; margin-bottom: 5px;">ğŸ“ Duplikat</button>
                    <button onclick="editRABKegiatan('${rab.id}')">âœï¸ Edit</button>
                    <button onclick="hapusRABKegiatan('${rab.id}')" class="delete">ğŸ—‘ï¸ Hapus</button>
                </td>
            `;
        });

        const totalBidangRow = tableBody.insertRow();
        totalBidangRow.style.backgroundColor = '#e0f2f1'; 
        totalBidangRow.style.fontWeight = 'bold';
        totalBidangRow.innerHTML = `
            <td colspan="3" style="text-align: right; padding: 10px 12px;">TOTAL BIDANG INI</td>
            <td style="text-align: right;">${formatRupiah(totalBidang, true)}</td>
            <td></td>
        `;
    }
    
    document.getElementById('rab_grand_total_output').textContent = formatRupiah(totalAnggaranFiltered, true);
    saveData('rabData', rabData);
}

function applyRABBidangFilter() {
    renderRABKegiatan();
}

function clearRABBidangFilter() {
    const selectFilter = document.getElementById('rab_bidang_filter');
    if (selectFilter) {
        selectFilter.value = '';
    }
    renderRABKegiatan();
}


function bukaDetailRAB(index) {
    if (!checkAuthentication()) return;
    currentRABIndex = index;
    const rab = rabData[index];
    if (!rab) { alert("Gagal memuat data. Data RAB tidak ditemukan."); showModule(null, 'RABKegiatanModule'); return; }
    
    document.querySelectorAll('.module-content').forEach(module => module.classList.remove('active'));
    document.getElementById('RABDetailModule').classList.add('active'); 
    
    const subKegiatanDisplay = rab.subKegiatanNama || '[Sub Kegiatan Belum Diisi]';

   document.getElementById('detailHeaderApbdes').textContent = `${rab.jenisApbdes} | ${rab.bidangKode} ${rab.bidangNama}`;
    document.getElementById('detailHeaderKegiatan').textContent = `${rab.kegiatanKode} ${rab.kegiatanNama} > ${subKegiatanDisplay}`;
    document.getElementById('detailHeaderWaktu').textContent = `Waktu: ${rab.waktuPelaksanaan}`;
    
    renderDetailBelanja();
}
function kembaliKeDaftarRAB() { 
    currentObyekAkun = '';
    showModule(null, 'RABKegiatanModule'); 
}

function renderDetailBelanja() {
    if (!checkAuthentication()) return;
    if (currentRABIndex === -1 || !rabData[currentRABIndex]) return;

    const rab = rabData[currentRABIndex];
    if (!rab.detailBelanja || !Array.isArray(rab.detailBelanja)) { rab.detailBelanja = []; }
    
    const detailBelanja = rab.detailBelanja;
    const tableBody = document.querySelector('#tabelDetailBelanja tbody');
    if (!tableBody) return;
    tableBody.innerHTML = '';

    let totalJumlah = 0;
    let currentLevel5 = '';

    if (detailBelanja.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="9" style="padding: 15px; color: #777;">Belum ada rincian belanja untuk kegiatan ini.</td></tr>';
    } else {
        detailBelanja.sort((a, b) => a.kodeAkun.localeCompare(b.kodeAkun));
        
        detailBelanja.forEach((item, index) => {
            const jumlah = (cleanAndParseFloat(item.volume) || 0) * (cleanAndParseFloat(item.hargaSatuan) || 0);
            totalJumlah += jumlah;
            
            const kodeAkunPenuh = item.kodeAkun;
            const uraianRincian = item.uraian.startsWith(item.obyekNama) ? item.uraian : `${item.obyekNama} (${item.uraian})`;

            if (currentLevel5 !== kodeAkunPenuh) {
                const obyekTotal = detailBelanja
                    .filter(d => d.kodeAkun === kodeAkunPenuh)
                    .reduce((sum, d) => sum + (cleanAndParseFloat(d.volume) * cleanAndParseFloat(d.hargaSatuan)), 0);
                    
                const headerRow = tableBody.insertRow();
                headerRow.style.backgroundColor = '#b2dfdb';
                headerRow.style.fontWeight = 'bold';
                headerRow.innerHTML = `
                    <td colspan="5" style="text-align: left; padding: 10px 12px; font-size: 13px; color: #004d40;">
                        OBJEK (LEVEL 5): ${kodeAkunPenuh} ${item.obyekNama}
                    </td>
                    <td style="text-align: right; font-size: 13px; color: #004d40;">
                        ${formatRupiah(obyekTotal)}
                    </td>
                    <td colspan="3"></td>
                `;
                currentLevel5 = kodeAkunPenuh;
            }
            
            const row = tableBody.insertRow();
            
            if (isPrintingMode) { row.style.pageBreakInside = 'avoid'; }

            row.innerHTML = `
                <td>${index + 1}</td> 
                <td style="text-align: left;"> 
                    <strong style="color: #00796b;">${item.uraian}</strong>
                </td>
                <td>${item.sumberDana}</td> <td>${item.volume} ${item.satuan}</td> <td style="text-align: right;">${item.hargaSatuan}</td> <td style="text-align: right;">${formatRupiah(jumlah, true)}</td> <td> ${item.namaPKA || 'Belum Diisi'} 
                    <br> <span style="font-size:10px; font-style:italic;">(${item.pka})</span>
                </td>
                <td>${item.ket}</td> <td class="rab-actions">
                    <button onclick="editDetailBelanja(${index})">âœï¸</button>
                    <button onclick="hapusDetailBelanja(${index})">ğŸ—‘ï¸</button>
                </td>
            `;
        });
    }
    
    const activeObyekDisplay = document.getElementById('activeObyekDisplay');
    const modalJenisAkunGroup = document.getElementById('formDetailModalJenisAkunGroup');
    const modalObyekAkunGroup = document.getElementById('formDetailModalObyekAkunGroup');
    const btnSimpanDanLanjut = document.getElementById('btnSimpanDanLanjut');

    if (currentObyekAkun) {
        activeObyekDisplay.style.display = 'block';
        document.getElementById('activeObyekKode').textContent = currentObyekAkun;
        
        let obyekNamaAktif = '';
        const jenisKode = currentObyekAkun.split('.').slice(0, 3).join('.');
        let selectedJenis = BELANJA_ACCOUNTS.flatMap(k => k.jenis).find(j => j.kode === jenisKode);
        if (selectedJenis) {
            const obyek = selectedJenis.obyek.find(o => o.kode === currentObyekAkun) || customObyekAccounts.find(o => o.kode === currentObyekAkun);
            obyekNamaAktif = obyek ? obyek.nama : '[Nama Objek Tidak Ditemukan]';
        }
        document.getElementById('activeObyekNama').textContent = obyekNamaAktif;
        document.getElementById('detailObyekAktifKode').value = currentObyekAkun;
        
        modalJenisAkunGroup.style.display = 'none';
        modalObyekAkunGroup.style.display = 'none';
        btnSimpanDanLanjut.style.display = 'inline-block';
    } else {
        activeObyekDisplay.style.display = 'none';
        modalJenisAkunGroup.style.display = 'block';
        modalObyekAkunGroup.style.display = 'block';
        btnSimpanDanLanjut.style.display = 'none';
    }


    document.getElementById('detailHeaderTotal').textContent = formatRupiah(totalJumlah, true);
    document.getElementById('detail-total-jumlah').textContent = formatRupiah(totalJumlah, true);
    
    rabData[currentRABIndex].totalAnggaran = totalJumlah;
    saveData('rabData', rabData);
    if (document.getElementById('RABKegiatanModule').classList.contains('active')) {
        renderRABKegiatan();
    }
}
function tampilkanFormDetailBelanja(index = -1, obyekKode = null) {
    if (!checkAuthentication()) return;
    if (currentRABIndex === -1) { alert("Kesalahan: Kegiatan RAB belum dipilih."); return; }
    
    const formModal = document.getElementById('formDetailModal');
    document.getElementById('detailKegiatanIndex').value = currentRABIndex;
    document.getElementById('detailIndex').value = index;
    
    document.getElementById('formDetailTitle').textContent = index === -1 ? 'â• Tambah Detil Belanja' : 'âœï¸ Edit Detil Belanja';

    const isNewEntry = index === -1;
    if (isNewEntry && !currentObyekAkun) {
        showSelectObyekModal();
        return; 
    }
    
    document.getElementById('detailJenisAkun').value = ''; 
    document.getElementById('detailObyekAkun').innerHTML = '<option value="">-- Pilih Objek Belanja --</option>'; 
    document.getElementById('detailObyekAkun').disabled = true;
    
    document.getElementById('detailUraian').value = '';
    document.getElementById('detailSumberDana').value = 'DD';
    document.getElementById('detailVolume').value = '';
    document.getElementById('detailSatuan').value = '';
    document.getElementById('detailHargaSatuan').value = '';
    document.getElementById('detailKet').value = '';

    loadCustomPKAList(); 
    document.getElementById('selectPKAFromList').value = '';


    if (index !== -1) {
        const item = rabData[currentRABIndex].detailBelanja[index];
        const kodeAkunArr = item.kodeAkun.split('.');
        const jenisKode = kodeAkunArr.slice(0, 3).join('.');
        const obyekKode = kodeAkunArr.join('.');
        
        currentObyekAkun = obyekKode; 
        
        populateJenisAkun(jenisKode); 
        setTimeout(() => {
             populateObyekAkun(obyekKode); 
        }, 100); 

        document.getElementById('detailUraian').value = item.uraian;
        document.getElementById('detailSumberDana').value = item.sumberDana;
        document.getElementById('detailVolume').value = item.volume;
        document.getElementById('detailSatuan').value = item.satuan;
        document.getElementById('detailHargaSatuan').value = item.hargaSatuan;
        document.getElementById('detailKet').value = item.ket;
        const pkaValue = `${item.namaPKA}|${item.pka}`;
        populatePKASelect(pkaValue);

    } else if (currentObyekAkun) {
        const jenisKode = currentObyekAkun.split('.').slice(0, 3).join('.');
        populateJenisAkun(jenisKode); 
        setTimeout(() => {
             populateObyekAkun(currentObyekAkun);
        }, 100); 
        
        populatePKASelect();
        
    } else {
        populateJenisAkun();
        populatePKASelect();
    }
    
    renderDetailBelanja(); 

    const btnSimpanLanjut = document.getElementById('btnSimpanDanLanjut');
    if(btnSimpanLanjut) {
        btnSimpanLanjut.style.display = (index === -1 && currentObyekAkun) ? 'inline-block' : 'none';
    }
    
    formModal.style.display = 'flex';
}
function tutupFormDetail() { 
    document.getElementById('formDetailModal').style.display = 'none'; 
}

function simpanDetailBelanja(isContinue = false) {
    if (!checkAuthentication()) return;
    const rabIndex = parseInt(document.getElementById('detailKegiatanIndex').value);
    const detailIndex = parseInt(document.getElementById('detailIndex').value);

    const kodeAkunPenuh = currentObyekAkun || document.getElementById('detailObyekAkun').value;
    const isEditMode = detailIndex !== -1;

    if (!kodeAkunPenuh) { 
        alert("Silakan pilih Objek Belanja Level 5 terlebih dahulu di form pemilihan."); 
        document.getElementById('formDetailModal').style.display = 'none';
        showSelectObyekModal();
        return; 
    }
    
    const jenisAkun = kodeAkunPenuh.split('.').slice(0, 3).join('.');
    
    const uraian = document.getElementById('detailUraian').value.trim(); 
    
    const sumberDana = document.getElementById('detailSumberDana').value;
    
    const volume = cleanAndParseFloat(document.getElementById('detailVolume').value);
    const satuan = document.getElementById('detailSatuan').value;
    const hargaSatuan = cleanAndParseFloat(document.getElementById('detailHargaSatuan').value);
    
    const selectPKA = document.getElementById('selectPKAFromList').value;
    const [savedNamaPKA, savedPkaJabatan] = selectPKA.split('|');

    const ket = document.getElementById('detailKet').value;

    if (!kodeAkunPenuh || !uraian || !sumberDana || !satuan || !ket || !savedNamaPKA || !savedPkaJabatan) { 
        alert("Semua field harus diisi dengan benar, terutama Kode Rekening (Level 5 sudah dipilih), Rincian Obyek (Level 6), Volume, Harga Satuan, dan PKA."); 
        return; 
    }
    if (volume <= 0 || hargaSatuan < 0) { alert("Volume harus lebih besar dari 0 dan Harga Satuan tidak boleh negatif."); return; }
    if (isNaN(volume) || isNaN(hargaSatuan)) { alert("Volume atau Harga Satuan yang diinput tidak valid."); return; }
    
    let obyekNama = '';
    BELANJA_ACCOUNTS.forEach(kelompok => {
        kelompok.jenis.forEach(jenis => {
            if (jenis.kode === jenisAkun) {
                jenis.obyek.forEach(obyek => {
                    if (obyek.kode === kodeAkunPenuh) {
                        obyekNama = obyek.nama;
                    }
                });
            }
        });
    });
    const customObyek = customObyekAccounts.find(o => o.kode === kodeAkunPenuh);
    if (customObyek) obyekNama = customObyek.nama;


    const newDetail = {
        kodeAkun: kodeAkunPenuh, 
        obyekNama: obyekNama,
        uraian,
        sumberDana, 
        volume: formatRupiah(volume, false),
        satuan, 
        hargaSatuan: formatRupiah(hargaSatuan, true),
        namaPKA: savedNamaPKA, 
        pka: savedPkaJabatan,
        ket
    };
    
    if (!rabData[rabIndex].detailBelanja) { rabData[rabIndex].detailBelanja = []; }

    if (isEditMode) {
        rabData[rabIndex].detailBelanja[detailIndex] = newDetail;
        alert('Detil Belanja berhasil diperbarui!');
    } else {
        rabData[rabIndex].detailBelanja.push(newDetail);
        alert('Detil Belanja berhasil ditambahkan!');
    }

    saveData('rabData', rabData);
    renderDetailBelanja();
    
    if (isContinue) {
        document.getElementById('detailIndex').value = -1;
        document.getElementById('detailUraian').value = '';
        document.getElementById('detailVolume').value = '';
        document.getElementById('detailSatuan').value = '';
        document.getElementById('detailHargaSatuan').value = '';
        document.getElementById('detailKet').value = '';
        document.getElementById('detailUraian').focus();
        
        const btnSimpanLanjut = document.getElementById('btnSimpanDanLanjut');
        if(btnSimpanLanjut) {
            btnSimpanLanjut.style.display = 'inline-block';
        }
        
    } else {
        currentObyekAkun = '';
        tutupFormDetail();
    }
} 

function editDetailBelanja(index) { 
    const item = rabData[currentRABIndex].detailBelanja[index];
    currentObyekAkun = item.kodeAkun;
    tampilkanFormDetailBelanja(index); 
}
function hapusDetailBelanja(index) {
    if (!checkAuthentication()) return;
    if (confirm("Apakah Anda yakin ingin menghapus Rincian Belanja ini?")) {
        rabData[currentRABIndex].detailBelanja.splice(index, 1);
        saveData('rabData', rabData);
        renderDetailBelanja();
        alert("Rincian Belanja berhasil dihapus.");
    }
}


// 4.9 PENGATURAN
function saveRABSettings() {
    if (!checkAuthentication()) return;
    if (authenticatedUser.role !== 'admin') { alert('Akses ditolak. Hanya Admin.'); return; }

    desaSettings.namaKades = document.getElementById('settingNamaKades').value;
    desaSettings.namaSekdes = document.getElementById('settingNamaSekdes').value;
    desaSettings.namaKaurRen = document.getElementById('settingNamaKaurRen').value;

    saveData('desaSettings', desaSettings);
    alert('Pengaturan Tanda Tangan Utama berhasil disimpan.');
}
function loadRABSettings() {
    if (!checkAuthentication()) return;
    
    document.getElementById('settingNamaKades').value = desaSettings.namaKades || '';
    document.getElementById('settingNamaSekdes').value = desaSettings.namaSekdes || '';
    document.getElementById('settingNamaKaurRen').value = desaSettings.namaKaurRen || '';
    
    loadCustomPKAList(); 
    clearCustomPKAForm();
    
    loadCustomObyekAccounts(); 
    clearCustomObyekForm(); 
}

// 4.10 PKA & OBYEK MANAGEMENT
function loadCustomPKAList() {
    customPKAList = loadData('customPKAList', []);
    renderCustomPKATable();
}

function clearCustomPKAForm() {
    document.getElementById('pka_editing_index').value = '';
    document.getElementById('pka_nama_input').value = '';
    document.getElementById('pka_jabatan_input').value = 'KAUR PERENCANAAN';
    document.getElementById('pka_list_header').textContent = 'Kelola Daftar Pelaksana Teknis Kegiatan (PKA)';
}

function saveCustomPKA() {
    if (!checkAuthentication()) return;
    if (authenticatedUser.role !== 'admin') { alert('Akses ditolak. Hanya Admin.'); return; }

    const index = document.getElementById('pka_editing_index').value;
    const nama = document.getElementById('pka_nama_input').value;
    const jabatan = document.getElementById('pka_jabatan_input').value;

    if (!nama || !jabatan) { alert("Nama dan Jabatan PKA wajib diisi."); return; }
    
    const newPKA = { nama, jabatan, id: index || 'pka_' + Date.now() };
    
    if (index && index.startsWith('pka_')) {
        const idxToUpdate = customPKAList.findIndex(p => p.id === index);
        if (idxToUpdate > -1) {
            customPKAList[idxToUpdate] = newPKA;
            alert('Data PKA berhasil diperbarui.');
        }
    } else {
        if (customPKAList.some(p => p.nama.toLowerCase() === nama.toLowerCase() && p.jabatan.toLowerCase() === jabatan.toLowerCase())) {
            alert('Nama PKA dengan jabatan yang sama sudah ada dalam daftar.');
            return;
        }
        customPKAList.push(newPKA);
        alert('Data PKA berhasil ditambahkan.');
    }

    saveData('customPKAList', customPKAList);
    clearCustomPKAForm();
    loadCustomPKAList();
}

function editCustomPKA(id) {
    if (!checkAuthentication()) return;
    const pka = customPKAList.find(p => p.id === id);
    if (pka) {
        document.getElementById('pka_editing_index').value = pka.id;
        document.getElementById('pka_nama_input').value = pka.nama;
        document.getElementById('pka_jabatan_input').value = pka.jabatan;
        document.getElementById('pka_list_header').textContent = 'âœï¸ Edit Pelaksana Teknis Kegiatan (PKA)';
    }
}

function deleteCustomPKA(id) {
    if (!checkAuthentication()) return;
    if (confirm('Anda yakin ingin menghapus PKA ini?')) {
        customPKAList = customPKAList.filter(p => p.id !== id);
        saveData('customPKAList', customPKAList);
        loadCustomPKAList();
        alert('PKA berhasil dihapus.');
    }
}

function renderCustomPKATable() {
    const tableContainer = document.getElementById('pka_list_output');
    if (!tableContainer) return;
    
    let tableHtml = '<table class="data-table"><thead><tr><th>#</th><th>Nama Pegawai</th><th>Jabatan</th><th style="width: 15%;">Aksi</th></tr></thead><tbody>';

    if (customPKAList.length === 0) {
        tableHtml += '<tr><td colspan="4" style="padding: 15px; color: #777;">Belum ada daftar PKA yang diinput.</td></tr>';
    } else {
        customPKAList.forEach((pka, index) => {
            tableHtml += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${pka.nama}</td>
                    <td>${pka.jabatan}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editCustomPKA('${pka.id}')">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteCustomPKA('${pka.id}')">Hapus</button>
                    </td>
                </tr>
            `;
        });
    }
    tableHtml += '</tbody></table>';
    tableContainer.innerHTML = tableHtml;
}

// Populate the PKA selection dropdown in the detail modal
function populatePKASelect(selectedPKAValue = '') {
    const select = document.getElementById('selectPKAFromList');
    if (!select) return;

    select.innerHTML = '<option value="">-- Pilih Nama Pegawai PKA --</option>';

    customPKAList.forEach(pka => {
        const option = document.createElement('option');
        const value = `${pka.nama}|${pka.jabatan}`; 
        option.value = value;
        option.textContent = `${pka.nama} (${pka.jabatan})`;
        
        if (value === selectedPKAValue) {
            option.selected = true;
        }

        select.appendChild(option);
    });
    
    if (!selectedPKAValue && select.options.length > 1) {
        select.selectedIndex = 1; 
    }
}

// Set the hidden PKA name and visible Jabatan fields based on selection
function setPKAFields() {
    const select = document.getElementById('selectPKAFromList');
    if (!select.value && select.options.length > 1) {
        select.selectedIndex = 1;
    }
}

function loadCustomObyekAccounts() {
    customObyekAccounts = loadData('customObyekAccounts', []);
    renderCustomObyekTable();
    populateJenisAkun();
}

function clearCustomObyekForm() {
    document.getElementById('obyek_editing_id').value = '';
    document.getElementById('obyek_kode_input').value = '';
    document.getElementById('obyek_nama_input').value = '';
    document.getElementById('akun_belanja_list_header').textContent = 'Kelola Daftar Akun Belanja (Obyek) Tambahan';
}

function saveCustomObyekAccount() {
    if (!checkAuthentication()) return;
    if (authenticatedUser.role !== 'admin') { alert('Akses ditolak. Hanya Admin.'); return; }

    const id = document.getElementById('obyek_editing_id').value;
    const kode = document.getElementById('obyek_kode_input').value.trim();
    const nama = document.getElementById('obyek_nama_input').value.trim();

    if (!kode || !nama) { alert("Kode Akun dan Nama Obyek wajib diisi."); return; }
    if (!/^\d\.\d\.\d\.\d{2}$/.test(kode)) { alert("Format Kode Akun Obyek tidak valid (Contoh: 5.1.4.03)."); return; }
    
    const newObyek = { kode, nama, id: id || 'obyek_' + Date.now() };

    if (customObyekAccounts.some(o => o.kode === kode && o.id !== newObyek.id)) {
        alert('Kode Akun Obyek sudah ada dalam daftar.');
        return;
    }

    const index = customObyekAccounts.findIndex(o => o.id === newObyek.id);
    
    if (index > -1) {
        customObyekAccounts[index] = newObyek;
        alert('Data Akun Obyek berhasil diperbarui.');
    } else {
        customObyekAccounts.push(newObyek);
        alert('Data Akun Obyek berhasil ditambahkan.');
    }

    saveData('customObyekAccounts', customObyekAccounts);
    clearCustomObyekForm();
    loadCustomObyekAccounts();
}

function editCustomObyek(id) {
    if (!checkAuthentication()) return;
    const obyek = customObyekAccounts.find(o => o.id === id);
    if (obyek) {
        document.getElementById('obyek_editing_id').value = obyek.id;
        document.getElementById('obyek_kode_input').value = obyek.kode;
        document.getElementById('obyek_nama_input').value = obyek.nama;
        document.getElementById('akun_belanja_list_header').textContent = 'âœï¸ Edit Akun Belanja (Obyek) Tambahan';
    }
}

function deleteCustomObyek(id) {
    if (!checkAuthentication()) return;
    if (confirm('Anda yakin ingin menghapus Akun Obyek ini?')) {
        customObyekAccounts = customObyekAccounts.filter(o => o.id !== id);
        saveData('customObyekAccounts', customObyekAccounts);
        loadCustomObyekAccounts();
        alert('Akun Obyek berhasil dihapus.');
    }
}

function renderCustomObyekTable() {
    const tableContainer = document.getElementById('obyek_list_output');
    if (!tableContainer) return;
    
    let tableHtml = '<table class="data-table"><thead><tr><th>#</th><th>Kode Akun Obyek</th><th>Nama Uraian Obyek</th><th style="width: 15%;">Aksi</th></tr></thead><tbody>';

    if (customObyekAccounts.length === 0) {
        tableHtml += '<tr><td colspan="4" style="padding: 15px; color: #777;">Belum ada daftar Akun Belanja (Obyek) tambahan yang diinput.</td></tr>';
    } else {
        customObyekAccounts.sort((a, b) => a.kode.localeCompare(b.kode));
        customObyekAccounts.forEach((obyek, index) => {
            tableHtml += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${obyek.kode}</td>
                    <td>${obyek.nama}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editCustomObyek('${obyek.id}')">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteCustomObyek('${obyek.id}')">Hapus</button>
                    </td>
                </tr>
            `;
        });
    }
    tableHtml += '</tbody></table>';
    tableContainer.innerHTML = tableHtml;
}

// 4.11 MANAJEMEN PENGGUNA (dengan logic demo)
function clearUserForm() {
    document.getElementById('user_editing_id').value = '';
    document.getElementById('user_username').value = '';
    document.getElementById('user_password').value = '';
    document.getElementById('user_role').value = 'operator';
    document.getElementById('user_is_demo').checked = false;
}

async function saveUser() {
    if (!checkAuthentication()) return;
    if (authenticatedUser.role !== 'admin') { 
        alert('Akses ditolak. Hanya Admin.'); 
        return; 
    }

    const id = document.getElementById('user_editing_id').value;
    const username = document.getElementById('user_username').value;
    const password = document.getElementById('user_password').value;
    const role = document.getElementById('user_role').value;
    const isDemo = document.getElementById('user_is_demo').checked;
    let expirationDate = null;

    if (!username) { alert("Username wajib diisi!"); return; }

    const isEditing = id !== '';
    let userIndex = -1;
    let userToEdit = null;

    if (isEditing) {
        userIndex = UserData.findIndex(u => u.id === id);
        if (userIndex === -1) {
            alert("Pengguna tidak ditemukan.");
            return;
        }
        userToEdit = UserData[userIndex];
    } else {
        if (UserData.some(u => u.username.toLowerCase() === username.toLowerCase())) {
            alert('Username sudah digunakan.');
            return;
        }
    }

    const newUser = userToEdit || { id: 'user_' + Date.now(), username, passwordHash: '', role, expirationDate: null };
    newUser.role = role;
    
    if (isDemo) {
        if (!isEditing || !newUser.expirationDate) {
             const date = new Date();
             date.setDate(date.getDate() + 7); 
             newUser.expirationDate = date.toISOString();
        } 
    } else {
        newUser.expirationDate = null;
    } 

    if (password) {
        showSplash("Mengenkripsi password...");
        try {
            newUser.passwordHash = await hashPassword(password);
        } catch(e) {
            newUser.passwordHash = hashPasswordSimple(password);
        }
        hideSplash();
    } else if (!isEditing) {
        alert("Password wajib diisi untuk pengguna baru!"); 
        return;
    }

    if (!isEditing) {
        UserData.push(newUser);
        alert('Pengguna baru berhasil ditambahkan!');
    } else {
        UserData[userIndex] = newUser;
        alert('Pengguna berhasil diperbarui!');
    }

    sipdesAuthData.users = UserData;
    saveData('UserData', UserData);
    saveData('sipdesAuthData', sipdesAuthData);
    clearUserForm();
    renderUserTable();
}

function editUser(id) {
    if (!checkAuthentication()) return;
    const user = UserData.find(u => u.id === id);
    if (user) {
        document.getElementById('user_editing_id').value = user.id;
        document.getElementById('user_username').value = user.username;
        document.getElementById('user_role').value = user.role;
        document.getElementById('user_is_demo').checked = !!user.expirationDate
        document.getElementById('user_password').value = ''; 
    }
}

function deleteUser(id) {
    if (!checkAuthentication()) return;
    if (id === authenticatedUser.id) {
        alert('Anda tidak dapat menghapus akun Anda sendiri.');
        return;
    }
    if (confirm('Anda yakin ingin menghapus akun pengguna ini?')) {
        UserData = UserData.filter(u => u.id !== id);
        sipdesAuthData.users = UserData;
        saveData('UserData', UserData);
        saveData('sipdesAuthData', sipdesAuthData);
        renderUserTable();
        alert('Pengguna berhasil dihapus.');
    }
}

function renderUserTable() {
    if (!checkAuthentication()) return;
    const tableContainer = document.getElementById('user_list_output');
    if (!tableContainer) return;
    
    let tableHtml = '<table class="data-table"><thead><tr>';
    tableHtml += '<th>#</th><th>Username</th><th>Peran</th><th>Status Akun</th><th>Aksi</th>';
    tableHtml += '</tr></thead><tbody>';

    if (UserData.length === 0) {
        tableHtml += '<tr><td colspan="5" style="padding: 15px; color: #777;">Belum ada daftar pengguna.</td></tr>';
    } else {
        UserData.forEach((user, index) => {
            const isSelf = user.username === authenticatedUser.username;
            const disableDelete = isSelf;
            
            let statusText = 'Normal/Permanen';
            let statusStyle = 'color: #00796b;'; 
            let expirationDisplay = '';
            
            if (user.expirationDate) {
                const expirationDate = new Date(user.expirationDate);
                const now = new Date();
                
                if (expirationDate < now) {
                    statusText = 'KEDALUWARSA!';
                    statusStyle = 'color: #d9534f; font-weight: bold;';
                } else {
                    const diffTime = expirationDate.getTime() - now.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    statusText = `Demo (${diffDays} hari tersisa)`;
                    statusStyle = 'color: #ff9800; font-weight: bold;';
                }
                expirationDisplay = `(Exp: ${expirationDate.toLocaleDateString('id-ID')})`;
            }

            tableHtml += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${user.username} ${isSelf ? '(Anda)' : ''}</td>
                    <td>${user.role}</td>
                    <td style="${statusStyle}">${statusText} ${expirationDisplay}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editUser('${user.id}')">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteUser('${user.id}')" ${disableDelete ? 'disabled' : ''}>Hapus</button>
                    </td>
                </tr>
            `;
        });
    }
    tableHtml += '</tbody></table>';
    tableContainer.innerHTML = tableHtml;
} 

// 4.12 LAPORAN & CETAK
/**
 * Fungsi utama untuk membuat KOP dan Tanda Tangan serta membungkus konten untuk dicetak.
 */
function generatePrintContentHTML(moduleId, moduleTitle, contentHtml, PKAData = null) {
    const { namaDesa, namaKecamatan, namaKabupaten, namaProvinsi, namaKades, namaSekdes, namaKaurRen, desaAlamat, desaKodePos, logoDataUrl } = desaSettings;
    const logoSrc = desaLogoBase64 || DEFAULT_SIPDES_LOGO_SVG; 
    
    const tempat = namaDesa;
    const dateStr = new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});

    const kopText = `
        <div class="letterhead-text">
            <p style="font-size: 10pt; font-weight: normal; margin-bottom: 3px;">PEMERINTAH KABUPATEN ${namaKabupaten.toUpperCase()}</p>
            <p style="font-size: 12pt; font-weight: bold; margin-bottom: 3px;">KECAMATAN ${namaKecamatan.toUpperCase()}</p>
            <h3 style="margin: 0; font-size: 16pt;">DESA ${namaDesa.toUpperCase()}</h3>
            <p style="margin: 3px 0 0; font-size: 10pt; font-weight: normal;">Alamat: ${desaAlamat || '[Alamat Belum Diisi]'} Kode Pos ${desaKodePos || '[Kode Pos]'}</p>
        </div>
    `;
    const headerHtml = `
        <div class="letterhead">
            <img class="logo" src="${logoSrc}" alt="Logo Desa">
            ${kopText}
        </div>
        <hr class="letterhead-hr">
    `;
    
    let signatureHtml = '';

    if (PKAData && PKAData.namaPKA && PKAData.jabatanPKA) {
         signatureHtml = `
            <div class="signature-container" style="justify-content: space-between; max-width: 900px; margin: 40px auto 0;">
                <div class="signature-block" style="width: 30%;">
                    <p style="margin: 0;">Disetujui,</p>
                    <p style="margin: 0;">KEPALA DESA ${namaDesa.toUpperCase()}</p>
                    <span class="signature-name" style="width: 100%;">${namaKades || '[Nama Kades Belum Diisi]'}</span>
                </div>
                <div class="signature-block" style="width: 30%;">
                    <p style="margin: 0;">Dibuat di ${tempat}, ${dateStr}</p>
                    <p style="margin: 0;">SEKRETARIS DESA</p>
                    <span class="signature-name" style="width: 100%;">${namaSekdes || '[Nama Sekdes Belum Diisi]'}</span>
                </div>
                <div class="signature-block" style="width: 30%;">
                    <p style="margin: 0;">Pelaksana Kegiatan Anggaran (PKA)</p>
                    <p style="margin: 0;">${PKAData.jabatanPKA.toUpperCase()}</p>
                    <span class="signature-name" style="width: 100%;">${PKAData.namaPKA || '[Nama PKA Belum Diisi]'}</span>
                </div>
            </div>
         `;
    } else {
        signatureHtml = `
            <div class="signature-container" style="justify-content: space-between; max-width: 900px; margin: 40px auto 0;">
                <div class="signature-block" style="width: 30%;">
                    <p style="margin: 0;">Mengetahui,</p>
                    <p style="margin: 0;">KEPALA DESA ${namaDesa.toUpperCase()}</p>
                    <span class="signature-name" style="width: 100%;">${namaKades || '[Nama Kades Belum Diisi]'}</span>
                </div>
                 <div class="signature-block" style="width: 30%;">
                    <p style="margin: 0;">Verifikator,</p>
                    <p style="margin: 0;">SEKRETARIS DESA</p>
                    <span class="signature-name" style="width: 100%;">${namaSekdes || '[Nama Sekdes Belum Diisi]'}</span>
                </div>
                <div class="signature-block" style="width: 30%;">
                    <p style="margin: 0;">Dibuat di ${tempat}, ${dateStr}</p>
                    <p style="margin: 0;">KAUR PERENCANAAN</p>
                    <span class="signature-name" style="width: 100%;">${namaKaurRen || '[Nama Kaur Perencanaan Belum Diisi]'}</span>
                </div>
            </div>
        `;
    }

    const style = document.querySelector('style').textContent;

    return `
        <!DOCTYPE html>
        <html>
        <head>
            <title>${moduleTitle} - Tahun ${currentFilterYear}</title>
            <style>${style}</style>
        </head>
        <body style="font-size: 10pt;">
            <div class="main-content">
                ${headerHtml}
                <h2 style="text-align: center; margin-bottom: 20px; font-size: 14pt;">${moduleTitle.toUpperCase()} TAHUN ANGGARAN ${currentFilterYear}</h2>
                <div id="print-area">${contentHtml}</div>
                
                <div style="page-break-before: auto;"></div>
                ${signatureHtml} 

                <div class="print-footer-info" style="margin-top: 20px;">
                    <p>Dicetak oleh SIPDes Sistem Informasi Perencanaan Desa pada ${new Date().toLocaleString('id-ID')} | Data Tahun Anggaran ${currentFilterYear}</p>
                </div>
            </div>
        </body>
        </html>
    `;
}

function cetakLaporanDariModul(targetModuleId) {
    if (!checkAuthentication()) return;

    const activeModule = document.querySelector('.module-content.active');
    const lastActiveModuleId = activeModule ? activeModule.id : 'Dashboard';
    if (activeModule) activeModule.classList.remove('active');

    const targetModule = document.getElementById(targetModuleId);
    if (!targetModule) {
        alert('Modul tidak ditemukan.');
        return;
    }
    targetModule.classList.add('active'); 
    
    isPrintingMode = true; 
    
    renderModuleData(targetModuleId);

    const moduleTitle = targetModule.querySelector('.module-header')?.textContent || targetModuleId;
    let contentHtml = '';

    switch(targetModuleId) {
        case 'Dashboard':
            contentHtml = document.querySelector('#Dashboard .stats-grid').outerHTML + '<h3>Catatan:</h3>' + document.querySelector('#Dashboard ul').outerHTML;
            break;
        case 'ProfilDesa':
            contentHtml = document.getElementById('profil_desa_output').innerHTML;
            break;
        case 'RPJMDes':
            contentHtml = document.getElementById('rpjm_des_output').innerHTML + 
                          '<h3>Rencana Kegiatan Jangka Menengah (RPJMDes)</h3>' +
                          document.getElementById('rpjm_detail_list_output').innerHTML;
            break;
        case 'RancanganAPBDES':
            contentHtml = '<h3>Ringkasan Anggaran per Bidang dan Sub Bidang</h3>' + 
                          document.getElementById('rapbdes_summary_output').innerHTML +
                          '<h3>Rekapan Anggaran per Sumber Dana</h3>' + 
                          document.getElementById('rapbdes_sumberdana_output').innerHTML +
                          `<h3 style="margin-top: 30px;">Total Anggaran RKP Tahun ${currentFilterYear}: <strong id="rapbdes_grand_total">${document.getElementById('rapbdes_grand_total').textContent}</strong></h3>`;
            break;
        case 'RencanaPembangunan':
            contentHtml = document.getElementById('rkp_list_output').innerHTML;
            break;
        case 'KegiatanPembangunan':
            contentHtml = document.getElementById('realisasi_list_output').innerHTML;
            break;
       case 'MonitoringEvaluasi':
            const monitoringOutputEl = document.getElementById('monitoring_output');
            const tempMonitoringContent = monitoringOutputEl.cloneNode(true);
            
            tempMonitoringContent.querySelectorAll('.monitoring-kegiatan .prog-container small:last-child').forEach(el => el.remove());

            contentHtml = tempMonitoringContent.innerHTML; 
            break;
        case 'InventarisKekayaan':
            contentHtml = document.getElementById('kekayaan_list_output').innerHTML;
            break;
        case 'InventarisHasil':
            contentHtml = document.getElementById('hasil_list_output').innerHTML;
            break;
        case 'RABKegiatanModule':
            contentHtml = generateRABKeseluruhanHTML();
            break;
        default:
            contentHtml = '<h1>Konten tidak tersedia untuk cetak cepat.</h1>';
            break;
    }

    const finalPrintHTML = generatePrintContentHTML(
        targetModuleId, 
        moduleTitle.replace(/\s*\(\w+.*$/, ''),
        contentHtml
    );

    const printWindow = window.open('', '_blank');
    printWindow.document.write(finalPrintHTML);
    printWindow.document.close();
    printWindow.focus();
    
    setTimeout(() => { 
        printWindow.print(); 
    }, 500);

    targetModule.classList.remove('active');
    if (activeModule) activeModule.classList.add('active');
    
    isPrintingMode = false;

    renderModuleData(lastActiveModuleId);
}

function cetakRABKeseluruhan() { 
    if (!checkAuthentication()) return;

    const activeModule = document.querySelector('.module-content.active');
    const lastActiveModuleId = activeModule ? activeModule.id : 'Dashboard';
    if (activeModule) activeModule.classList.remove('active');
    document.getElementById('RABKegiatanModule').classList.add('active'); 
    
    isPrintingMode = true; 
    
    renderRABKegiatan(); 


    const moduleTitle = `Rencana Anggaran Biaya (RAB) Keseluruhan`;
    const moduleContentHtml = generateRABKeseluruhanHTML();

    const finalPrintHTML = generatePrintContentHTML(
        'RABKeseluruhan', 
        moduleTitle, 
        moduleContentHtml
    );

    const printWindow = window.open('', '_blank');
    printWindow.document.write(finalPrintHTML);
    printWindow.document.close();
    printWindow.focus();
    
    setTimeout(() => { 
        printWindow.print(); 
    }, 500); 

    document.getElementById('RABKegiatanModule').classList.remove('active');
    if (activeModule) activeModule.classList.add('active');
    
    isPrintingMode = false;
    
    renderModuleData(lastActiveModuleId);
}

// FIX untuk mengaktifkan cetak RAB Detail
function cetakRABDetail() { 
    if (!checkAuthentication()) return;
    if (currentRABIndex === -1 || !rabData[currentRABIndex]) {
        alert("Pilih kegiatan detil RAB terlebih dahulu di modul 'ğŸ’° RAB (Rencana Anggaran Biaya)' dan masuk ke Detil Belanja.");
        return;
    }
    const rab = rabData[currentRABIndex];
    const moduleTitle = `Rincian Anggaran Biaya (RAB) Kegiatan`;
    
    const contentHtml = generateRABDetailHTML(rab); 

    let pkaDataForSignature = null;
    if (rab.detailBelanja && rab.detailBelanja.length > 0) {
        const firstDetail = rab.detailBelanja.find(d => d.namaPKA && d.pka); 
        if (firstDetail) {
            pkaDataForSignature = {
                namaPKA: firstDetail.namaPKA,
                jabatanPKA: firstDetail.pka
            };
        }
    }

    const finalPrintHTML = generatePrintContentHTML(
        'RABDetailModule', 
        moduleTitle, 
        contentHtml,
        pkaDataForSignature
    );

    const printWindow = window.open('', '_blank');
    printWindow.document.write(finalPrintHTML);
    printWindow.document.close();
    printWindow.focus();
    
    setTimeout(() => { 
        printWindow.print(); 
    }, 500); 
}


function generateRABDetailHTML(rab) {
    if (!rab.detailBelanja || rab.detailBelanja.length === 0) {
        return `<p style="color:red; text-align:center; font-weight:bold;">Tidak ada Detil Belanja untuk kegiatan ini.</p>`;
    }
    
    const totalAnggaran = calculateRABTotal(rab);
    
    const subKegiatanDisplay = rab.subKegiatanDisplay = rab.subKegiatanNama || 'Belum Diisi';

    let html = `
        <div style="margin-bottom: 20px; border: 1px solid #004d40; padding: 15px; background-color: #f0fdf9; page-break-inside: avoid;">
            <p style="margin: 0; font-size: 11pt;">
                <strong>Jenis APBDes:</strong> ${rab.jenisApbdes} |
                <strong>Bidang:</strong> ${rab.bidangKode} ${rab.bidangNama}
            </p>
            <p style="margin: 5px 0; font-size: 11pt;">
                <strong>Sub Bidang:</strong> ${rab.subBidangKode} ${rab.subBidangNama}
            </p>
            <h4 style="margin: 5px 0 0; color: #00796b; font-size: 12pt;"> KEGIATAN (Level 3): ${rab.kegiatanKode} ${rab.kegiatanNama}
            </h4>
            <p style="margin: 5px 0 0; font-size: 11pt;">
                <strong>SUB KEGIATAN (Level 4):</strong> ${subKegiatanDisplay}
            </p>
            <p style="margin: 5px 0 0; font-size: 10pt;">
                Waktu Pelaksanaan: ${rab.waktuPelaksanaan}
            </p>
            <hr style="border: 0; border-top: 1px dashed #ccc; margin: 10px 0;">
            <p style="margin: 0; font-size: 11pt;"> <strong>TOTAL ANGGARAN KEGIATAN: <span style="float: right;">${formatRupiah(totalAnggaran, true)}</span></strong>
            </p>
        </div>
        
        <table class="data-table" style="font-size: 9pt;"> <thead>
                <tr>
                    <th style="width: 3%;">NO</th>
                    <th style="width: 35%;">KODE REKENING (Level 5) / URAIAN BELANJA (Level 6)</th>
                    <th style="width: 10%;">SUMBER DANA</th>
                    <th style="width: 10%;">VOL & SATUAN</th>
                    <th style="width: 12%;">HARGA SATUAN (Rp)</th>
                    <th style="width: 12%;">JUMLAH (Rp)</th>
                    <th style="width: 10%;">PKA</th>
                    <th style="width: 8%;">LOKASI</th>
                </tr>
            </thead>
            <tbody>
    `;
    
            let totalJumlah = 0;
            let currentLevel5Print = '';
            
            rab.detailBelanja.sort((a, b) => a.kodeAkun.localeCompare(b.kodeAkun));
            
            rab.detailBelanja.forEach((item, index) => {
                const jumlah = (cleanAndParseFloat(item.volume) || 0) * (cleanAndParseFloat(item.hargaSatuan) || 0);
                totalJumlah += jumlah;
                
                const kodeAkunPenuh = item.kodeAkun;
                const uraianRincian = item.uraian;

                if (currentLevel5Print !== kodeAkunPenuh) {
                    const obyekTotal = rab.detailBelanja
                        .filter(d => d.kodeAkun === kodeAkunPenuh)
                        .reduce((sum, d) => sum + (cleanAndParseFloat(d.volume) * cleanAndParseFloat(d.hargaSatuan)), 0);
                        
                    html += `
                        <tr style="background-color: #e0f2f1; font-weight: bold;">
                            <td colspan="8" style="padding: 6px 6px;">OBJEK (LEVEL 5): ${kodeAkunPenuh} ${item.obyekNama} 
                                <span style="float: right;">TOTAL: ${formatRupiah(obyekTotal)}</span>
                            </td>
                        </tr>
                    `;
                    currentLevel5Print = kodeAkunPenuh;
                }
                
                const pkaDisplay = isPrintingMode ? 
                    `${item.namaPKA || 'N/A'} <br> <span style="font-size:8pt; font-style:italic;">(${item.pka})</span>` :
                    `${item.namaPKA || 'N/A'} (${item.pka})`;

                row.innerHTML = `
                    <tr>
                        <td style="text-align:center;">${index + 1}</td>
                        <td>
                            <strong style="color: #00796b; display: block;">${uraianRincian}</strong> 
                        </td>
                        <td>${item.sumberDana}</td>
                        <td>${item.volume} ${item.satuan}</td>
                        <td style="text-align:right;">${item.hargaSatuan}</td>
                        <td style="text-align:right;">${formatRupiah(jumlah, true)}</td>
                        <td>${pkaDisplay}</td>
                        <td>${item.ket}</td>
                        ${isPrintingMode ? '' : `<td class="rab-actions">
                            <button onclick="editDetailBelanja(${index})">âœï¸</button>
                            <button onclick="hapusDetailBelanja(${index})">ğŸ—‘ï¸</button>
                        </td>`}
                    </tr>
                `;
            });
        html += `
            <tr style="background-color: #c8e6c9; font-weight: bold;">
                <td colspan="5" style="padding: 10px; text-align: right;">TOTAL JUMLAH BELANJA</td>
                <td style="padding: 10px; text-align: right;">${formatRupiah(totalJumlah, true)}</td>
                <td colspan="2"></td>
            </tr>
        </tbody>
        </table>
    `;
    return html;
}


function generateRABKeseluruhanHTML() {
    const filteredRAB = rabData.filter(rab => parseInt(rab.rabTahun) === currentFilterYear);
    if (filteredRAB.length === 0) {
        return `<p style="color:red; text-align:center; font-weight:bold;">Tidak ada data RAB untuk Tahun Anggaran ${currentFilterYear}.</p>`;
    }

    const groupedRAB = filteredRAB.reduce((acc, rab) => {
        const key = rab.bidangKode;
        if (!acc[key]) {
            acc[key] = { nama: rab.bidangNama, kode: rab.bidangKode, items: [] };
        }
        acc[key].items.push(rab);
        return acc;
    }, {});

    let html = '';
    let grandTotal = 0;
    const sortedBidangKeys = Object.keys(groupedRAB).sort((a, b) => parseInt(a) - parseInt(b));

    for (const kodeBidang of sortedBidangKeys) {
        const bidangGroup = groupedRAB[kodeBidang];
        let totalBidang = 0;

        html += `
            <h4 style="margin-top: 25px; margin-bottom: 5px; color: #004d40; font-size: 13pt;">
                I. BIDANG: ${bidangGroup.kode} ${bidangGroup.nama}
            </h4>
        `;

        bidangGroup.items.sort((a, b) => {
            const codeA = a.subBidangKode + a.kegiatanKode;
            const codeB = b.subBidangKode + b.kegiatanKode;
            return codeA.localeCompare(codeB);
        });

        bidangGroup.items.forEach((rab, rabIndex) => {
            const totalAnggaranKegiatan = calculateRABTotal(rab);
            totalBidang += totalAnggaranKegiatan;
            grandTotal += totalAnggaranKegiatan;
            
            const subKegiatanDisplay = rab.subKegiatanNama || 'Belum Diisi';

            html += `
                <div style="page-break-inside: avoid; margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                    <strong style="display: block; margin-bottom: 8px; color: #00796b; font-size: 11pt;">
                        KEGIATAN (Level 3): ${rab.kegiatanKode} ${rab.kegiatanNama}
                    </strong>
                    <p style="margin: 0; font-size: 10pt;">
                        Sub Bidang: ${rab.subBidangKode} ${rab.subBidangNama} | 
                        Jenis APBDes: ${rab.jenisApbdes} | 
                        Waktu Pelaksanaan: ${rab.waktuPelaksanaan}
                    </p>
                    <p style="margin: 0; font-size: 10pt;">
                        SUB KEGIATAN (Level 4): ${subKegiatanDisplay}
                    </p>
            `;

            html += `
                <table class="data-table" style="margin-top: 10px; font-size: 9pt;">
                    <thead>
                        <tr>
                            <th style="width: 3%;">NO</th>
                            <th style="width: 38%;">KODE REKENING (Level 5) / URAIAN BELANJA (Level 6)</th>
                            <th style="width: 10%;">SUMBER DANA</th>
                            <th style="width: 10%;">VOL & SATUAN</th>
                            <th style="width: 12%;">HARGA SATUAN (Rp)</th>
                            <th style="width: 12%;">JUMLAH (Rp)</th>
                            <th style="width: 10%;">PKA</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (rab.detailBelanja && rab.detailBelanja.length > 0) {
                rab.detailBelanja.sort((a, b) => a.kodeAkun.localeCompare(b.kodeAkun));
                
                let currentLevel5Print = '';

                rab.detailBelanja.forEach((item, detailIndex) => {
                    const jumlah = (cleanAndParseFloat(item.volume) || 0) * (cleanAndParseFloat(item.hargaSatuan) || 0);
                    
                    const kodeAkunPenuh = item.kodeAkun;
                    const uraianRincian = item.uraian;
                    
                    if (currentLevel5Print !== kodeAkunPenuh) {
                         const obyekTotal = rab.detailBelanja
                            .filter(d => d.kodeAkun === kodeAkunPenuh)
                            .reduce((sum, d) => sum + (cleanAndParseFloat(d.volume) * cleanAndParseFloat(d.hargaSatuan)), 0);
                            
                         html += `
                             <tr style="background-color: #f5f5f5; font-weight: bold;">
                                 <td colspan="7" style="padding: 4px 6px; font-size: 9pt;">OBJEK (LEVEL 5): ${kodeAkunPenuh} ${item.obyekNama} 
                                     <span style="float: right;">TOTAL: ${formatRupiah(obyekTotal)}</span>
                                 </td>
                             </tr>
                         `;
                         currentLevel5Print = kodeAkunPenuh;
                     }


                    html += `
                        <tr>
                            <td style="text-align:center;">${detailIndex + 1}</td>
                            <td>
                                <strong style="color: #00796b; display: block;">${uraianRincian}</strong> 
                            </td>
                            <td>${item.sumberDana}</td>
                            <td style="text-align:right;">${item.volume} ${item.satuan}</td>
                            <td style="text-align:right;">${item.hargaSatuan}</td>
                            <td style="text-align:right;">${formatRupiah(jumlah, true)}</td>
                            <td>${item.namaPKA} <br> <span style="font-size:8pt; font-style:italic;">(${item.pka})</span></td>
                        </tr>
                    `;
                });
            } else {
                 html += `<tr><td colspan="7" style="text-align:center; color:gray;">(Tidak ada Detil Belanja)</td></tr>`;
            }

            html += `
                    <tr style="background-color: #f0fdf9; font-weight: bold;">
                        <td colspan="5" style="text-align: right; padding: 5px;">TOTAL KEGIATAN INI</td>
                        <td style="text-align: right; padding: 5px;">${formatRupiah(totalAnggaranKegiatan, true)}</td>
                        <td></td>
                    </tr>
                </tbody>
                </table>
            </div>
        `;
    });
        
        html += `
      <div style="border-top: 3px double #004d40; border-bottom: 3px double #004d40; margin: 10px 0 20px 0; padding: 5px 0; page-break-inside: avoid;">
   <strong style="display: flex; justify-content: space-between; font-size: 11pt; color: #004d40;">
                    <span>TOTAL ANGGARAN BIDANG ${bidangGroup.kode}</span>
                    <span style="border-bottom: 1px solid #004d40; padding-bottom: 2px;">${formatRupiah(totalBidang, true)}</span>
                </strong>
            </div>
        `;
    }

    html += `
        <div style="margin-top: 30px; border: 2px solid #00796b; padding: 10px; background-color: #e0f2f1; page-break-before: always; page-break-inside: avoid;">
            <strong style="display: flex; justify-content: space-between; font-size: 14pt; color: #00796b;">
                <span>GRAND TOTAL ANGGARAN SELURUH KEGIATAN</span>
                <span>${formatRupiah(grandTotal, true)}</span>
            </strong>
        </div>
    `;

    return html;
}

function tampilkanFormCetakRABPerBidang() { 
    if (!checkAuthentication()) return;
    
    const filteredRAB = rabData.filter(rab => parseInt(rab.rabTahun) === currentFilterYear);
    const select = document.getElementById('selectBidangCetakRAB');

    select.innerHTML = '<option value="">-- Pilih Bidang --</option>';
    
    const uniqueBidang = [...new Set(filteredRAB.map(item => 
        JSON.stringify({ kode: item.bidangKode, nama: item.bidangNama })
    ))].map(item => JSON.parse(item));
    
    if(uniqueBidang.length === 0) {
        alert('Tidak ada data RAB untuk tahun ini.');
        return;
    }
    
    uniqueBidang.sort((a, b) => a.kode.localeCompare(b.kode));
    
    uniqueBidang.forEach(bidang => {
        const option = document.createElement('option');
        option.value = bidang.kode;
        option.textContent = `${bidang.kode} ${bidang.nama}`;
        select.appendChild(option);
    });
    
    document.getElementById('formCetakRABPerBidangModal').style.display = 'flex';
}
function prosesCetakRABPerBidang() { 
    if (!checkAuthentication()) return;
    
    const kodeBidang = document.getElementById('selectBidangCetakRAB').value;
    if (!kodeBidang) {
        alert('Silakan pilih bidang terlebih dahulu.');
        return;
    }

    const activeModule = document.querySelector('.module-content.active');
    const lastActiveModuleId = activeModule ? activeModule.id : 'Dashboard';
    if (activeModule) activeModule.classList.remove('active');
    document.getElementById('RABKegiatanModule').classList.add('active'); 
    
    isPrintingMode = true; 
    
    renderRABKegiatan(); 
    
    const moduleTitle = `Rencana Anggaran Biaya (RAB) Per Bidang`;
    const contentHtml = generateRABPerBidangHTML(kodeBidang);

    if (!contentHtml || contentHtml.includes('Tidak ada data RAB')) {
         alert('Tidak ada data kegiatan untuk bidang ini.');
         document.getElementById('RABKegiatanModule').classList.remove('active');
         if (activeModule) activeModule.classList.add('active');
         
         isPrintingMode = false;
         
         renderModuleData(lastActiveModuleId);
         return;
    }

    const finalPrintHTML = generatePrintContentHTML(
        'RABPerBidang', 
        moduleTitle, 
        contentHtml
    );

    const printWindow = window.open('', '_blank');
    printWindow.document.write(finalPrintHTML);
    printWindow.document.close();
    printWindow.focus();
    
    setTimeout(() => { 
        printWindow.print(); 
    }, 500); 
    
    document.getElementById('formCetakRABPerBidangModal').style.display = 'none';

    document.getElementById('RABKegiatanModule').classList.remove('active');
    if (activeModule) activeModule.classList.add('active');
    
    isPrintingMode = false;
    
    renderModuleData(lastActiveModuleId);
}


function generateRABPerBidangHTML(kodeBidang) {
    const filteredRAB = rabData.filter(rab => 
        parseInt(rab.rabTahun) === currentFilterYear && 
        rab.bidangKode === kodeBidang
    );
    
    if (filteredRAB.length === 0) {
        return `<p style="color:red; text-align:center; font-weight:bold;">Tidak ada data RAB untuk Bidang ${kodeBidang} (Tahun ${currentFilterYear}).</p>`;
    }

    const bidangGroup = {
        nama: filteredRAB[0].bidangNama,
        kode: filteredRAB[0].bidangKode,
        items: filteredRAB
    };

    let html = '';
    let grandTotal = 0;

    html += `
        <h4 style="margin-top: 5px; margin-bottom: 5px; color: #004d40; font-size: 13pt;">
            BIDANG: ${bidangGroup.kode} ${bidangGroup.nama}
        </h4>
    `;

    bidangGroup.items.sort((a, b) => {
        const codeA = a.subBidangKode + a.kegiatanKode;
        const codeB = b.subBidangKode + b.kegiatanKode;
        return codeA.localeCompare(codeB);
    });

    bidangGroup.items.forEach((rab, rabIndex) => {
        const totalAnggaranKegiatan = calculateRABTotal(rab);
        grandTotal += totalAnggaranKegiatan;
        
        const subKegiatanDisplay = rab.subKegiatanNama || 'Belum Diisi';

        html += `
            <div style="page-break-inside: avoid; margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                <strong style="display: block; margin-bottom: 8px; color: #00796b; font-size: 11pt;">
                    KEGIATAN (Level 3): ${rab.kegiatanKode} ${rab.kegiatanNama}
                </strong>
                <p style="margin: 0; font-size: 9pt;">
                    Sub Bidang: ${rab.subBidangKode} ${rab.subBidangNama} | 
                    Jenis APBDes: ${rab.jenisApbdes} | 
                    Waktu Pelaksanaan: ${rab.waktuPelaksanaan}
                </p>
                 <p style="margin: 0; font-size: 9pt;">
                    SUB KEGIATAN (Level 4): ${subKegiatanDisplay}
                </p>
        `;

        html += `
            <table class="data-table" style="margin-top: 10px; font-size: 9pt;">
                <thead>
                    <tr>
                        <th style="width: 3%;">NO</th>
                        <th style="width: 38%;">KODE REKENING (Level 5) / URAIAN BELANJA (Level 6)</th>
                        <th style="width: 10%;">SUMBER DANA</th>
                        <th style="width: 10%;">VOL & SATUAN</th>
                        <th style="width: 12%;">HARGA SATUAN (Rp)</th>
                        <th style="width: 12%;">JUMLAH (Rp)</th>
                        <th style="width: 10%;">PKA</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        if (rab.detailBelanja && rab.detailBelanja.length > 0) {
            rab.detailBelanja.sort((a, b) => a.kodeAkun.localeCompare(b.kodeAkun));
            
            let currentLevel5Print = '';
            
            rab.detailBelanja.forEach((item, detailIndex) => {
                const jumlah = (cleanAndParseFloat(item.volume) || 0) * (cleanAndParseFloat(item.hargaSatuan) || 0);
                
                const kodeAkunPenuh = item.kodeAkun;
                const uraianRincian = item.uraian;
                
                if (currentLevel5Print !== kodeAkunPenuh) {
                     const obyekTotal = rab.detailBelanja
                        .filter(d => d.kodeAkun === kodeAkunPenuh)
                        .reduce((sum, d) => sum + (cleanAndParseFloat(d.volume) * cleanAndParseFloat(d.hargaSatuan)), 0);
                        
                     html += `
                         <tr style="background-color: #f5f5f5; font-weight: bold;">
                             <td colspan="7" style="padding: 4px 6px; font-size: 9pt;">OBJEK (LEVEL 5): ${kodeAkunPenuh} ${item.obyekNama} 
                                 <span style="float: right;">TOTAL: ${formatRupiah(obyekTotal)}</span>
                             </td>
                         </tr>
                     `;
                     currentLevel5Print = kodeAkunPenuh;
                 }


                html += `
                    <tr>
                        <td style="text-align:center;">${detailIndex + 1}</td>
                        <td>
                            <strong style="color: #00796b; display: block;">${uraianRincian}</strong> 
                        </td>
                        <td>${item.sumberDana}</td>
                        <td style="text-align:right;">${item.volume} ${item.satuan}</td>
                        <td style="text-align:right;">${item.hargaSatuan}</td>
                        <td style="text-align:right;">${formatRupiah(jumlah, true)}</td>
                        <td>${item.namaPKA} <br> <span style="font-size:8pt; font-style:italic;">(${item.pka})</span></td>
                    </tr>
                `;
            });
        } else {
             html += `<tr><td colspan="7" style="text-align:center; color:gray;">(Tidak ada Detil Belanja)</td></tr>`;
        }

        html += `
                <tr style="background-color: #f0fdf9; font-weight: bold;">
                    <td colspan="5" style="text-align: right; padding: 5px;">TOTAL KEGIATAN INI</td>
                    <td style="text-align: right; padding: 5px;">${formatRupiah(totalAnggaranKegiatan, true)}</td>
                    <td></td>
                </tr>
            </tbody>
            </table>
        </div>
        `;
    });
    
    html += `
        <div style="margin-top: 30px; border: 2px solid #00796b; padding: 10px; background-color: #e0f2f1; page-break-inside: avoid;">
            <strong style="display: flex; justify-content: space-between; font-size: 14pt; color: #00796b;">
                <span>GRAND TOTAL ANGGARAN BIDANG INI</span>
                <span>${formatRupiah(grandTotal, true)}</span>
            </strong>
        </div>
    `;

    return html;
}

function tampilkanFormCetakRABPerBidang() { 
    if (!checkAuthentication()) return;
    
    const filteredRAB = rabData.filter(rab => parseInt(rab.rabTahun) === currentFilterYear);
    const select = document.getElementById('selectBidangCetakRAB');

    select.innerHTML = '<option value="">-- Pilih Bidang --</option>';
    
    const uniqueBidang = [...new Set(filteredRAB.map(item => 
        JSON.stringify({ kode: item.bidangKode, nama: item.bidangNama })
    ))].map(item => JSON.parse(item));
    
    if(uniqueBidang.length === 0) {
        alert('Tidak ada data RAB untuk tahun ini.');
        return;
    }
    
    uniqueBidang.sort((a, b) => a.kode.localeCompare(b.kode));
    
    uniqueBidang.forEach(bidang => {
        const option = document.createElement('option');
        option.value = bidang.kode;
        option.textContent = `${bidang.kode} ${bidang.nama}`;
        select.appendChild(option);
    });
    
    document.getElementById('formCetakRABPerBidangModal').style.display = 'flex';
}
function prosesCetakRABPerBidang() { 
    if (!checkAuthentication()) return;
    
    const kodeBidang = document.getElementById('selectBidangCetakRAB').value;
    if (!kodeBidang) {
        alert('Silakan pilih bidang terlebih dahulu.');
        return;
    }

    const activeModule = document.querySelector('.module-content.active');
    const lastActiveModuleId = activeModule ? activeModule.id : 'Dashboard';
    if (activeModule) activeModule.classList.remove('active');
    document.getElementById('RABKegiatanModule').classList.add('active'); 
    
    isPrintingMode = true; 
    
    renderRABKegiatan(); 
    
    const moduleTitle = `Rencana Anggaran Biaya (RAB) Per Bidang`;
    const contentHtml = generateRABPerBidangHTML(kodeBidang);

    if (!contentHtml || contentHtml.includes('Tidak ada data RAB')) {
         alert('Tidak ada data kegiatan untuk bidang ini.');
         document.getElementById('RABKegiatanModule').classList.remove('active');
         if (activeModule) activeModule.classList.add('active');
         
         isPrintingMode = false;
         
         renderModuleData(lastActiveModuleId);
         return;
    }

    const finalPrintHTML = generatePrintContentHTML(
        'RABPerBidang', 
        moduleTitle, 
        contentHtml
    );

    const printWindow = window.open('', '_blank');
    printWindow.document.write(finalPrintHTML);
    printWindow.document.close();
    printWindow.focus();
    
    setTimeout(() => { 
        printWindow.print(); 
    }, 500); 
    
    document.getElementById('formCetakRABPerBidangModal').style.display = 'none';

    document.getElementById('RABKegiatanModule').classList.remove('active');
    if (activeModule) activeModule.classList.add('active');
    
    isPrintingMode = false;
    
    renderModuleData(lastActiveModuleId);
}


function generateRABPerBidangHTML(kodeBidang) {
    const filteredRAB = rabData.filter(rab => 
        parseInt(rab.rabTahun) === currentFilterYear && 
        rab.bidangKode === kodeBidang
    );
    
    if (filteredRAB.length === 0) {
        return `<p style="color:red; text-align:center; font-weight:bold;">Tidak ada data RAB untuk Bidang ${kodeBidang} (Tahun ${currentFilterYear}).</p>`;
    }

    const bidangGroup = {
        nama: filteredRAB[0].bidangNama,
        kode: filteredRAB[0].bidangKode,
        items: filteredRAB
    };

    let html = '';
    let grandTotal = 0;

    html += `
        <h4 style="margin-top: 5px; margin-bottom: 5px; color: #004d40; font-size: 13pt;">
            BIDANG: ${bidangGroup.kode} ${bidangGroup.nama}
        </h4>
    `;

    bidangGroup.items.sort((a, b) => {
        const codeA = a.subBidangKode + a.kegiatanKode;
        const codeB = b.subBidangKode + b.kegiatanKode;
        return codeA.localeCompare(codeB);
    });

    bidangGroup.items.forEach((rab, rabIndex) => {
        const totalAnggaranKegiatan = calculateRABTotal(rab);
        grandTotal += totalAnggaranKegiatan;
        
        const subKegiatanDisplay = rab.subKegiatanNama || 'Belum Diisi';

        html += `
            <div style="page-break-inside: avoid; margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                <strong style="display: block; margin-bottom: 8px; color: #00796b; font-size: 11pt;">
                    KEGIATAN (Level 3): ${rab.kegiatanKode} ${rab.kegiatanNama}
                </strong>
                <p style="margin: 0; font-size: 9pt;">
                    Sub Bidang: ${rab.subBidangKode} ${rab.subBidangNama} | 
                    Jenis APBDes: ${rab.jenisApbdes} | 
                    Waktu Pelaksanaan: ${rab.waktuPelaksanaan}
                </p>
                 <p style="margin: 0; font-size: 9pt;">
                    SUB KEGIATAN (Level 4): ${subKegiatanDisplay}
                </p>
        `;

        html += `
            <table class="data-table" style="margin-top: 10px; font-size: 9pt;">
                <thead>
                    <tr>
                        <th style="width: 3%;">NO</th>
                        <th style="width: 38%;">KODE REKENING (Level 5) / URAIAN BELANJA (Level 6)</th>
                        <th style="width: 10%;">SUMBER DANA</th>
                        <th style="width: 10%;">VOL & SATUAN</th>
                        <th style="width: 12%;">HARGA SATUAN (Rp)</th>
                        <th style="width: 12%;">JUMLAH (Rp)</th>
                        <th style="width: 10%;">PKA</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        if (rab.detailBelanja && rab.detailBelanja.length > 0) {
            rab.detailBelanja.sort((a, b) => a.kodeAkun.localeCompare(b.kodeAkun));
            
            let currentLevel5Print = '';
            
            rab.detailBelanja.forEach((item, detailIndex) => {
                const jumlah = (cleanAndParseFloat(item.volume) || 0) * (cleanAndParseFloat(item.hargaSatuan) || 0);
                
                const kodeAkunPenuh = item.kodeAkun;
                const uraianRincian = item.uraian;
                
                if (currentLevel5Print !== kodeAkunPenuh) {
                     const obyekTotal = rab.detailBelanja
                        .filter(d => d.kodeAkun === kodeAkunPenuh)
                        .reduce((sum, d) => sum + (cleanAndParseFloat(d.volume) * cleanAndParseFloat(d.hargaSatuan)), 0);
                        
                     html += `
                         <tr style="background-color: #f5f5f5; font-weight: bold;">
                             <td colspan="7" style="padding: 4px 6px; font-size: 9pt;">OBJEK (LEVEL 5): ${kodeAkunPenuh} ${item.obyekNama} 
                                 <span style="float: right;">TOTAL: ${formatRupiah(obyekTotal)}</span>
                             </td>
                         </tr>
                     `;
                     currentLevel5Print = kodeAkunPenuh;
                 }


                html += `
                    <tr>
                        <td style="text-align:center;">${detailIndex + 1}</td>
                        <td>
                            <strong style="color: #00796b; display: block;">${uraianRincian}</strong> 
                        </td>
                        <td>${item.sumberDana}</td>
                        <td style="text-align:right;">${item.volume} ${item.satuan}</td>
                        <td style="text-align:right;">${item.hargaSatuan}</td>
                        <td style="text-align:right;">${formatRupiah(jumlah, true)}</td>
                        <td>${item.namaPKA} <br> <span style="font-size:8pt; font-style:italic;">(${item.pka})</span></td>
                    </tr>
                `;
            });
        } else {
             html += `<tr><td colspan="7" style="text-align:center; color:gray;">(Tidak ada Detil Belanja)</td></tr>`;
        }

        html += `
                <tr style="background-color: #f0fdf9; font-weight: bold;">
                    <td colspan="5" style="text-align: right; padding: 5px;">TOTAL KEGIATAN INI</td>
                    <td style="text-align: right; padding: 5px;">${formatRupiah(totalAnggaranKegiatan, true)}</td>
                    <td></td>
                </tr>
            </tbody>
            </table>
        </div>
        `;
    });
    
    html += `
        <div style="margin-top: 30px; border: 2px solid #00796b; padding: 10px; background-color: #e0f2f1; page-break-inside: avoid;">
            <strong style="display: flex; justify-content: space-between; font-size: 14pt; color: #00796b;">
                <span>GRAND TOTAL ANGGARAN BIDANG INI</span>
                <span>${formatRupiah(grandTotal, true)}</span>
            </strong>
        </div>
    `;

    return html;
}

// 4.13 HAPUS SEMUA DATA
function showClearAllDataModal() {
    if (!checkAuthentication()) return;
    if (authenticatedUser.role !== 'admin') {
        alert('Akses ditolak. Hanya Admin yang dapat menghapus semua data.');
        return;
    }
    document.getElementById('clearAllVerificationInput').value = '';
    document.getElementById('confirmClearAllModal').style.display = 'flex';
}

function clearAllData() {
    if (!checkAuthentication()) return;
    if (authenticatedUser.role !== 'admin') {
        alert('Akses ditolak. Hanya Admin.');
        return;
    }

    const verificationInput = document.getElementById('clearAllVerificationInput').value.trim();
    
    if (verificationInput !== 'HAPUS') {
        alert('Verifikasi gagal. Anda harus mengetik kata "HAPUS" (huruf kapital) untuk melanjutkan.');
        document.getElementById('clearAllVerificationInput').focus();
        return;
    }

    if (!confirm('KONFIRMASI TERAKHIR: Semua data akan dihapus permanen. Lanjutkan?')) {
        document.getElementById('confirmClearAllModal').style.display = 'none';
        return;
    }

    localStorage.clear();
    sessionStorage.clear();
    
    rabData = [];
    rkpData = [];
    RealisasiData = [];
    KekayaanData = [];
    HasilData = [];
    customPKAList = [];
    customObyekAccounts = [];
    profilDesaData = {
        visi: 'Visi Desa Default',
        misi: 'Misi Desa Default',
        luasWilayah: '0 Ha',
        jmlPenduduk: 0,
        keterangan: ''
    };
    rpjmDesData = {
        tahunAwal: new Date().getFullYear(),
        tahunAkhir: new Date().getFullYear() + 7,
        nomorDokumen: '',
        visiMisi: '',
        strategi: '',
        detailRencana: []
    };
    authenticatedUser = null;
    currentFilterYear = new Date().getFullYear();
    desaSettings = {
        namaDesa: 'Contoh', namaKecamatan: 'Contoh', namaKabupaten: 'Contoh', namaProvinsi: 'Contoh', 
        tahunAnggaran: String(currentFilterYear), logoDataUrl: '', 
        namaKades: 'Nama Kepala Desa', namaSekdes: 'Nama Sekretaris Desa', namaKaurRen: 'Nama Kaur Perencanaan',
        desaAlamat: 'Jalan Utama', desaKodePos: '12345'
    };

    document.getElementById('confirmClearAllModal').style.display = 'none';
    showSplash("Menghapus semua data dan memuat ulang...");
    
    setTimeout(() => {
        window.location.reload();
    }, 1500); 
}

// =======================================================================
// === NEW: PROFIL DESA & RPJMDes FUNCTIONS (DISISIPKAN DI AKHIR SCRIPT) =
// =======================================================================

function saveProfilDesa() {
    if (!checkAuthentication()) return;

    profilDesaData.visi = document.getElementById('profil_visi').value.trim();
    profilDesaData.misi = document.getElementById('profil_misi').value.trim();
    profilDesaData.luasWilayah = document.getElementById('profil_luas_wilayah').value.trim();
    profilDesaData.jmlPenduduk = parseInt(document.getElementById('profil_jml_penduduk').value) || 0;
    profilDesaData.keterangan = document.getElementById('profil_keterangan').value.trim();
    
    saveData('profilDesaData', profilDesaData);
    renderProfilDesa();
    alert('âœ… Data Profil Desa berhasil disimpan.');
}

function renderProfilDesa() {
    if (!checkAuthentication()) return;

    document.getElementById('profil_visi').value = profilDesaData.visi;
    document.getElementById('profil_misi').value = profilDesaData.misi;
    document.getElementById('profil_luas_wilayah').value = profilDesaData.luasWilayah;
    document.getElementById('profil_jml_penduduk').value = profilDesaData.jmlPenduduk;
    document.getElementById('profil_keterangan').value = profilDesaData.keterangan;

    const outputDiv = document.getElementById('profil_desa_output');
    if (!outputDiv) return;

    const masaBerlaku = rpjmDesData.tahunAkhir - rpjmDesData.tahunAwal + 1;

    outputDiv.innerHTML = `
        <div class="stats-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: 20px;">
            <div class="stat-card" onclick="alert('Data Statis.')" style="background-color: #e0f7fa;">
                <h3>Luas Wilayah</h3>
                <p style="font-size: 1.8em;">${profilDesaData.luasWilayah || 'N/A'}</p>
            </div>
            <div class="stat-card" onclick="alert('Data Statis.')" style="background-color: #fff3e0;">
                <h3>Jumlah Penduduk</h3>
                <p style="font-size: 1.8em;">${formatRupiah(profilDesaData.jmlPenduduk, false)} Jiwa</p>
            </div>
        </div>
        <div style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="color: #004d40; border-bottom: 1px solid #e0f2f1; padding-bottom: 5px;">Visi Desa</h4>
            <p style="white-space: pre-wrap;">${profilDesaData.visi || 'Belum Diisi'}</p>
            <h4 style="color: #004d40; border-bottom: 1px solid #e0f2f1; padding-bottom: 5px; margin-top: 15px;">Misi Desa</h4>
            <p style="white-space: pre-wrap;">${profilDesaData.misi || 'Belum Diisi'}</p>
            <h4 style="color: #004d40; border-bottom: 1px solid #e0f2f1; padding-bottom: 5px; margin-top: 15px;">Keterangan Tambahan</h4>
            <p style="white-space: pre-wrap;">${profilDesaData.keterangan || 'Tidak Ada Keterangan.'}</p>
        </div>
    `;
}

function saveRPJMDes() {
    if (!checkAuthentication()) return;

    const tahunAwal = parseInt(document.getElementById('rpjm_tahun_awal').value);
    const tahunAkhir = parseInt(document.getElementById('rpjm_tahun_akhir').value);
    const nomorDokumen = document.getElementById('rpjm_nomor_dokumen').value.trim();
    const visiMisi = document.getElementById('rpjm_visi_misi').value.trim();
    const strategi = document.getElementById('rpjm_strategi').value.trim();

    if (isNaN(tahunAwal) || isNaN(tahunAkhir) || (tahunAkhir < tahunAwal) || (tahunAkhir - tahunAwal < 5)) {
        alert('Rentang tahun RPJMDes tidak valid. Tahun Akhir harus lebih besar dari Tahun Awal, dengan minimal rentang 6 tahun.');
        return;
    }
    
    rpjmDesData.tahunAwal = tahunAwal;
    rpjmDesData.tahunAkhir = tahunAkhir;
    rpjmDesData.nomorDokumen = nomorDokumen;
    rpjmDesData.visiMisi = visiMisi;
    rpjmDesData.strategi = strategi;

    saveData('rpjmDesData', rpjmDesData);
    renderRPJMDes();
    alert('âœ… Data Umum RPJMDes berhasil disimpan.');
}

function renderRPJMDes() {
    if (!checkAuthentication()) return;

    document.getElementById('rpjm_tahun_awal').value = rpjmDesData.tahunAwal;
    document.getElementById('rpjm_tahun_akhir').value = rpjmDesData.tahunAkhir;
    document.getElementById('rpjm_nomor_dokumen').value = rpjmDesData.nomorDokumen;
    document.getElementById('rpjm_visi_misi').value = rpjmDesData.visiMisi;
    document.getElementById('rpjm_strategi').value = rpjmDesData.strategi;

    const outputDiv = document.getElementById('rpjm_des_output');
    if (!outputDiv) return;

    const masaBerlaku = rpjmDesData.tahunAkhir - rpjmDesData.tahunAwal + 1;

    outputDiv.innerHTML = `
        <div style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4 style="color: #004d40; border-bottom: 1px solid #e0f2f1; padding-bottom: 5px;">Masa Berlaku Dokumen</h4>
            <p style="font-size: 1.2em; font-weight: bold; color: ${masaBerlaku === 8 ? '#00796b' : '#d9534f'};">
                ${rpjmDesData.tahunAwal} s/d ${rpjmDesData.tahunAkhir} (${masaBerlaku} Tahun)
            </p>
            <p>Nomor Dokumen: <strong>${rpjmDesData.nomorDokumen || 'Belum Diisi'}</strong></p>
            
            <h4 style="color: #004d40; border-bottom: 1px solid #e0f2f1; padding-bottom: 5px; margin-top: 15px;">Visi & Misi RPJMDes</h4>
            <p style="white-space: pre-wrap;">${rpjmDesData.visiMisi || 'Belum Diisi'}</p>
            
            <h4 style="color: #004d40; border-bottom: 1px solid #e0f2f1; padding-bottom: 5px; margin-top: 15px;">Strategi Pembangunan Jangka Menengah</h4>
            <p style="white-space: pre-wrap;">${rpjmDesData.strategi || 'Belum Diisi'}</p>
        </div>
    `;
}

// START: FUNGSI-FUNGSI BARU UNTUK DROPDOWN RPJMDes
function populateRpjmBidang() {
    const select = document.getElementById('rpjm_bidang');
    if (!select) return;
    select.innerHTML = '<option value="">-- Pilih Bidang --</option>';
    RAB_PARAMETERS.forEach(bidang => {
        const option = document.createElement('option');
        option.value = bidang.kode;
        option.textContent = `${bidang.kode} ${bidang.nama}`;
        select.appendChild(option);
    });
}
function populateRpjmSubBidang() {
    const bidangKode = document.getElementById('rpjm_bidang').value;
    const selectSub = document.getElementById('rpjm_sub_bidang');
    const selectKeg = document.getElementById('rpjm_kegiatan');
    if (!selectSub || !selectKeg) return;

    selectSub.innerHTML = '<option value="">-- Pilih Sub Bidang --</option>';
    selectKeg.innerHTML = '<option value="">-- Pilih Kegiatan --</option>';
    selectSub.disabled = true;
    selectKeg.disabled = true;

    if (bidangKode) {
        const bidang = RAB_PARAMETERS.find(b => b.kode === bidangKode);
        if (bidang && bidang.subBidang) {
            bidang.subBidang.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.kode;
                option.textContent = `${sub.kode} ${sub.nama}`;
                selectSub.appendChild(option);
            });
            selectSub.disabled = false;
        }
    }
}
function populateRpjmKegiatan() {
    const bidangKode = document.getElementById('rpjm_bidang').value;
    const subBidangKode = document.getElementById('rpjm_sub_bidang').value;
    const selectKeg = document.getElementById('rpjm_kegiatan');
    if (!selectKeg) return;

    selectKeg.innerHTML = '<option value="">-- Pilih Kegiatan --</option>';
    selectKeg.disabled = true;

    if (bidangKode && subBidangKode) {
        const bidang = RAB_PARAMETERS.find(b => b.kode === bidangKode);
        const subBidang = bidang?.subBidang.find(s => s.kode === subBidangKode);
        if (subBidang && subBidang.kegiatan) {
            subBidang.kegiatan.forEach(keg => {
                const option = document.createElement('option');
                option.value = keg.kode;
                option.textContent = `${keg.kode} ${keg.nama}`;
                selectKeg.appendChild(option);
            });
            selectKeg.disabled = false;
        }
    }
}
// END: FUNGSI-FUNGSI BARU

function showRPJMDesDetailModal(index = -1) {
    if (!checkAuthentication()) return;
    const modal = document.getElementById('rpjmDesDetailModal');
    const isEdit = index !== -1;

    document.getElementById('rpjmDesDetailModalTitle').textContent = isEdit ? 'âœï¸ Edit Rencana Kegiatan RPJMDes' : 'â• Tambah Rencana Kegiatan RPJMDes';
    document.getElementById('rpjm_detail_editing_index').value = index;

    // Reset form & Populate Bidang Dropdown
    populateRpjmBidang();
    document.getElementById('rpjm_sub_bidang').innerHTML = '<option value="">-- Pilih Sub Bidang --</option>';
    document.getElementById('rpjm_sub_bidang').disabled = true;
    document.getElementById('rpjm_kegiatan').innerHTML = '<option value="">-- Pilih Kegiatan --</option>';
    document.getElementById('rpjm_kegiatan').disabled = true;
    document.getElementById('rpjm_uraian_kegiatan').value = '';
    
    document.getElementById('rpjm_detail_lokasi').value = '';
    document.getElementById('rpjm_detail_volume').value = '';
    document.getElementById('rpjm_detail_manfaat').value = '';
    document.getElementById('rpjm_detail_jumlah').value = '';
    document.getElementById('rpjm_detail_sumber').value = 'DD';
    
    for (let i = 1; i <= 8; i++) {
        document.getElementById(`rpjm_tahun_${i}`).checked = false;
    }
    document.getElementById('rpjm_pola_swakelola').checked = false;
    document.getElementById('rpjm_pola_antardesa').checked = false;
    document.getElementById('rpjm_pola_pihakketiga').checked = false;

    if (isEdit) {
        const item = rpjmDesData.detailRencana[index];
        
        // Load data dropdown
        document.getElementById('rpjm_bidang').value = item.bidangKode;
        populateRpjmSubBidang();
        setTimeout(() => {
            document.getElementById('rpjm_sub_bidang').value = item.subBidangKode;
            populateRpjmKegiatan();
            setTimeout(() => {
                document.getElementById('rpjm_kegiatan').value = item.kegiatanKode;
            }, 50);
        }, 50);

        document.getElementById('rpjm_uraian_kegiatan').value = item.uraianKegiatan;
        document.getElementById('rpjm_detail_lokasi').value = item.lokasi;
        document.getElementById('rpjm_detail_volume').value = item.volume;
        document.getElementById('rpjm_detail_manfaat').value = item.manfaat;
        document.getElementById('rpjm_detail_jumlah').value = item.jumlah;
        document.getElementById('rpjm_detail_sumber').value = item.sumber;

        item.waktu.forEach(tahun => {
            if (tahun >= 1 && tahun <= 8) {
                document.getElementById(`rpjm_tahun_${tahun}`).checked = true;
            }
        });
        document.getElementById('rpjm_pola_swakelola').checked = item.pola.includes('Swakelola');
        document.getElementById('rpjm_pola_antardesa').checked = item.pola.includes('Kerjasama Antar Desa');
        document.getElementById('rpjm_pola_pihakketiga').checked = item.pola.includes('Kerjasama Pihak Ketiga');
    }

    modal.style.display = 'flex';
}

function saveRPJMDesDetail() {
    if (!checkAuthentication()) return;

    const index = document.getElementById('rpjm_detail_editing_index').value;
    
    const bidangKode = document.getElementById('rpjm_bidang').value;
    const subBidangKode = document.getElementById('rpjm_sub_bidang').value;
    const kegiatanKode = document.getElementById('rpjm_kegiatan').value;
    const uraianKegiatan = document.getElementById('rpjm_uraian_kegiatan').value.trim();
    
    const lokasi = document.getElementById('rpjm_detail_lokasi').value.trim();
    const volume = document.getElementById('rpjm_detail_volume').value.trim();
    const manfaat = document.getElementById('rpjm_detail_manfaat').value.trim();
    const jumlah = document.getElementById('rpjm_detail_jumlah').value.trim();
    const sumber = document.getElementById('rpjm_detail_sumber').value;

    const waktu = [];
    for (let i = 1; i <= 8; i++) {
        if (document.getElementById(`rpjm_tahun_${i}`).checked) {
            waktu.push(i);
        }
    }
    
    const pola = [];
    if (document.getElementById('rpjm_pola_swakelola').checked) pola.push('Swakelola');
    if (document.getElementById('rpjm_pola_antardesa').checked) pola.push('Kerjasama Antar Desa');
    if (document.getElementById('rpjm_pola_pihakketiga').checked) pola.push('Kerjasama Pihak Ketiga');

    if (!bidangKode || !subBidangKode || !kegiatanKode || !uraianKegiatan || !lokasi || !volume || !manfaat || !jumlah || waktu.length === 0 || pola.length === 0) {
        alert("Semua kolom (Bidang, Sub Bidang, Kegiatan, Uraian, Lokasi, Volume, Manfaat, Jumlah, Waktu, dan Pola Pelaksanaan) wajib diisi!");
        return;
    }
    
    const { bidangNama, subBidangNama, kegiatanNama } = getKegiatanDataByCode(bidangKode, subBidangKode, kegiatanKode);
    
    const newDetail = {
        id: index !== "" && index > -1 ? rpjmDesData.detailRencana[index].id : 'rpjm_detail_' + Date.now(),
        bidangKode, bidangNama,
        subBidangKode, subBidangNama,
        kegiatanKode, kegiatanNama,
        uraianKegiatan,
        lokasi, volume, manfaat, waktu, jumlah, sumber, pola
    };

    if (index !== "" && index > -1) {
        rpjmDesData.detailRencana[index] = newDetail;
    } else {
        if (!rpjmDesData.detailRencana) {
            rpjmDesData.detailRencana = [];
        }
        rpjmDesData.detailRencana.push(newDetail);
    }
    
    saveData('rpjmDesData', rpjmDesData); 

    document.getElementById('rpjmDesDetailModal').style.display = 'none';
    renderRPJMDesDetailTable();
    alert('âœ… Rencana Kegiatan RPJMDes berhasil disimpan.');
}

function deleteRPJMDesDetail(index) {
    if (!checkAuthentication()) return;
    if (confirm("Anda yakin ingin menghapus Rencana Kegiatan RPJMDes ini?")) {
        rpjmDesData.detailRencana.splice(index, 1);
        saveData('rpjmDesData', rpjmDesData); 
        renderRPJMDesDetailTable();
        alert("ğŸ—‘ï¸ Rencana Kegiatan RPJMDes berhasil dihapus.");
    }
}

// START: MODIFIKASI FUNGSI renderRPJMDesDetailTable UNTUK KLASIFIKASI BERDASARKAN BIDANG
function renderRPJMDesDetailTable() {
    const data = rpjmDesData.detailRencana || [];
    
    const tableContainer = document.getElementById('rpjm_detail_list_output');
    if (!tableContainer) return;

    // 1. Grouping data by Bidang Kode (Level 1)
    const groupedData = data.reduce((acc, item) => {
        const key = item.bidangKode;
        if (!acc[key]) {
            acc[key] = { nama: item.bidangNama, items: [] };
        }
        acc[key].items.push(item);
        return acc;
    }, {});
    
    // 2. Sorting by Bidang Kode
    const sortedBidangKeys = Object.keys(groupedData).sort((a, b) => a.localeCompare(b));


    let tableHtml = `
        <table class="data-table" style="width: 100%; font-size: 0.8em;">
            <thead>
                <tr>
                    <th rowspan="2" style="vertical-align: middle;">No</th>
                    <th colspan="3">Bidang/Jenis Kegiatan</th>
                    <th rowspan="2" style="vertical-align: middle;">Lokasi</th>
                    <th rowspan="2" style="vertical-align: middle;">Perkiraan Volume</th>
                    <th rowspan="2" style="vertical-align: middle;">Sasaran/Manfaat</th>
                    <th colspan="8">Waktu Pelaksanaan <br> (Tahun)</th>
                    <th colspan="2">Perkiraan Biaya & Sumber</th>
                    <th colspan="3">Perkiraan Pola Pelaksanaan</th>
                    <th rowspan="2" style="vertical-align: middle;">Aksi</th>
                </tr>
                <tr>
                    <th>Bidang</th>
                    <th>Sub Bidang</th>
                    <th>Jenis Kegiatan</th>
                    <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th>
                    <th>Jumlah (Rp)</th>
                    <th>Sumber</th>
                    <th>Swakelola</th>
                    <th>Antar Desa</th>
                    <th>Pihak III</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    const totalCols = 21;
    let overallIndex = 0;

    if (data.length === 0) {
        tableHtml += `<tr><td colspan="${totalCols}" style="padding: 15px; color: #777; text-align: center;">Belum ada Rencana Kegiatan RPJMDes yang diinput.</td></tr>`;
    } else {
        
        sortedBidangKeys.forEach(bidangKode => {
            const bidang = groupedData[bidangKode];
            
            // Header Bidang (Classification)
            tableHtml += `
                 <tr style="background-color: #004d40; color: white; font-weight: bold;">
                     <td colspan="${totalCols}" style="text-align: left; padding: 8px 10px;">
                         BIDANG ${bidangKode} - ${bidang.nama}
                     </td>
                 </tr>
            `;
            
            // Sort items within the Bidang by Sub Bidang Kode
            bidang.items.sort((a, b) => a.subBidangKode.localeCompare(b.subBidangKode));

            bidang.items.forEach((item, index) => {
                overallIndex++;
                const waktuHtml = Array.from({length: 8}, (_, i) => 
                    `<td style="text-align: center;">${item.waktu.includes(i + 1) ? 'âœ…' : ''}</td>`
                ).join('');

                const polaSwakelola = item.pola.includes('Swakelola') ? 'âœ…' : '';
                const polaAntarDesa = item.pola.includes('Kerjasama Antar Desa') ? 'âœ…' : '';
                const polaPihakKetiga = item.pola.includes('Kerjasama Pihak Ketiga') ? 'âœ…' : '';
                
                tableHtml += `
                    <tr>
                        <td style="text-align: center;">${overallIndex}</td>
                        <td>${item.bidangKode} - ${item.bidangNama}</td> 
                        <td>${item.subBidangKode} - ${item.subBidangNama}</td> 
                        <td><strong>${item.kegiatanNama}</strong><br><small>(${item.uraianKegiatan || 'Uraian tidak spesifik'})</small></td>
                        <td>${item.lokasi}</td>
                        <td>${item.volume}</td>
                        <td>${item.manfaat}</td>
                        ${waktuHtml}
                        <td style="text-align: right;">${item.jumlah}</td>
                        <td style="text-align: center;">${item.sumber}</td>
                        <td style="text-align: center;">${polaSwakelola}</td>
                        <td style="text-align: center;">${polaAntarDesa}</td>
                        <td style="text-align: center;">${polaPihakKetiga}</td>
                        <td class="action-buttons">
                            <button class="action-btn edit-btn" onclick="showRPJMDesDetailModal(${data.findIndex(d => d.id === item.id)})">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteRPJMDesDetail(${data.findIndex(d => d.id === item.id)})">Hapus</button>
                        </td>
                    </tr>
                `;
            });
        });
    }

    tableHtml += `
            </tbody>
        </table>
    `;

    tableContainer.innerHTML = tableHtml;
}
// END: MODIFIKASI FUNGSI renderRPJMDesDetailTable


// =======================================================================
// === 5. INITIALIZATION =================================================
// =======================================================================
document.addEventListener('DOMContentLoaded', () => {
    
    // START: PERBAIKAN - Alur inisialisasi untuk mengatasi masalah layar putih
    const initApp = async () => {
        await initializeAuthSystem();
        desaLogoBase64 = desaSettings.logoDataUrl || localStorage.getItem('desaLogoBase64') || '';
        
        showSplash("Menginisialisasi sistem...");
        updateDesaLogoDisplay();
        
        if (parseInt(desaSettings.tahunAnggaran)) {
            currentFilterYear = parseInt(desaSettings.tahunAnggaran);
        } else {
            desaSettings.tahunAnggaran = String(currentFilterYear);
            saveData('desaSettings', desaSettings);
        }

        setTimeout(() => {
            if (checkAuthentication(false)) { // Cek otentikasi tanpa menampilkan alert
                // Jika berhasil, tampilkan aplikasi
                updateFilterYearDisplay();
                restoreLastActiveModule();
                const initialModuleId = document.querySelector('.module-content.active').id;
                renderModuleData(initialModuleId);
                if (initialModuleId === 'RPJMDes') renderRPJMDesDetailTable();
                document.getElementById('app_container').classList.remove('app-hidden');
                hideSplash();
            } else {
                // Jika gagal, tampilkan halaman login
                document.getElementById('login_logo').src = desaLogoBase64 || DEFAULT_SIPDES_LOGO_SVG; 
                document.getElementById('login_logo').style.display = 'block';
                document.getElementById('login_overlay').style.display = 'flex';
                document.getElementById('app_container').classList.add('app-hidden'); // Pastikan app disembunyikan
                hideSplash();
            }
        }, 1000); 
    };
    // END: PERBAIKAN
    
    initApp();
});
window.addEventListener("load", tampilkanWilayah);
</script>

<!-- START: PENCEGAHAN 3 - Nonaktifkan Shortcut Keyboard (JavaScript) -->
<script>
    document.addEventListener('keydown', function(event) {
        if (event.key === 'F12' || 
           ((event.ctrlKey || event.metaKey) && event.shiftKey && (event.key === 'I' || event.key === 'J')) ||
           ((event.ctrlKey || event.metaKey) && (event.key === 'U' || event.key === 'S'))) {
            event.preventDefault();
        }
    });
</script>
<!-- END: PENCEGAHAN 3 -->

</body>
</html>
